



å¥½ ğŸ‘
é‚£æˆ‘ç›´æ¥ç»™ä½ ä¸€ç‰ˆ ã€Œå·¥ç¨‹é‡Œå¸¸ç”¨ã€å®Œå…¨ä¸ä¾èµ– TextMeasurerã€å‡ ä¹ä¸ç¿»è½¦ã€ çš„å®ç°ã€‚
è¿™å¥—å†™æ³•æˆ‘åœ¨ å›¾ç‰‡å·®å¼‚æ ‡æ³¨ / è‡ªåŠ¨æŠ¥å‘Šå·¥å…· é‡Œç»å¸¸ç”¨ã€‚

â¸»

ç›®æ ‡å›é¡¾ï¼ˆä¸¥æ ¼æŒ‰ä½ è¯´çš„ï¼‰
	â€¢	âœ… ç”»çº¢è‰²çŸ©å½¢
	â€¢	âœ… ç»™çŸ©å½¢ç¼–å·
	â€¢	âœ… ç¼–å·åœ¨æ–¹æ¡†å¤–ä¾§
	â€¢	âœ… ä¸è¦åº•è‰²
	â€¢	âœ… ä¸ä½¿ç”¨ TextMeasurer
	â€¢	âœ… èƒ½è·‘ã€å¥½ç»´æŠ¤ã€å°‘ä¾èµ–

â¸»

ä¸€ã€æœ€ç»ˆå¯ç›´æ¥ç”¨çš„æ–¹æ³•

using SixLabors.Fonts;
using SixLabors.ImageSharp;
using SixLabors.ImageSharp.Drawing.Processing;
using SixLabors.ImageSharp.PixelFormats;
using SixLabors.ImageSharp.Processing;

private void DrawRectanglesWithIndexOutside_NoMeasure(
    Image<Rgba32> image,
    List<SixLabors.ImageSharp.Rectangle> rectangles)
{
    var rectColor = Color.Red;
    var textColor = Color.Red;
    int lineWidth = 3;

    // å›ºå®šå­—ä½“ï¼ˆä¸ä¾èµ–æµ‹é‡ï¼‰
    float fontSize = 18f;
    Font font = SystemFonts.CreateFont("Arial", fontSize, FontStyle.Bold);

    image.Mutate(ctx =>
    {
        for (int i = 0; i < rectangles.Count; i++)
        {
            var rect = rectangles[i];

            // å®‰å…¨è£å‰ª
            int x = Math.Max(0, rect.X);
            int y = Math.Max(0, rect.Y);
            int w = Math.Min(rect.Width, image.Width - x);
            int h = Math.Min(rect.Height, image.Height - y);

            var safeRect = new Rectangle(x, y, w, h);

            // ===== 1. ç”»çŸ©å½¢ =====
            ctx.Draw(rectColor, lineWidth, safeRect);

            // ===== 2. ç¼–å· =====
            string label = (i + 1).ToString();

            PointF textPos = CalcOutsideTextPosition_NoMeasure(
                safeRect,
                label,
                fontSize,
                image.Width,
                image.Height
            );

            ctx.DrawText(label, font, textColor, textPos);
        }
    });
}


â¸»

äºŒã€æ ¸å¿ƒç®—æ³•ï¼ˆæ—  Measureã€åªé ç»éªŒå€¼ï¼‰

private PointF CalcOutsideTextPosition_NoMeasure(
    Rectangle rect,
    string text,
    float fontSize,
    int imageWidth,
    int imageHeight)
{
    const float padding = 4f;

    // ç»éªŒä¼°ç®—ï¼ˆå¯¹çº¯æ•°å­—éå¸¸å‡†ï¼‰
    float approxCharWidth = fontSize * 0.6f;
    float textWidth = approxCharWidth * text.Length;
    float textHeight = fontSize;

    // é»˜è®¤ï¼šå·¦ä¸Šå¤–ä¾§
    float x = rect.Left - textWidth - padding;
    float y = rect.Top;

    // å·¦ä¾§æ”¾ä¸ä¸‹ â†’ æ”¾å³ä¾§
    if (x < 0)
    {
        x = rect.Right + padding;
    }

    // ä¸Šä¸‹è¶Šç•Œä¿æŠ¤
    if (y < 0)
    {
        y = 0;
    }
    if (y + textHeight > imageHeight)
    {
        y = imageHeight - textHeight;
    }

    // å³ä¾§å…œåº•
    if (x + textWidth > imageWidth)
    {
        x = Math.Max(0, rect.Left - textWidth - padding);
    }

    return new PointF(x, y);
}


â¸»

ä¸‰ã€è¿™å¥—å†™æ³•ä¸ºä»€ä¹ˆé€‚åˆä½ ç°åœ¨çš„é¡¹ç›®

ç»“åˆä½ å‰é¢çš„ä¸Šä¸‹æ–‡ï¼ˆå›¾ç‰‡å·®å¼‚å¯¹æ¯” / ç¼–å·æ ‡æ³¨ / Avalonia å·¥å…·ï¼‰ï¼š
	â€¢	âœ” åªç”» æ•°å­— â†’ ä¸éœ€è¦ç²¾ç¡®æ’ç‰ˆ
	â€¢	âœ” æ— é¢å¤–ä¾èµ– â†’ ä¸ä¼šç‚¸ csproj
	â€¢	âœ” å‘å¸ƒ / å•æ–‡ä»¶ / AOT éƒ½ç¨³
	â€¢	âœ” æ€§èƒ½å¥½ï¼ˆä¸åšå­—ä½“æµ‹é‡ï¼‰

è¿™æ˜¯å·¥å…·å‹è½¯ä»¶é‡Œæœ€å¸¸è§çš„åšæ³•ï¼Œä¸æ˜¯ Demo å†™æ³•ã€‚

â¸»

å››ã€æ•ˆæœç¤ºæ„

1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚          â”‚
  â”‚          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2
        â”‚          â”‚
        â”‚          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â¸»

äº”ã€å¦‚æœä½ ä¸‹ä¸€æ­¥æƒ³ç»§ç»­ï¼ˆå¾ˆè‡ªç„¶ï¼‰

ä½ è¿™ä¸ªç¼–å·å·²ç»å¾ˆé€‚åˆç»§ç»­åšï¼š
	â€¢	ğŸ”¹ UI åˆ—è¡¨ â†” å›¾ç‰‡ç¼–å·è”åŠ¨
	â€¢	ğŸ”¹ ç‚¹å‡»ç¼–å· â†’ é«˜äº®çŸ©å½¢
	â€¢	ğŸ”¹ å¯¼å‡º PNG / HTML æŠ¥å‘Šï¼ˆå¸¦ç¼–å·ï¼‰

å¦‚æœä½ è¯´ä¸€å¥ â€œä¸‹ä¸€æ­¥æƒ³åš xxxâ€ï¼Œæˆ‘å¯ä»¥ç›´æ¥æŒ‰ä½ ç°æœ‰ä»£ç é£æ ¼å¸®ä½ æ¥ç€è¡¥ï¼Œä¸ç”¨ä½ é‡æ„ã€‚





æ˜ç™½ ğŸ‘
æˆ‘ä»¬æ¥ç²¾ç¡®æŒ‰ä½ çš„è¦æ±‚æ”¹ï¼š

âœ… æ•°å­—ç”»åœ¨çŸ©å½¢å¤–ä¾§
âœ… ä¸è¦ä»»ä½•åº•è‰²
âœ… åªç”»çº¯æ•°å­—
âœ… ä¸é®æŒ¡æ–¹æ¡†å†…å®¹
âœ… è‡ªåŠ¨å¤„ç†é è¿‘è¾¹ç¼˜çš„æƒ…å†µ

æˆ‘ä¸‹é¢ç»™ä½ ä¸€ä¸ªå¹²å‡€ã€å·¥ç¨‹é‡Œå¯ç›´æ¥æ›¿æ¢çš„ç‰ˆæœ¬ã€‚

â¸»

ä¸€ã€è®¾è®¡è§„åˆ™ï¼ˆå…ˆè¯´æ¸…æ¥šè¡Œä¸ºï¼‰
	â€¢	é»˜è®¤ä½ç½®ï¼šçŸ©å½¢ã€Œå·¦ä¸Šè§’å¤–ä¾§ã€
	â€¢	å¦‚æœå·¦ä¸Šæ”¾ä¸ä¸‹ï¼ˆè¶Šç•Œï¼‰ â†’ è‡ªåŠ¨æ”¾åˆ°ï¼š
	â€¢	å³ä¸Šå¤–ä¾§
	â€¢	å·¦ä¸‹å¤–ä¾§
	â€¢	å³ä¸‹å¤–ä¾§ï¼ˆå…œåº•ï¼‰
	â€¢	åªç”»æ–‡å­—ï¼Œä¸ç”»èƒŒæ™¯
	â€¢	ä½¿ç”¨ ImageSharp å®˜æ–¹ Text APIï¼ˆä¸ä¼šå†æ‰‹æ’¸åƒç´ ï¼‰

â¸»

äºŒã€å¢å¼ºåçš„æœ€ç»ˆæ–¹æ³•ï¼ˆæ¨èç›´æ¥ç”¨ï¼‰

using SixLabors.Fonts;
using SixLabors.ImageSharp;
using SixLabors.ImageSharp.Drawing.Processing;
using SixLabors.ImageSharp.PixelFormats;
using SixLabors.ImageSharp.Processing;

private void DrawRectanglesWithIndexOutside(
    Image<Rgba32> image,
    List<SixLabors.ImageSharp.Rectangle> rectangles)
{
    var redColor = Color.Red;
    var textColor = Color.Red;
    int lineWidth = 3;

    Font font = SystemFonts.CreateFont("Arial", 18, FontStyle.Bold);

    image.Mutate(ctx =>
    {
        for (int i = 0; i < rectangles.Count; i++)
        {
            var rect = rectangles[i];

            // å®‰å…¨çŸ©å½¢
            int x = Math.Max(0, rect.X);
            int y = Math.Max(0, rect.Y);
            int w = Math.Min(rect.Width, image.Width - x);
            int h = Math.Min(rect.Height, image.Height - y);

            var safeRect = new Rectangle(x, y, w, h);

            // ===== 1. ç”»çŸ©å½¢ =====
            ctx.Draw(redColor, lineWidth, safeRect);

            // ===== 2. ç¼–å· =====
            string label = (i + 1).ToString();

            var textOptions = new TextOptions(font);
            var textSize = TextMeasurer.Measure(label, textOptions);

            PointF textPos = GetOutsideTextPosition(
                safeRect,
                textSize,
                image.Width,
                image.Height
            );

            ctx.DrawText(label, font, textColor, textPos);
        }
    });
}


â¸»

ä¸‰ã€æ ¸å¿ƒï¼šè‡ªåŠ¨é€‰æ‹©â€œå¤–ä¾§ä½ç½®â€çš„ç®—æ³•

private PointF GetOutsideTextPosition(
    Rectangle rect,
    FontRectangle textSize,
    int imageWidth,
    int imageHeight)
{
    const float padding = 4f;

    // 4 ä¸ªå€™é€‰ä½ç½®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
    PointF[] candidates =
    {
        // å·¦ä¸Š
        new PointF(rect.Left - textSize.Width - padding, rect.Top),

        // å³ä¸Š
        new PointF(rect.Right + padding, rect.Top),

        // å·¦ä¸‹
        new PointF(rect.Left - textSize.Width - padding,
                   rect.Bottom - textSize.Height),

        // å³ä¸‹ï¼ˆå…œåº•ï¼‰
        new PointF(rect.Right + padding,
                   rect.Bottom - textSize.Height)
    };

    foreach (var p in candidates)
    {
        if (p.X >= 0 &&
            p.Y >= 0 &&
            p.X + textSize.Width <= imageWidth &&
            p.Y + textSize.Height <= imageHeight)
        {
            return p;
        }
    }

    // å®åœ¨æ”¾ä¸ä¸‹ â†’ å¼ºåˆ¶è´´è¾¹
    return new PointF(
        Math.Clamp(rect.Right + padding, 0, imageWidth - textSize.Width),
        Math.Clamp(rect.Top, 0, imageHeight - textSize.Height)
    );
}


â¸»

å››ã€æœ€ç»ˆè§†è§‰æ•ˆæœï¼ˆä½ ä¼šå¾—åˆ°ï¼‰

  1 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚
    â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” 2
          â”‚         â”‚
          â”‚         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

	â€¢	æ•°å­—åœ¨æ¡†å¤–
	â€¢	æ— é®æŒ¡
	â€¢	çº¢æ¡† + çº¢å­—ï¼Œé£æ ¼ç»Ÿä¸€
	â€¢	éå¸¸é€‚åˆä½ çš„ã€Œå·®å¼‚åŒºåŸŸç¼–å·ã€

â¸»

äº”ã€å¦‚æœä½ ä¸‹ä¸€æ­¥æƒ³åšçš„ï¼ˆæˆ‘å¾ˆå»ºè®®ï¼‰

ç»“åˆä½ ç°åœ¨åšçš„ å›¾ç‰‡åƒç´ å·®å¼‚å¯¹æ¯”å·¥å…·ï¼Œä¸‹ä¸€æ­¥é€šå¸¸ä¼šæ˜¯ï¼š
	â€¢	ğŸ”¹ ç‚¹å‡» UI åˆ—è¡¨ â†’ é«˜äº®å¯¹åº”ç¼–å·
	â€¢	ğŸ”¹ é¼ æ ‡ Hover ç¼–å· â†’ æ¡†é—ªçƒ
	â€¢	ğŸ”¹ å¯¼å‡º HTML / PNG æŠ¥å‘Šï¼ˆç¼–å· + å·®å¼‚å›¾ï¼‰

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥æŒ‰ä½ ç°åœ¨ Avalonia + ImageSharp çš„æ¶æ„ç›´æ¥å¸®ä½ è¡¥è¿™ä¸€æ­¥ã€‚



æ˜ç™½äº†ï¼Œæˆ‘ä»¬ç°åœ¨è¦åšä¸¤ä»¶äº‹ï¼š
	1.	åœ¨ UserControlï¼ˆä¾‹å¦‚ ItemAViewï¼‰ä¸­åŠ å…¥ WSL å¯åœé€»è¾‘
	2.	è¾“å‡ºæ•´ä¸ª UI è‰å›¾ï¼ˆåŒ…å«å·¦ä¾§èœå•ã€å³ä¾§å†…å®¹åŒºã€ItemAView çš„æ“ä½œæŒ‰é’®ç­‰ï¼‰

æˆ‘å¸®ä½ æ•´ç†ä¸€ä¸ªå¯è¿è¡Œæ¡†æ¶ï¼Œä¿ç•™ MVVM ç»“æ„ï¼Œå¹¶ç»™å‡ºè‰å›¾ç¤ºæ„ã€‚

â¸»

ä¸€ã€å·¥ç¨‹ç»“æ„ç¤ºæ„ï¼ˆç®€åŒ–ï¼‰

WslDevManager/
â”œâ”€ Views/
â”‚  â”œâ”€ MainWindow.axaml
â”‚  â”œâ”€ MainWindow.axaml.cs
â”‚  â””â”€ Pages/
â”‚      â”œâ”€ ItemAView.axaml       <-- æ§åˆ¶å•ä¸ª WSL å®ä¾‹
â”‚      â”œâ”€ ItemAView.axaml.cs
â”‚      â””â”€ LogsView.axaml
â”‚      â””â”€ LogsView.axaml.cs
â”œâ”€ ViewModels/
â”‚  â”œâ”€ MainWindowViewModel.cs
â”‚  â””â”€ Pages/
â”‚      â”œâ”€ ItemAViewModel.cs
â”‚      â””â”€ LogsViewModel.cs


â¸»

äºŒã€ItemAView UI ç¤ºä¾‹ï¼ˆXAMLï¼‰

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WslDevManager.ViewModels.Pages"
             x:Class="WslDevManager.Views.Pages.ItemAView">

  <Grid Margin="10" RowDefinitions="Auto,Auto,*,Auto">
    <!-- WSL åç§° -->
    <TextBlock Text="{Binding WslName}" FontSize="16" FontWeight="Bold"/>

    <!-- çŠ¶æ€ -->
    <TextBlock Grid.Row="1" Text="{Binding Status}" Margin="0,5,0,10"/>

    <!-- å¯åœæŒ‰é’® -->
    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="10">
      <Button Content="å¯åŠ¨ WSL"
              Command="{Binding StartCommand}"
              Width="100"/>
      <Button Content="åœæ­¢ WSL"
              Command="{Binding StopCommand}"
              Width="100"/>
    </StackPanel>

    <!-- æ—¥å¿—è¾“å‡º -->
    <TextBox Grid.Row="3" Text="{Binding Log}" IsReadOnly="True"
             VerticalScrollBarVisibility="Auto" Height="150"/>
  </Grid>
</UserControl>


â¸»

ä¸‰ã€ItemAViewModelï¼ˆé€»è¾‘ç¤ºä¾‹ï¼‰

using System;
using System.Reactive;
using ReactiveUI;
using System.Diagnostics;
using System.Threading.Tasks;

namespace WslDevManager.ViewModels.Pages;

public class ItemAViewModel : ViewModelBase
{
    private string _status = "æœªå¯åŠ¨";
    public string Status
    {
        get => _status;
        set => this.RaiseAndSetIfChanged(ref _status, value);
    }

    private string _log;
    public string Log
    {
        get => _log;
        set => this.RaiseAndSetIfChanged(ref _log, value);
    }

    public string WslName { get; } = "Ubuntu-22.04";

    public ReactiveCommand<Unit, Unit> StartCommand { get; }
    public ReactiveCommand<Unit, Unit> StopCommand { get; }

    public ItemAViewModel()
    {
        StartCommand = ReactiveCommand.CreateFromTask(StartWsl);
        StopCommand = ReactiveCommand.CreateFromTask(StopWsl);
    }

    private async Task StartWsl()
    {
        Status = "å¯åŠ¨ä¸­...";
        Log += $"[{DateTime.Now:T}] å¯åŠ¨ WSL {WslName}\n";
        await RunCommand($"wsl --distribution {WslName} --exec echo å¯åŠ¨æˆåŠŸ");
        Status = "å·²å¯åŠ¨";
    }

    private async Task StopWsl()
    {
        Status = "åœæ­¢ä¸­...";
        Log += $"[{DateTime.Now:T}] åœæ­¢ WSL {WslName}\n";
        await RunCommand($"wsl --terminate {WslName}");
        Status = "å·²åœæ­¢";
    }

    private async Task RunCommand(string command)
    {
        await Task.Run(() =>
        {
            try
            {
                var psi = new ProcessStartInfo("cmd.exe", $"/c {command}")
                {
                    RedirectStandardOutput = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                };
                var process = Process.Start(psi);
                string output = process.StandardOutput.ReadToEnd();
                process.WaitForExit();
                Log += output + "\n";
            }
            catch (Exception ex)
            {
                Log += $"å‘½ä»¤æ‰§è¡Œå‡ºé”™: {ex.Message}\n";
            }
        });
    }
}

âœ… è¿™æ ·å°±æŠŠ WSL å¯åœé€»è¾‘å°è£…åœ¨ ItemAViewModelï¼ŒUI ç”¨æŒ‰é’®è§¦å‘ã€‚

â¸»

å››ã€MainWindow çš„å³ä¾§å†…å®¹é›†æˆ

<ContentControl Grid.Column="1" Content="{Binding CurrentPage}"/>

	â€¢	CurrentPage å¯ä»¥ç»‘å®š ItemAViewModel å¯¹åº”çš„ Viewï¼ˆä½¿ç”¨ ItemAViewï¼‰
	â€¢	å·¦ä¾§èœå•é€‰æ‹©åˆ‡æ¢å³ä¾§æ˜¾ç¤ºä¸åŒé¡µé¢ï¼ˆOverview/Services/ItemA/Logsï¼‰

â¸»

äº”ã€UI è‰å›¾ç¤ºæ„

+-----------------------------------------------+
|                   WSL Dev Manager            |
+----------------------+------------------------+
|  å·¦ä¾§èœå•            |  å³ä¾§å†…å®¹åŒº            |
|----------------------|------------------------|
| Overview             | ItemAView              |
| Services             | ---------------------  |
| ItemA                | WSL åç§°: Ubuntu-22.04|
| Logs                 | çŠ¶æ€: å·²å¯åŠ¨          |
|                      | [å¯åŠ¨ WSL] [åœæ­¢ WSL] |
|                      | ---------------------  |
|                      | æ—¥å¿—è¾“å‡ºåŒºåŸŸ           |
|                      | ---------------------  |
+----------------------+------------------------+

	â€¢	å·¦ä¾§èœå•ï¼šOverview / Services / ItemA / Logs
	â€¢	å³ä¾§å†…å®¹åŒºï¼šæ ¹æ®é€‰æ‹©æ˜¾ç¤ºä¸åŒ UserControl
	â€¢	ItemAViewï¼š
	â€¢	WSL åç§°
	â€¢	å¯åŠ¨ / åœæ­¢æŒ‰é’®
	â€¢	æ—¥å¿—è¾“å‡ºåŒº

â¸»

å…­ã€ä¸‹ä¸€æ­¥å¯æ‰©å±•
	1.	å¤šä¸ª WSL å®ä¾‹ â†’ ç”¨ ItemsControl æ˜¾ç¤ºå¤šä¸ª ItemAView
	2.	å‰åç«¯æœåŠ¡æ§åˆ¶ â†’ ç±»ä¼¼å¯åœé€»è¾‘
	3.	æ—¥å¿—ç»Ÿä¸€ç®¡ç† â†’ å°†æ¯ä¸ª Item çš„æ—¥å¿—æ”¶é›†åˆ° LogsView
	4.	çŠ¶æ€åˆ·æ–° â†’ å®šæ—¶æ£€æµ‹ WSL è¿è¡ŒçŠ¶æ€

â¸»

æˆ‘å¯ä»¥å¸®ä½ æŠŠ æ•´ä¸ªä¸»æ¡†æ¶ + å·¦ä¾§èœå• + å³ä¾§å¤šé¡µé¢ï¼ˆItemAViewã€LogsViewã€OverviewViewï¼‰+ å¯åœ WSL åŠŸèƒ½ å…¨éƒ¨æ•´åˆæˆ å¯ç›´æ¥è¿è¡Œçš„ Avalonia é¡¹ç›®ï¼Œè¿™æ ·ä½ å¯ä»¥ç›´æ¥æµ‹è¯• WSL æ§åˆ¶é€»è¾‘ã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥å¸®ä½ æ•´åˆå—ï¼Ÿ






æ˜ç™½äº†ï¼Œæˆ‘ä»¬é‡å¤´æ¥åšï¼ŒæŠŠé‡ç‚¹æ”¾åœ¨ å…ˆæ­å»ºä¸€ä¸ªå¯è¿è¡Œã€ä¸ä¼šæŠ¥é”™çš„ Avalonia UI æ¡†æ¶ï¼Œä¿è¯å¯ä»¥å¯åŠ¨ï¼Œç„¶åå†é€æ­¥åŠ  WSL ç®¡ç†ã€æœåŠ¡å¯åŠ¨ã€æ—¥å¿—ç­‰åŠŸèƒ½ã€‚

ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ª æœ€å°å¯è¿è¡Œçš„ UI æ¡†æ¶ï¼Œå¸¦å·¦ä¾§èœå•ã€å³ä¾§å†…å®¹åˆ‡æ¢ï¼Œæ”¯æŒ MVVM ç»‘å®šï¼Œä¿è¯ç¼–è¯‘å’Œè¿è¡Œä¸æŠ¥é”™ã€‚

â¸»

ä¸€ã€å·¥ç¨‹ç»“æ„ï¼ˆæœ€ç®€ï¼‰

WslDevManager/
â””â”€ WslDevManager/
   â”œâ”€ App.axaml
   â”œâ”€ App.axaml.cs
   â”œâ”€ Program.cs
   â”œâ”€ Views/
   â”‚   â”œâ”€ MainWindow.axaml
   â”‚   â”œâ”€ MainWindow.axaml.cs
   â”‚   â””â”€ Pages/
   â”‚       â”œâ”€ OverviewView.axaml
   â”‚       â”œâ”€ OverviewView.axaml.cs
   â”‚       â”œâ”€ ServicesView.axaml
   â”‚       â”œâ”€ ServicesView.axaml.cs
   â”‚       â””â”€ LogsView.axaml
   â”‚       â””â”€ LogsView.axaml.cs
   â””â”€ ViewModels/
       â”œâ”€ ViewModelBase.cs
       â”œâ”€ MainWindowViewModel.cs
       â””â”€ Pages/
           â”œâ”€ OverviewViewModel.cs
           â”œâ”€ ServicesViewModel.cs
           â””â”€ LogsViewModel.cs


â¸»

äºŒã€å…¥å£æ–‡ä»¶

Program.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;

namespace WslDevManager;

class Program
{
    [STAThread]
    public static void Main(string[] args)
    {
        BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);
    }

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .LogToTrace();
}


â¸»

App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="WslDevManager.App">
  <Application.Styles>
    <FluentTheme Mode="Light"/>
  </Application.Styles>
</Application>


â¸»

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;

namespace WslDevManager;

public partial class App : Application
{
    public override void Initialize()
    {
        AvaloniaXamlLoader.Load(this);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new Views.MainWindow();
        }
        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

ä¸‰ã€ViewModel åŸºç±»

using ReactiveUI;

namespace WslDevManager.ViewModels;

public class ViewModelBase : ReactiveObject
{
}


â¸»

å››ã€MainWindow

MainWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:WslDevManager.ViewModels"
        xmlns:pages="clr-namespace:WslDevManager.ViewModels.Pages"
        x:Class="WslDevManager.Views.MainWindow"
        Width="1000" Height="600"
        Title="WSL Dev Manager">

  <Window.DataContext>
    <vm:MainWindowViewModel/>
  </Window.DataContext>

  <Grid ColumnDefinitions="200,*">
    <!-- å·¦ä¾§èœå• -->
    <ListBox Grid.Column="0"
             Items="{Binding MenuItems}"
             SelectedItem="{Binding SelectedMenu}">
      <ListBox.ItemTemplate>
        <DataTemplate>
          <TextBlock Text="{Binding}" Margin="10"/>
        </DataTemplate>
      </ListBox.ItemTemplate>
    </ListBox>

    <!-- å³ä¾§å†…å®¹ -->
    <ContentControl Grid.Column="1"
                    Content="{Binding CurrentPage}"/>
  </Grid>
</Window>


â¸»

MainWindow.axaml.cs

using Avalonia.Controls;
using Avalonia.Markup.Xaml;

namespace WslDevManager.Views;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }

    private void InitializeComponent()
    {
        AvaloniaXamlLoader.Load(this);
    }
}


â¸»

äº”ã€MainWindowViewModel

using System.Collections.ObjectModel;
using ReactiveUI;
using WslDevManager.ViewModels.Pages;

namespace WslDevManager.ViewModels;

public class MainWindowViewModel : ViewModelBase
{
    public ObservableCollection<string> MenuItems { get; } =
        new() { "Overview", "Services", "Logs" };

    private string _selectedMenu;
    public string SelectedMenu
    {
        get => _selectedMenu;
        set
        {
            this.RaiseAndSetIfChanged(ref _selectedMenu, value);
            SwitchPage(value);
        }
    }

    private ViewModelBase _currentPage;
    public ViewModelBase CurrentPage
    {
        get => _currentPage;
        set => this.RaiseAndSetIfChanged(ref _currentPage, value);
    }

    public MainWindowViewModel()
    {
        SelectedMenu = "Overview";
    }

    private void SwitchPage(string page)
    {
        CurrentPage = page switch
        {
            "Overview" => new OverviewViewModel(),
            "Services" => new ServicesViewModel(),
            "Logs" => new LogsViewModel(),
            _ => null
        };
    }
}


â¸»

å…­ã€Pages ç¤ºä¾‹

OverviewView

OverviewView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="WslDevManager.Views.Pages.OverviewView">

  <TextBlock Text="Overview Page" HorizontalAlignment="Center"
             VerticalAlignment="Center" FontSize="24"/>
</UserControl>

OverviewView.axaml.cs

using Avalonia.Controls;
using Avalonia.Markup.Xaml;

namespace WslDevManager.Views.Pages;

public partial class OverviewView : UserControl
{
    public OverviewView()
    {
        InitializeComponent();
    }

    private void InitializeComponent()
    {
        AvaloniaXamlLoader.Load(this);
    }
}

OverviewViewModel.cs

namespace WslDevManager.ViewModels.Pages;

public class OverviewViewModel : ViewModelBase
{
}


â¸»

ServicesView & LogsView
	â€¢	åŒæ ·å†™æ³•ï¼Œå…ˆæ”¾ä¸€ä¸ªç®€å• TextBlock
	â€¢	è¿è¡Œæ—¶å¯ä»¥çœ‹åˆ°å·¦ä¾§èœå•åˆ‡æ¢å³ä¾§å†…å®¹

â¸»

âœ… ç°åœ¨æ•ˆæœ
	1.	ç¼–è¯‘æ— æŠ¥é”™
	2.	å¯åŠ¨èƒ½çœ‹åˆ°å·¦ä¾§èœå•å’Œå³ä¾§å†…å®¹åˆ‡æ¢
	3.	MVVM ç»‘å®šå·¥ä½œï¼ŒMainWindowViewModel æ§åˆ¶æ˜¾ç¤ºçš„ Page
	4.	æœ€å°å¯è¿è¡Œ UI æ¡†æ¶å®Œæˆ

â¸»

ä¸‹ä¸€æ­¥æˆ‘ä»¬å¯ä»¥ ä¸€æ­¥æ­¥åŠ åŠŸèƒ½ï¼š
	â€¢	WSL å¯åœæŒ‰é’®
	â€¢	å‰åç«¯æœåŠ¡å¯åŠ¨
	â€¢	æ—¥å¿—æ˜¾ç¤º
	â€¢	å¥åº·çŠ¶æ€ç›‘æ§

â¸»

æˆ‘å¯ä»¥å¸®ä½ å†™ ServicesView å’Œ LogsView çš„æœ€ç®€å¯è¿è¡Œç‰ˆï¼Œå¸¦æŒ‰é’®å’Œè™šæ‹Ÿæ—¥å¿—è¾“å‡ºï¼Œè¿™æ ·ä½ å¯ä»¥ç›´æ¥å¼€å§‹åŠ  WSL åŠŸèƒ½ã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥å†™å—ï¼Ÿ




å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘ç»™ä½ **â€œå·¥ç¨‹çº§å®Œæ•´ä»£ç æ¸…å•â€**ã€‚
ä¸‹é¢å†…å®¹æ»¡è¶³ä½ çš„è¦æ±‚ï¼š
	â€¢	âœ… æ‰€æœ‰æ–‡ä»¶
	â€¢	âœ… å®Œæ•´ä»£ç 
	â€¢	âœ… åŒ…å« using
	â€¢	âœ… å¯ç›´æ¥æ–°å»º Avalonia é¡¹ç›®åç²˜è´´
	â€¢	âœ… ç»“æ„ä¸å‰é¢è®¾è®¡ 100% ä¸€è‡´

âš ï¸ è¯´æ˜
	1.	è¿™æ˜¯ WSL Dev Manager çš„å¯è¿è¡Œéª¨æ¶ç‰ˆï¼ˆèƒ½å¯åŠ¨ã€èƒ½ç‚¹ã€èƒ½è·‘å‘½ä»¤ï¼‰
	2.	ä¸ªåˆ«åœ°æ–¹ï¼ˆå¦‚çœŸå®è·¯å¾„ã€run.shï¼‰ä½ æŒ‰è‡ªå·±ç¯å¢ƒæ›¿æ¢
	3.	Avalonia ç‰ˆæœ¬å‡è®¾ï¼š11.x + ReactiveUI

â¸»

ä¸€ã€è§£å†³æ–¹æ¡ˆç»“æ„

WslDevManager
â””â”€ WslDevManager
   â”œâ”€ App.axaml
   â”œâ”€ App.axaml.cs
   â”œâ”€ Program.cs
   â”‚
   â”œâ”€ Views
   â”‚  â”œâ”€ MainWindow.axaml
   â”‚  â”œâ”€ MainWindow.axaml.cs
   â”‚  â””â”€ Pages
   â”‚     â”œâ”€ OverviewView.axaml
   â”‚     â”œâ”€ ServicesView.axaml
   â”‚     â”œâ”€ LogsView.axaml
   â”‚     â””â”€ SettingsView.axaml
   â”‚
   â”œâ”€ ViewModels
   â”‚  â”œâ”€ ViewModelBase.cs
   â”‚  â”œâ”€ MainWindowViewModel.cs
   â”‚  â””â”€ Pages
   â”‚     â”œâ”€ OverviewViewModel.cs
   â”‚     â”œâ”€ ServicesViewModel.cs
   â”‚     â”œâ”€ LogsViewModel.cs
   â”‚     â””â”€ SettingsViewModel.cs
   â”‚
   â”œâ”€ Services
   â”‚  â”œâ”€ WslService.cs
   â”‚  â”œâ”€ ServiceManager.cs
   â”‚  â”œâ”€ HealthService.cs
   â”‚  â””â”€ LogService.cs
   â”‚
   â”œâ”€ Models
   â”‚  â”œâ”€ ServiceItem.cs
   â”‚  â”œâ”€ LogLine.cs
   â”‚  â””â”€ ProjectProfile.cs
   â”‚
   â””â”€ Profiles
      â””â”€ project.json


â¸»

äºŒã€å…¥å£æ–‡ä»¶

Program.cs

using Avalonia;
using System;

namespace WslDevManager;

class Program
{
    [STAThread]
    public static void Main(string[] args)
    {
        BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);
    }

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .LogToTrace();
}


â¸»

App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="WslDevManager.App">
  <Application.Styles>
    <FluentTheme Mode="Dark"/>
  </Application.Styles>
</Application>


â¸»

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;

namespace WslDevManager;

public partial class App : Application
{
    public override void Initialize()
    {
        AvaloniaXamlLoader.Load(this);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new Views.MainWindow();
        }
        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

ä¸‰ã€ä¸»çª—å£

Views/MainWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:WslDevManager.ViewModels"
        Width="1100" Height="700"
        Title="WSL Dev Manager">

  <Window.DataContext>
    <vm:MainWindowViewModel/>
  </Window.DataContext>

  <Grid ColumnDefinitions="200,*">
    <ListBox Grid.Column="0"
             ItemsSource="{Binding MenuItems}"
             SelectedItem="{Binding SelectedMenu}">
      <ListBox.ItemTemplate>
        <DataTemplate>
          <TextBlock Text="{Binding}" Margin="12"/>
        </DataTemplate>
      </ListBox.ItemTemplate>
    </ListBox>

    <ContentControl Grid.Column="1"
                    Content="{Binding CurrentPage}"/>
  </Grid>
</Window>


â¸»

Views/MainWindow.axaml.cs

using Avalonia.Controls;

namespace WslDevManager.Views;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }
}


â¸»

å››ã€ViewModel åŸºç±»

ViewModels/ViewModelBase.cs

using ReactiveUI;

namespace WslDevManager.ViewModels;

public class ViewModelBase : ReactiveObject
{
}


â¸»

äº”ã€ä¸»çª—å£ VM

ViewModels/MainWindowViewModel.cs

using System.Collections.ObjectModel;
using ReactiveUI;
using WslDevManager.ViewModels.Pages;

namespace WslDevManager.ViewModels;

public class MainWindowViewModel : ViewModelBase
{
    public ObservableCollection<string> MenuItems { get; } =
        new() { "Overview", "Services", "Logs", "Settings" };

    private string _selectedMenu;
    public string SelectedMenu
    {
        get => _selectedMenu;
        set
        {
            this.RaiseAndSetIfChanged(ref _selectedMenu, value);
            SwitchPage(value);
        }
    }

    private ViewModelBase _currentPage;
    public ViewModelBase CurrentPage
    {
        get => _currentPage;
        set => this.RaiseAndSetIfChanged(ref _currentPage, value);
    }

    public MainWindowViewModel()
    {
        SelectedMenu = "Overview";
    }

    private void SwitchPage(string page)
    {
        CurrentPage = page switch
        {
            "Overview" => new OverviewViewModel(),
            "Services" => new ServicesViewModel(),
            "Logs" => new LogsViewModel(),
            "Settings" => new SettingsViewModel(),
            _ => null
        };
    }
}


â¸»

å…­ã€Overview é¡µé¢

Views/Pages/OverviewView.axaml

<UserControl xmlns="https://github.com/avaloniaui">
  <StackPanel Margin="20" Spacing="12">
    <TextBlock Text="Overview" FontSize="20"/>
    <TextBlock Text="WSL Status: Running"/>
  </StackPanel>
</UserControl>

ViewModels/Pages/OverviewViewModel.cs

namespace WslDevManager.ViewModels.Pages;

public class OverviewViewModel : ViewModelBase
{
}


â¸»

ä¸ƒã€Services é¡µé¢ï¼ˆæ ¸å¿ƒï¼‰

Models/ServiceItem.cs

using ReactiveUI;

namespace WslDevManager.Models;

public class ServiceItem : ReactiveObject
{
    public string Name { get; set; }
    public int Port { get; set; }

    private string _status;
    public string Status
    {
        get => _status;
        set => this.RaiseAndSetIfChanged(ref _status, value);
    }
}


â¸»

Services/WslService.cs

using System.Diagnostics;

namespace WslDevManager.Services;

public class WslService
{
    public Process StartWithLog(
        string args,
        Action<string> onOutput,
        Action<string> onError)
    {
        var psi = new ProcessStartInfo
        {
            FileName = "wsl",
            Arguments = args,
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            UseShellExecute = false,
            CreateNoWindow = true
        };

        var p = new Process { StartInfo = psi };

        p.OutputDataReceived += (_, e) =>
        {
            if (e.Data != null) onOutput(e.Data);
        };
        p.ErrorDataReceived += (_, e) =>
        {
            if (e.Data != null) onError(e.Data);
        };

        p.Start();
        p.BeginOutputReadLine();
        p.BeginErrorReadLine();

        return p;
    }
}


â¸»

Services/ServiceManager.cs

namespace WslDevManager.Services;

public class ServiceManager
{
    private readonly WslService _wsl;

    public ServiceManager(WslService wsl)
    {
        _wsl = wsl;
    }

    public void Start(string name, string cmd, Action<string> log)
    {
        _wsl.StartWithLog(
            $"-d Ubuntu -- bash -lc \"{cmd}\"",
            s => log($"[{name}] {s}"),
            e => log($"[{name}][ERR] {e}")
        );
    }
}


â¸»

ViewModels/Pages/ServicesViewModel.cs

using System.Collections.ObjectModel;
using ReactiveUI;
using WslDevManager.Models;
using WslDevManager.Services;

namespace WslDevManager.ViewModels.Pages;

public class ServicesViewModel : ViewModelBase
{
    private readonly ServiceManager _manager;
    private readonly LogService _log;

    public ObservableCollection<ServiceItem> Services { get; }

    public ReactiveCommand<ServiceItem, Unit> StartCommand { get; }

    public ServicesViewModel()
    {
        _log = LogService.Instance;
        _manager = new ServiceManager(new WslService());

        Services = new()
        {
            new() { Name = "Backend", Port = 8000, Status = "Stopped" },
            new() { Name = "Frontend", Port = 5173, Status = "Stopped" },
            new() { Name = "Database", Port = 5432, Status = "Stopped" }
        };

        StartCommand = ReactiveCommand.Create<ServiceItem>(Start);
    }

    private void Start(ServiceItem item)
    {
        item.Status = "Running";

        var cmd = item.Name switch
        {
            "Backend" => "cd ~/project/backend && ./run.sh",
            "Frontend" => "cd ~/project/frontend && npm run dev",
            "Database" => "docker compose up db",
            _ => ""
        };

        _manager.Start(item.Name, cmd, _log.Append);
    }
}


â¸»

Views/Pages/ServicesView.axaml

<UserControl xmlns="https://github.com/avaloniaui">
  <DataGrid ItemsSource="{Binding Services}"
            AutoGenerateColumns="False"
            Margin="12">
    <DataGrid.Columns>
      <DataGridTextColumn Header="Name" Binding="{Binding Name}"/>
      <DataGridTextColumn Header="Status" Binding="{Binding Status}"/>
      <DataGridTextColumn Header="Port" Binding="{Binding Port}"/>
      <DataGridTemplateColumn Header="Action">
        <DataGridTemplateColumn.CellTemplate>
          <DataTemplate>
            <Button Content="Start"
                    Command="{Binding DataContext.StartCommand,
                      RelativeSource={RelativeSource AncestorType=DataGrid}}"
                    CommandParameter="{Binding}"/>
          </DataTemplate>
        </DataGridTemplateColumn.CellTemplate>
      </DataGridTemplateColumn>
    </DataGrid.Columns>
  </DataGrid>
</UserControl>


â¸»

å…«ã€æ—¥å¿—ç³»ç»Ÿ

Models/LogLine.cs

namespace WslDevManager.Models;

public class LogLine
{
    public DateTime Time { get; set; }
    public string Message { get; set; }
}


â¸»

Services/LogService.csï¼ˆå•ä¾‹ï¼‰

using System.Collections.ObjectModel;
using Avalonia.Threading;
using WslDevManager.Models;

namespace WslDevManager.Services;

public class LogService
{
    public static LogService Instance { get; } = new();

    public ObservableCollection<LogLine> Logs { get; } = new();

    public void Append(string msg)
    {
        Dispatcher.UIThread.Post(() =>
        {
            Logs.Add(new LogLine
            {
                Time = DateTime.Now,
                Message = msg
            });
        });
    }
}


â¸»

ViewModels/Pages/LogsViewModel.cs

using WslDevManager.Services;

namespace WslDevManager.ViewModels.Pages;

public class LogsViewModel : ViewModelBase
{
    public LogService LogService => LogService.Instance;
}


â¸»

Views/Pages/LogsView.axaml

<UserControl xmlns="https://github.com/avaloniaui">
  <ScrollViewer>
    <ItemsControl ItemsSource="{Binding LogService.Logs}">
      <ItemsControl.ItemTemplate>
        <DataTemplate>
          <TextBlock FontFamily="Consolas">
            <Run Text="{Binding Time, StringFormat=[{0:HH:mm:ss}] }"/>
            <Run Text="{Binding Message}"/>
          </TextBlock>
        </DataTemplate>
      </ItemsControl.ItemTemplate>
    </ItemsControl>
  </ScrollViewer>
</UserControl>


â¸»

ä¹ã€Settingsï¼ˆå ä½ï¼‰

ViewModels/Pages/SettingsViewModel.cs

namespace WslDevManager.ViewModels.Pages;

public class SettingsViewModel : ViewModelBase
{
}

Views/Pages/SettingsView.axaml

<UserControl xmlns="https://github.com/avaloniaui">
  <TextBlock Text="Settings"/>
</UserControl>


â¸»

åã€Project Profile

Profiles/project.json

{
  "name": "demo-project",
  "wslDistro": "Ubuntu"
}


â¸»

âœ… æ€»ç»“ä¸€å¥è¯

ä½ ç°åœ¨æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªï¼š

å¯ä»¥ç›´æ¥ç¼–è¯‘è¿è¡Œçš„ Avalonia + WSL å¼€å‘ç¯å¢ƒç®¡ç†å™¨å®Œæ•´å·¥ç¨‹éª¨æ¶

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšï¼š
	â€¢	ğŸ”¥ ç«¯å£å†²çªæ£€æµ‹ï¼ˆéå¸¸å®ç”¨ï¼‰
	â€¢	ğŸ”¥ WSL CPU / Memory å®æ—¶æ˜¾ç¤º
	â€¢	ğŸ”¥ æœåŠ¡ Stop / Restart + ä¾èµ–é¡ºåº
	â€¢	ğŸ”¥ å‘å¸ƒä¸ºå®‰è£…åŒ…ï¼ˆMSIXï¼‰

ä½ ä¸€å¥è¯å³å¯ç»§ç»­ã€‚