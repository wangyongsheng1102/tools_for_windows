明白了，你想要把整个 Avalonia + Fluent + MVVM + WSL/PostgreSQL + CSV 主键对比 + 行级差异 UI + Excel 报告整合成一个完整工程，我来帮你梳理一份可直接使用的工程结构和核心代码。我会输出工程目录结构 + 每个文件完整内容，保持可编译。

注意：为了清晰，保留命名空间、MVVM 风格、所有功能模块（数据库连接、WSL 控制、CSV 对比、行级差异 UI、Excel 导出）。

⸻

一、工程目录结构

WslPostgresTool/
├─ WslPostgresTool.csproj
├─ Program.cs
├─ App.axaml
├─ App.axaml.cs
├─ MainWindow.axaml
├─ MainWindow.axaml.cs
├─ Views/
│   ├─ CsvCompareView.axaml
│   ├─ CsvRowDiffWindow.axaml
├─ ViewModels/
│   ├─ MainWindowViewModel.cs
│   ├─ CsvCompareViewModel.cs
│   ├─ CsvRowDiffViewModel.cs
├─ Models/
│   ├─ AppState.cs
│   ├─ CsvDiffResult.cs
│   ├─ CsvRowDiff.cs
│   ├─ CsvCellDiff.cs
├─ Services/
│   ├─ WslService.cs
│   ├─ PostgresService.cs
│   ├─ CsvCompareService.cs
│   ├─ ExcelReportService.cs
│   └─ LoggingService.cs
├─ Converters/
│   └─ BoolToBrushConverter.cs
│   └─ DiffColorConverter.cs


⸻

二、核心项目文件

1️⃣ WslPostgresTool.csproj

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net7.0</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWPF>false</UseWPF>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia" Version="12.0.0" />
    <PackageReference Include="Avalonia.Desktop" Version="12.0.0" />
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.1.0" />
    <PackageReference Include="Npgsql" Version="7.2.0" />
    <PackageReference Include="ClosedXML" Version="0.108.0" />
  </ItemGroup>

</Project>


⸻

2️⃣ Program.cs

using Avalonia;
using Avalonia.ReactiveUI;

namespace WslPostgresTool;

internal class Program
{
    public static void Main(string[] args) => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
                     .UsePlatformDetect()
                     .LogToTrace()
                     .UseReactiveUI();
}


⸻

3️⃣ App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="WslPostgresTool.App">
  <Application.Resources>
    <ResourceDictionary>
      <converters:BoolToBrushConverter x:Key="BoolToBrush" />
      <converters:DiffColorConverter x:Key="DiffColorConverter" />
    </ResourceDictionary>
  </Application.Resources>
</Application>

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using WslPostgresTool.ViewModels;
using WslPostgresTool.Views;

namespace WslPostgresTool;

public partial class App : Application
{
    public override void Initialize() => AvaloniaXamlLoader.Load(this);

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow
            {
                DataContext = new MainWindowViewModel()
            };
        }

        base.OnFrameworkInitializationCompleted();
    }
}


⸻

三、Models

1️⃣ AppState.cs

using CommunityToolkit.Mvvm.ComponentModel;

namespace WslPostgresTool.Models;

public partial class AppState : ObservableObject
{
    public static AppState Instance { get; } = new();

    [ObservableProperty] private string host = "localhost";
    [ObservableProperty] private int port = 5432;
    [ObservableProperty] private string database = "postgres";
    [ObservableProperty] private string username = "postgres";
    [ObservableProperty] private string password = "";
    [ObservableProperty] private string schema = "public";

    public string ConnectionString =>
        $"Host={Host};Port={Port};Database={Database};Username={Username};Password={Password}";
}

2️⃣ CsvDiffResult.cs

namespace WslPostgresTool.Models;

public class CsvDiffResult
{
    public string FileName { get; set; } = "";
    public string Status { get; set; } = "";
    public int LeftRows { get; set; }
    public int RightRows { get; set; }
    public int DiffRows { get; set; }

    public string LeftPath { get; set; } = "";
    public string RightPath { get; set; } = "";
}

3️⃣ CsvRowDiff.cs

using System.Collections.Generic;

namespace WslPostgresTool.Models;

public class CsvRowDiff
{
    public string Status { get; set; } = "";
    public string PrimaryKey { get; set; } = "";
    public List<CsvCellDiff> Cells { get; set; } = new();
}

4️⃣ CsvCellDiff.cs

namespace WslPostgresTool.Models;

public class CsvCellDiff
{
    public string Column { get; set; } = "";
    public string? Left { get; set; }
    public string? Right { get; set; }

    public bool IsDifferent => !string.Equals(Left, Right, StringComparison.Ordinal);
}


⸻

四、Services

1️⃣ LoggingService.cs

using System;

namespace WslPostgresTool.Services;

public class LoggingService
{
    private static readonly LoggingService _instance = new();
    public static LoggingService Instance => _instance;

    public event Action<string>? LogAdded;

    public void Log(string msg)
    {
        LogAdded?.Invoke($"[{DateTime.Now:HH:mm:ss}] {msg}");
    }
}

2️⃣ WslService.cs

using System.Diagnostics;
using System.Threading.Tasks;

namespace WslPostgresTool.Services;

public class WslService
{
    public async Task<bool> IsWslAvailableAsync()
    {
        try
        {
            var p = new ProcessStartInfo("wsl.exe", "--status")
            {
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false
            };
            var proc = Process.Start(p)!;
            await proc.WaitForExitAsync();
            return proc.ExitCode == 0;
        }
        catch
        {
            return false;
        }
    }

    public async Task<bool> IsPostgresRunningAsync()
    {
        try
        {
            var p = new ProcessStartInfo("wsl.exe", "pg_isready")
            {
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false
            };
            var proc = Process.Start(p)!;
            await proc.WaitForExitAsync();
            return proc.ExitCode == 0;
        }
        catch
        {
            return false;
        }
    }

    public async Task<(bool wsl, bool pg)> GetStatusAsync()
    {
        var wsl = await IsWslAvailableAsync();
        var pg = wsl && await IsPostgresRunningAsync();
        return (wsl, pg);
    }
}

3️⃣ PostgresService.cs

using Npgsql;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace WslPostgresTool.Services;

public class PostgresService
{
    public async Task<List<string>> LoadPrimaryKeyAsync(string connStr, string schema, string table)
    {
        var keys = new List<string>();
        await using var conn = new NpgsqlConnection(connStr);
        await conn.OpenAsync();

        const string sql = """
            SELECT kcu.column_name
            FROM information_schema.table_constraints tc
            JOIN information_schema.key_column_usage kcu
              ON tc.constraint_name = kcu.constraint_name
             AND tc.table_schema = kcu.table_schema
            WHERE tc.constraint_type = 'PRIMARY KEY'
              AND tc.table_schema = @schema
              AND tc.table_name = @table
            ORDER BY kcu.ordinal_position;
        """;

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("schema", schema);
        cmd.Parameters.AddWithValue("table", table);

        await using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
            keys.Add(reader.GetString(0));

        return keys;
    }
}

4️⃣ CsvCompareService.cs

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using WslPostgresTool.Models;

namespace WslPostgresTool.Services;

public class CsvCompareService
{
    private readonly PostgresService _pg = new();

    public async Task<(CsvDiffResult summary, List<CsvRowDiff> rows)>
        CompareTableAsync(string leftCsv, string rightCsv, string schema, string connStr)
    {
        var table = Path.GetFileNameWithoutExtension(leftCsv);
        var pkColumns = await _pg.LoadPrimaryKeyAsync(connStr, schema, table);
        if (pkColumns.Count == 0)
            throw new Exception($"Table {table} has no primary key.");

        var leftDict = LoadCsvByPk(leftCsv, pkColumns);
        var rightDict = LoadCsvByPk(rightCsv, pkColumns);

        var diffs = new List<CsvRowDiff>();
        var allKeys = leftDict.Keys.Union(rightDict.Keys);

        foreach (var key in allKeys)
        {
            leftDict.TryGetValue(key, out var l);
            rightDict.TryGetValue(key, out var r);

            if (l == null)
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Added",
                    PrimaryKey = key,
                    Cells = r.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Right = v
                    }).ToList()
                });
            }
            else if (r == null)
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Removed",
                    PrimaryKey = key,
                    Cells = l.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Left = v
                    }).ToList()
                });
            }
            else if (!l.SequenceEqual(r))
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Modified",
                    PrimaryKey = key,
                    Cells = l.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Left = v,
                        Right = r[i]
                    }).ToList()
                });
            }
        }

        return (new CsvDiffResult
        {
            FileName = table,
            Status = diffs.Any() ? "Modified" : "Same",
            LeftRows = leftDict.Count,
            RightRows = rightDict.Count,
            DiffRows = diffs.Count,
            LeftPath = leftCsv,
            RightPath = rightCsv
        }, diffs);
    }

    private Dictionary<string, string[]> LoadCsvByPk(string file, List<string> pkColumns)
    {
        using var reader = new StreamReader(file);
        var header = reader.ReadLine()!.Split(',');
        var pkIndexes = pkColumns.Select(c => Array.IndexOf(header, c)).ToArray();

        var dict = new Dictionary<string, string[]>();
        string? line;
        while ((line = reader.ReadLine()) != null)
        {
            var cols = line.Split(',');
            var key = string.Join("||", pkIndexes.Select(i => cols[i]));
            dict[key] = cols;
        }

        return dict;
    }
}

5️⃣ ExcelReportService.cs

using ClosedXML.Excel;
using System.Collections.Generic;
using WslPostgresTool.Models;

namespace WslPostgresTool.Services;

public class ExcelReportService
{
    public void GenerateKeyDiffReport(string output,
        CsvDiffResult summary, List<CsvRowDiff> rows)
    {
        using var wb = new XLWorkbook();
        var ws = wb.AddWorksheet("Summary");
        ws.Cell(1, 1).InsertTable(new[] { summary });

        var diff = wb.AddWorksheet("Diff");
        diff.Cell(1, 1).Value = "Status";
        diff.Cell(1, 2).Value = "Primary Key";
        diff.Cell(1, 3).Value = "Left";
        diff.Cell(1, 4).Value = "Right";

        var rowIdx = 2;
        foreach (var r in rows)
        {
            foreach (var c in r.Cells)
            {
                diff.Cell(rowIdx, 1).Value = r.Status;
                diff.Cell(rowIdx, 2).Value = r.PrimaryKey;
                diff.Cell(rowIdx, 3).Value = c.Left;
                diff.Cell(rowIdx, 4).Value = c.Right;

                if (c.IsDifferent) diff.Row(rowIdx).Style.Fill.BackgroundColor = XLColor.LightSalmon;
                rowIdx++;
            }
        }

        wb.SaveAs(output);
    }
}


⸻

五、Converters

BoolToBrushConverter.cs

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace WslPostgresTool.Converters;

public class BoolToBrushConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        => (bool)value ? Brushes.Green : Brushes.Red;

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotSupportedException();
}

DiffColorConverter.cs

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace WslPostgresTool.Converters;

public class DiffColorConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        => (bool)value ? Brushes.LightSalmon : Brushes.Transparent;

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotSupportedException();
}


⸻

六、ViewModels

MainWindowViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class MainWindowViewModel : ObservableObject
{
    private readonly WslService _wsl = new();
    private readonly LoggingService _log = LoggingService.Instance;

    [ObservableProperty] private bool wslOk;
    [ObservableProperty] private bool postgresOk;

    [ObservableProperty] private ObservableCollection<string> logs = new();

    public MainWindowViewModel()
    {
        _log.LogAdded += msg => logs.Add(msg);
        var timer = new System.Timers.Timer(5000);
        timer.Elapsed += async (_, _) =>
        {
            var (wsl, pg) = await _wsl.GetStatusAsync();
            WslOk = wsl;
            PostgresOk = pg;
        };
        timer.Start();
    }
}

CsvCompareViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class CsvCompareViewModel : ObservableObject
{
    private readonly CsvCompareService _compare = new();
    private readonly ExcelReportService _excel = new();
    private readonly LoggingService _log = LoggingService.Instance;

    [ObservableProperty] private string leftFolder = "";
    [ObservableProperty] private string rightFolder = "";

    public ObservableCollection<CsvDiffResult> Results { get; } = new();

    [RelayCommand]
    public async Task CompareAsync()
    {
        Results.Clear();
        var files = Directory.GetFiles(LeftFolder, "*.csv");

        foreach (var left in files)
        {
            var name = Path.GetFileName(left);
            var right = Path.Combine(RightFolder, name);
            if (!File.Exists(right)) continue;

            var (summary, _) = await _compare.CompareTableAsync(
                left, right, Models.AppState.Instance.Schema, Models.AppState.Instance.ConnectionString);

            summary.LeftPath = left;
            summary.RightPath = right;

            Results.Add(summary);
        }
        _log.Log($"Compared {Results.Count} CSV files.");
    }
}

CsvRowDiffViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using System.Linq;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class CsvRowDiffViewModel : ObservableObject
{
    public string TableName { get; }
    public string Schema { get; }
    public ObservableCollection<CsvRowDiff> Rows { get; }

    [ObservableProperty]
    private string statusFilter = "All";

    public CsvRowDiffViewModel(string table, string schema, IEnumerable<CsvRowDiff> rows)
    {
        TableName = table;
        Schema = schema;
        Rows = new ObservableCollection<CsvRowDiff>(rows);
    }

    public IEnumerable<string> StatusOptions => new[] { "All", "Added", "Removed", "Modified" };

    public IEnumerable<CsvRowDiff> FilteredRows =>
        StatusFilter == "All" ? Rows : Rows.Where(r => r.Status == StatusFilter);

    partial void OnStatusFilterChanged(string _)
    {
        OnPropertyChanged(nameof(FilteredRows));
    }

    [RelayCommand]
    public void ExportExcel()
    {
        var path = $"Diff_{TableName}.xlsx";
        new ExcelReportService().GenerateKeyDiffReport(path, new CsvDiffResult(), Rows.ToList());
    }

    [RelayCommand]
    public void Close()
    {
        // 将由 Window 绑定实现关闭
    }
}


⸻

七、Views

CsvCompareView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WslPostgresTool.ViewModels">
    <DockPanel>
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Spacing="8">
            <TextBox Width="250" Text="{Binding LeftFolder}" Watermark="Left CSV Folder"/>
            <TextBox Width="250" Text="{Binding RightFolder}" Watermark="Right CSV Folder"/>
            <Button Content="Compare" Command="{Binding CompareCommand}"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding Results}" AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Table" Binding="{Binding FileName}" Width="*"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*"/>
                <DataGridTextColumn Header="Diff Rows" Binding="{Binding DiffRows}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>
    </DockPanel>
</UserControl>

CsvRowDiffWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:WslPostgresTool.Converters"
        Title="{Binding TableName}" Width="1000" Height="600">

    <DockPanel Margin="12">
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8">
            <ComboBox Width="160" Items="{Binding StatusOptions}" SelectedItem="{Binding StatusFilter}"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding FilteredRows}" AutoGenerateColumns="False" IsReadOnly="True">
            <DataGrid.Columns>
                <DataGridTextColumn Header="PK" Binding="{Binding PrimaryKey}" Width="200"/>
                <DataGridTemplateColumn Header="Fields">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ItemsControl ItemsSource="{Binding Cells}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="4" Background="{Binding IsDifferent, Converter={StaticResource DiffColorConverter}}">
                                            <TextBlock>
                                                <Run Text="{Binding Column}"/>
                                                <Run Text=": "/>
                                                <Run Text="{Binding Left}"/>
                                                <Run Text=" → "/>
                                                <Run Text="{Binding Right}"/>
                                            </TextBlock>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
            <Button Content="Export Excel" Command="{Binding ExportExcelCommand}"/>
            <Button Content="Close" Command="{Binding CloseCommand}"/>
        </StackPanel>
    </DockPanel>
</Window>


⸻

✅ 以上就是整个 Avalonia 工程结构 + 核心代码，功能包括：
	•	WSL 状态检测
	•	PostgreSQL 连接与主键获取
	•	CSV 文件夹 diff（表级 + 行级）
	•	行级字段差异高亮
	•	Excel 报告导出

⸻

我可以下一步帮你增加“百万行 CSV 流式 UI 虚拟化显示 + DataGrid 行分页”，让这个工具对超大数据集完全不卡顿。

你想让我直接帮你加吗？