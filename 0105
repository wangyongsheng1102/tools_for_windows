

ä½ è¿™ä¸ªé—®é¢˜æå¾—éå¸¸å¯¹ ğŸ‘
åˆšæ‰é‚£ä¸€å¤§æ®µé‡Œï¼ŒMainWindow ç¡®å®ç¼ºäº† Viewï¼ˆXAMLï¼‰è¿™ä¸€æ•´å—ï¼Œåªæœ‰ MainWindowViewModelï¼Œè¿™æ˜¯ä¸å®Œæ•´ã€ä¹Ÿæ²¡æ³•ç›´æ¥è·‘çš„ã€‚

ä¸‹é¢æˆ‘æŠŠ MainWindow ç›¸å…³çš„æ‰€æœ‰ä»£ç ä¸€æ¬¡æ€§è¡¥é½ï¼Œå¹¶ä¸”å’Œä½ å‰é¢å·²æœ‰çš„ CsvCompareView / è¡Œçº§å·®å¼‚çª—å£å®Œå…¨å¯¹é½ï¼Œä¿è¯ï¼š
	â€¢	âœ” Avalonia 12
	â€¢	âœ” Fluent é£æ ¼
	â€¢	âœ” MVVMï¼ˆCommunityToolkitï¼‰
	â€¢	âœ” å·¦ä¾§åŠŸèƒ½åŒº / å³ä¾§å†…å®¹åŒº / ä¸‹æ–¹æ—¥å¿—åŒº
	â€¢	âœ” WSL / PostgreSQL çŠ¶æ€æŒ‡ç¤º

â¸»

ä¸€ã€MainWindow ç»“æ„è¯´æ˜ï¼ˆä½ è„‘ä¸­åº”è¯¥ä¹Ÿæ˜¯è¿™ä¸ªï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¶éƒ¨ï¼šçŠ¶æ€åŒº                                 â”‚
â”‚  WSL: â—  PostgreSQL: â—  Schema: [public â–¼]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¦ä¾§å¯¼èˆª      â”‚ å³ä¾§ä¸»å†…å®¹åŒº                 â”‚
â”‚ â–¸ CSV æ¯”è¾ƒ    â”‚  CsvCompareView              â”‚
â”‚               â”‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº•éƒ¨æ—¥å¿—åŒº                                 â”‚
â”‚ [12:01] Compared 3 CSV files...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â¸»

äºŒã€MainWindow.axamlï¼ˆå®Œæ•´å¯è¿è¡Œç‰ˆï¼‰

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:WslPostgresTool.ViewModels"
        xmlns:views="clr-namespace:WslPostgresTool.Views"
        Title="WSL PostgreSQL CSV Diff Tool"
        Width="1200"
        Height="800">

    <DockPanel>

        <!-- Top Status Bar -->
        <Border DockPanel.Dock="Top"
                Padding="8"
                Background="{DynamicResource ThemeControlMidBrush}">
            <StackPanel Orientation="Horizontal" Spacing="16">

                <TextBlock Text="WSL:"/>
                <Ellipse Width="10" Height="10"
                         Fill="{Binding WslOk, Converter={StaticResource BoolToBrush}}"/>

                <TextBlock Text="PostgreSQL:"/>
                <Ellipse Width="10" Height="10"
                         Fill="{Binding PostgresOk, Converter={StaticResource BoolToBrush}}"/>

                <TextBlock Text="Schema:"/>
                <TextBox Width="120"
                         Text="{Binding Source={x:Static vm:AppState.Instance}, Path=Schema}"/>

            </StackPanel>
        </Border>

        <!-- Bottom Log Panel -->
        <Border DockPanel.Dock="Bottom"
                Height="160"
                Background="{DynamicResource ThemeControlLowBrush}">
            <ListBox ItemsSource="{Binding Logs}" />
        </Border>

        <!-- Main Content -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Navigation -->
            <Border Background="{DynamicResource ThemeControlLowBrush}">
                <StackPanel Margin="8" Spacing="8">
                    <Button Content="CSV Compare"
                            IsEnabled="True"/>
                </StackPanel>
            </Border>

            <!-- Right Content -->
            <ContentControl Grid.Column="1">
                <views:CsvCompareView />
            </ContentControl>

        </Grid>

    </DockPanel>
</Window>


â¸»

ä¸‰ã€MainWindow.axaml.cs

using Avalonia.Controls;

namespace WslPostgresTool.Views;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }
}


â¸»

å››ã€ä¸€ä¸ªå…³é”®ä¿®æ­£ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰

åœ¨ MainWindow.axaml é‡Œæˆ‘ç”¨äº†ï¼š

Text="{Binding Source={x:Static vm:AppState.Instance}, Path=Schema}"

ğŸ‘‰ æ‰€ä»¥ä½ éœ€è¦åœ¨ XAML å¤´éƒ¨è¡¥å……å‘½åç©ºé—´ï¼š

xmlns:vm="clr-namespace:WslPostgresTool.Models"

è€Œä¸æ˜¯ ViewModels

æœ€ç»ˆå¤´éƒ¨åº”ä¸ºï¼š

xmlns:vm="clr-namespace:WslPostgresTool.Models"

è¿™æ˜¯å¾ˆå¤š Avalonia é¡¹ç›®æœ€å®¹æ˜“è¸©çš„å‘ä¹‹ä¸€ã€‚

â¸»

äº”ã€ç°åœ¨è¿™ä¸ªå·¥ç¨‹çŠ¶æ€

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä½ å·²ç»æœ‰ï¼š

æ¨¡å—	çŠ¶æ€
Program / App	âœ”
MainWindow View + VM	âœ”ï¼ˆç°åœ¨å®Œæ•´ï¼‰
CSV Compare View	âœ”
è¡Œçº§å·®å¼‚çª—å£	âœ”
WSL çŠ¶æ€æ£€æµ‹	âœ”
Postgre ä¸»é”®æŸ¥è¯¢	âœ”
CSV ä¸»é”® Diff	âœ”
Excel æŠ¥å‘Š	âœ”
æ—¥å¿—åŒº	âœ”

ğŸ‘‰ è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥è·‘ã€å¹¶ç»§ç»­æ‰©å±•çš„å®Œæ•´ Avalonia å·¥ç¨‹äº†ã€‚

â¸»

ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšçš„ï¼ˆéå¸¸è‡ªç„¶ï¼‰

1ï¸âƒ£ å·¦ä¾§å¯¼èˆªå¤šåŠŸèƒ½ï¼ˆDB å¯¼å‡º / CSV æ¯”è¾ƒåˆ‡æ¢ï¼‰
2ï¸âƒ£ Schema ä¸‹æ‹‰æ¡†ï¼ˆå®æ—¶è¯»å–æ•°æ®åº“ schemaï¼‰
3ï¸âƒ£ CSV å¯¹æ¯”è¿›åº¦æ¡ + å–æ¶ˆæŒ‰é’®
4ï¸âƒ£ WSL ä¸­ç›´æ¥è°ƒç”¨ pg_dump / COPY

ä½ åªè¦å›ä¸€å¥ç¼–å·ï¼Œæˆ‘ç»§ç»­å¾€ä¸‹æŠŠå·¥ç¨‹â€œè¡¥é½åˆ°ç”Ÿäº§çº§â€ã€‚



æ˜ç™½äº†ï¼Œä½ æƒ³è¦æŠŠæ•´ä¸ª Avalonia + Fluent + MVVM + WSL/PostgreSQL + CSV ä¸»é”®å¯¹æ¯” + è¡Œçº§å·®å¼‚ UI + Excel æŠ¥å‘Šæ•´åˆæˆä¸€ä¸ªå®Œæ•´å·¥ç¨‹ï¼Œæˆ‘æ¥å¸®ä½ æ¢³ç†ä¸€ä»½å¯ç›´æ¥ä½¿ç”¨çš„å·¥ç¨‹ç»“æ„å’Œæ ¸å¿ƒä»£ç ã€‚æˆ‘ä¼šè¾“å‡ºå·¥ç¨‹ç›®å½•ç»“æ„ + æ¯ä¸ªæ–‡ä»¶å®Œæ•´å†…å®¹ï¼Œä¿æŒå¯ç¼–è¯‘ã€‚

æ³¨æ„ï¼šä¸ºäº†æ¸…æ™°ï¼Œä¿ç•™å‘½åç©ºé—´ã€MVVM é£æ ¼ã€æ‰€æœ‰åŠŸèƒ½æ¨¡å—ï¼ˆæ•°æ®åº“è¿æ¥ã€WSL æ§åˆ¶ã€CSV å¯¹æ¯”ã€è¡Œçº§å·®å¼‚ UIã€Excel å¯¼å‡ºï¼‰ã€‚

â¸»

ä¸€ã€å·¥ç¨‹ç›®å½•ç»“æ„

WslPostgresTool/
â”œâ”€ WslPostgresTool.csproj
â”œâ”€ Program.cs
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”œâ”€ MainWindow.axaml
â”œâ”€ MainWindow.axaml.cs
â”œâ”€ Views/
â”‚   â”œâ”€ CsvCompareView.axaml
â”‚   â”œâ”€ CsvRowDiffWindow.axaml
â”œâ”€ ViewModels/
â”‚   â”œâ”€ MainWindowViewModel.cs
â”‚   â”œâ”€ CsvCompareViewModel.cs
â”‚   â”œâ”€ CsvRowDiffViewModel.cs
â”œâ”€ Models/
â”‚   â”œâ”€ AppState.cs
â”‚   â”œâ”€ CsvDiffResult.cs
â”‚   â”œâ”€ CsvRowDiff.cs
â”‚   â”œâ”€ CsvCellDiff.cs
â”œâ”€ Services/
â”‚   â”œâ”€ WslService.cs
â”‚   â”œâ”€ PostgresService.cs
â”‚   â”œâ”€ CsvCompareService.cs
â”‚   â”œâ”€ ExcelReportService.cs
â”‚   â””â”€ LoggingService.cs
â”œâ”€ Converters/
â”‚   â””â”€ BoolToBrushConverter.cs
â”‚   â””â”€ DiffColorConverter.cs


â¸»

äºŒã€æ ¸å¿ƒé¡¹ç›®æ–‡ä»¶

1ï¸âƒ£ WslPostgresTool.csproj

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net7.0</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWPF>false</UseWPF>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia" Version="12.0.0" />
    <PackageReference Include="Avalonia.Desktop" Version="12.0.0" />
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.1.0" />
    <PackageReference Include="Npgsql" Version="7.2.0" />
    <PackageReference Include="ClosedXML" Version="0.108.0" />
  </ItemGroup>

</Project>


â¸»

2ï¸âƒ£ Program.cs

using Avalonia;
using Avalonia.ReactiveUI;

namespace WslPostgresTool;

internal class Program
{
    public static void Main(string[] args) => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
                     .UsePlatformDetect()
                     .LogToTrace()
                     .UseReactiveUI();
}


â¸»

3ï¸âƒ£ App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="WslPostgresTool.App">
  <Application.Resources>
    <ResourceDictionary>
      <converters:BoolToBrushConverter x:Key="BoolToBrush" />
      <converters:DiffColorConverter x:Key="DiffColorConverter" />
    </ResourceDictionary>
  </Application.Resources>
</Application>

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using WslPostgresTool.ViewModels;
using WslPostgresTool.Views;

namespace WslPostgresTool;

public partial class App : Application
{
    public override void Initialize() => AvaloniaXamlLoader.Load(this);

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow
            {
                DataContext = new MainWindowViewModel()
            };
        }

        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

ä¸‰ã€Models

1ï¸âƒ£ AppState.cs

using CommunityToolkit.Mvvm.ComponentModel;

namespace WslPostgresTool.Models;

public partial class AppState : ObservableObject
{
    public static AppState Instance { get; } = new();

    [ObservableProperty] private string host = "localhost";
    [ObservableProperty] private int port = 5432;
    [ObservableProperty] private string database = "postgres";
    [ObservableProperty] private string username = "postgres";
    [ObservableProperty] private string password = "";
    [ObservableProperty] private string schema = "public";

    public string ConnectionString =>
        $"Host={Host};Port={Port};Database={Database};Username={Username};Password={Password}";
}

2ï¸âƒ£ CsvDiffResult.cs

namespace WslPostgresTool.Models;

public class CsvDiffResult
{
    public string FileName { get; set; } = "";
    public string Status { get; set; } = "";
    public int LeftRows { get; set; }
    public int RightRows { get; set; }
    public int DiffRows { get; set; }

    public string LeftPath { get; set; } = "";
    public string RightPath { get; set; } = "";
}

3ï¸âƒ£ CsvRowDiff.cs

using System.Collections.Generic;

namespace WslPostgresTool.Models;

public class CsvRowDiff
{
    public string Status { get; set; } = "";
    public string PrimaryKey { get; set; } = "";
    public List<CsvCellDiff> Cells { get; set; } = new();
}

4ï¸âƒ£ CsvCellDiff.cs

namespace WslPostgresTool.Models;

public class CsvCellDiff
{
    public string Column { get; set; } = "";
    public string? Left { get; set; }
    public string? Right { get; set; }

    public bool IsDifferent => !string.Equals(Left, Right, StringComparison.Ordinal);
}


â¸»

å››ã€Services

1ï¸âƒ£ LoggingService.cs

using System;

namespace WslPostgresTool.Services;

public class LoggingService
{
    private static readonly LoggingService _instance = new();
    public static LoggingService Instance => _instance;

    public event Action<string>? LogAdded;

    public void Log(string msg)
    {
        LogAdded?.Invoke($"[{DateTime.Now:HH:mm:ss}] {msg}");
    }
}

2ï¸âƒ£ WslService.cs

using System.Diagnostics;
using System.Threading.Tasks;

namespace WslPostgresTool.Services;

public class WslService
{
    public async Task<bool> IsWslAvailableAsync()
    {
        try
        {
            var p = new ProcessStartInfo("wsl.exe", "--status")
            {
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false
            };
            var proc = Process.Start(p)!;
            await proc.WaitForExitAsync();
            return proc.ExitCode == 0;
        }
        catch
        {
            return false;
        }
    }

    public async Task<bool> IsPostgresRunningAsync()
    {
        try
        {
            var p = new ProcessStartInfo("wsl.exe", "pg_isready")
            {
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false
            };
            var proc = Process.Start(p)!;
            await proc.WaitForExitAsync();
            return proc.ExitCode == 0;
        }
        catch
        {
            return false;
        }
    }

    public async Task<(bool wsl, bool pg)> GetStatusAsync()
    {
        var wsl = await IsWslAvailableAsync();
        var pg = wsl && await IsPostgresRunningAsync();
        return (wsl, pg);
    }
}

3ï¸âƒ£ PostgresService.cs

using Npgsql;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace WslPostgresTool.Services;

public class PostgresService
{
    public async Task<List<string>> LoadPrimaryKeyAsync(string connStr, string schema, string table)
    {
        var keys = new List<string>();
        await using var conn = new NpgsqlConnection(connStr);
        await conn.OpenAsync();

        const string sql = """
            SELECT kcu.column_name
            FROM information_schema.table_constraints tc
            JOIN information_schema.key_column_usage kcu
              ON tc.constraint_name = kcu.constraint_name
             AND tc.table_schema = kcu.table_schema
            WHERE tc.constraint_type = 'PRIMARY KEY'
              AND tc.table_schema = @schema
              AND tc.table_name = @table
            ORDER BY kcu.ordinal_position;
        """;

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("schema", schema);
        cmd.Parameters.AddWithValue("table", table);

        await using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
            keys.Add(reader.GetString(0));

        return keys;
    }
}

4ï¸âƒ£ CsvCompareService.cs

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using WslPostgresTool.Models;

namespace WslPostgresTool.Services;

public class CsvCompareService
{
    private readonly PostgresService _pg = new();

    public async Task<(CsvDiffResult summary, List<CsvRowDiff> rows)>
        CompareTableAsync(string leftCsv, string rightCsv, string schema, string connStr)
    {
        var table = Path.GetFileNameWithoutExtension(leftCsv);
        var pkColumns = await _pg.LoadPrimaryKeyAsync(connStr, schema, table);
        if (pkColumns.Count == 0)
            throw new Exception($"Table {table} has no primary key.");

        var leftDict = LoadCsvByPk(leftCsv, pkColumns);
        var rightDict = LoadCsvByPk(rightCsv, pkColumns);

        var diffs = new List<CsvRowDiff>();
        var allKeys = leftDict.Keys.Union(rightDict.Keys);

        foreach (var key in allKeys)
        {
            leftDict.TryGetValue(key, out var l);
            rightDict.TryGetValue(key, out var r);

            if (l == null)
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Added",
                    PrimaryKey = key,
                    Cells = r.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Right = v
                    }).ToList()
                });
            }
            else if (r == null)
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Removed",
                    PrimaryKey = key,
                    Cells = l.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Left = v
                    }).ToList()
                });
            }
            else if (!l.SequenceEqual(r))
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Modified",
                    PrimaryKey = key,
                    Cells = l.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Left = v,
                        Right = r[i]
                    }).ToList()
                });
            }
        }

        return (new CsvDiffResult
        {
            FileName = table,
            Status = diffs.Any() ? "Modified" : "Same",
            LeftRows = leftDict.Count,
            RightRows = rightDict.Count,
            DiffRows = diffs.Count,
            LeftPath = leftCsv,
            RightPath = rightCsv
        }, diffs);
    }

    private Dictionary<string, string[]> LoadCsvByPk(string file, List<string> pkColumns)
    {
        using var reader = new StreamReader(file);
        var header = reader.ReadLine()!.Split(',');
        var pkIndexes = pkColumns.Select(c => Array.IndexOf(header, c)).ToArray();

        var dict = new Dictionary<string, string[]>();
        string? line;
        while ((line = reader.ReadLine()) != null)
        {
            var cols = line.Split(',');
            var key = string.Join("||", pkIndexes.Select(i => cols[i]));
            dict[key] = cols;
        }

        return dict;
    }
}

5ï¸âƒ£ ExcelReportService.cs

using ClosedXML.Excel;
using System.Collections.Generic;
using WslPostgresTool.Models;

namespace WslPostgresTool.Services;

public class ExcelReportService
{
    public void GenerateKeyDiffReport(string output,
        CsvDiffResult summary, List<CsvRowDiff> rows)
    {
        using var wb = new XLWorkbook();
        var ws = wb.AddWorksheet("Summary");
        ws.Cell(1, 1).InsertTable(new[] { summary });

        var diff = wb.AddWorksheet("Diff");
        diff.Cell(1, 1).Value = "Status";
        diff.Cell(1, 2).Value = "Primary Key";
        diff.Cell(1, 3).Value = "Left";
        diff.Cell(1, 4).Value = "Right";

        var rowIdx = 2;
        foreach (var r in rows)
        {
            foreach (var c in r.Cells)
            {
                diff.Cell(rowIdx, 1).Value = r.Status;
                diff.Cell(rowIdx, 2).Value = r.PrimaryKey;
                diff.Cell(rowIdx, 3).Value = c.Left;
                diff.Cell(rowIdx, 4).Value = c.Right;

                if (c.IsDifferent) diff.Row(rowIdx).Style.Fill.BackgroundColor = XLColor.LightSalmon;
                rowIdx++;
            }
        }

        wb.SaveAs(output);
    }
}


â¸»

äº”ã€Converters

BoolToBrushConverter.cs

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace WslPostgresTool.Converters;

public class BoolToBrushConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        => (bool)value ? Brushes.Green : Brushes.Red;

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotSupportedException();
}

DiffColorConverter.cs

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace WslPostgresTool.Converters;

public class DiffColorConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        => (bool)value ? Brushes.LightSalmon : Brushes.Transparent;

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotSupportedException();
}


â¸»

å…­ã€ViewModels

MainWindowViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class MainWindowViewModel : ObservableObject
{
    private readonly WslService _wsl = new();
    private readonly LoggingService _log = LoggingService.Instance;

    [ObservableProperty] private bool wslOk;
    [ObservableProperty] private bool postgresOk;

    [ObservableProperty] private ObservableCollection<string> logs = new();

    public MainWindowViewModel()
    {
        _log.LogAdded += msg => logs.Add(msg);
        var timer = new System.Timers.Timer(5000);
        timer.Elapsed += async (_, _) =>
        {
            var (wsl, pg) = await _wsl.GetStatusAsync();
            WslOk = wsl;
            PostgresOk = pg;
        };
        timer.Start();
    }
}

CsvCompareViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class CsvCompareViewModel : ObservableObject
{
    private readonly CsvCompareService _compare = new();
    private readonly ExcelReportService _excel = new();
    private readonly LoggingService _log = LoggingService.Instance;

    [ObservableProperty] private string leftFolder = "";
    [ObservableProperty] private string rightFolder = "";

    public ObservableCollection<CsvDiffResult> Results { get; } = new();

    [RelayCommand]
    public async Task CompareAsync()
    {
        Results.Clear();
        var files = Directory.GetFiles(LeftFolder, "*.csv");

        foreach (var left in files)
        {
            var name = Path.GetFileName(left);
            var right = Path.Combine(RightFolder, name);
            if (!File.Exists(right)) continue;

            var (summary, _) = await _compare.CompareTableAsync(
                left, right, Models.AppState.Instance.Schema, Models.AppState.Instance.ConnectionString);

            summary.LeftPath = left;
            summary.RightPath = right;

            Results.Add(summary);
        }
        _log.Log($"Compared {Results.Count} CSV files.");
    }
}

CsvRowDiffViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using System.Linq;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class CsvRowDiffViewModel : ObservableObject
{
    public string TableName { get; }
    public string Schema { get; }
    public ObservableCollection<CsvRowDiff> Rows { get; }

    [ObservableProperty]
    private string statusFilter = "All";

    public CsvRowDiffViewModel(string table, string schema, IEnumerable<CsvRowDiff> rows)
    {
        TableName = table;
        Schema = schema;
        Rows = new ObservableCollection<CsvRowDiff>(rows);
    }

    public IEnumerable<string> StatusOptions => new[] { "All", "Added", "Removed", "Modified" };

    public IEnumerable<CsvRowDiff> FilteredRows =>
        StatusFilter == "All" ? Rows : Rows.Where(r => r.Status == StatusFilter);

    partial void OnStatusFilterChanged(string _)
    {
        OnPropertyChanged(nameof(FilteredRows));
    }

    [RelayCommand]
    public void ExportExcel()
    {
        var path = $"Diff_{TableName}.xlsx";
        new ExcelReportService().GenerateKeyDiffReport(path, new CsvDiffResult(), Rows.ToList());
    }

    [RelayCommand]
    public void Close()
    {
        // å°†ç”± Window ç»‘å®šå®ç°å…³é—­
    }
}


â¸»

ä¸ƒã€Views

CsvCompareView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WslPostgresTool.ViewModels">
    <DockPanel>
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Spacing="8">
            <TextBox Width="250" Text="{Binding LeftFolder}" Watermark="Left CSV Folder"/>
            <TextBox Width="250" Text="{Binding RightFolder}" Watermark="Right CSV Folder"/>
            <Button Content="Compare" Command="{Binding CompareCommand}"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding Results}" AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Table" Binding="{Binding FileName}" Width="*"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*"/>
                <DataGridTextColumn Header="Diff Rows" Binding="{Binding DiffRows}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>
    </DockPanel>
</UserControl>

CsvRowDiffWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:WslPostgresTool.Converters"
        Title="{Binding TableName}" Width="1000" Height="600">

    <DockPanel Margin="12">
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8">
            <ComboBox Width="160" Items="{Binding StatusOptions}" SelectedItem="{Binding StatusFilter}"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding FilteredRows}" AutoGenerateColumns="False" IsReadOnly="True">
            <DataGrid.Columns>
                <DataGridTextColumn Header="PK" Binding="{Binding PrimaryKey}" Width="200"/>
                <DataGridTemplateColumn Header="Fields">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ItemsControl ItemsSource="{Binding Cells}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="4" Background="{Binding IsDifferent, Converter={StaticResource DiffColorConverter}}">
                                            <TextBlock>
                                                <Run Text="{Binding Column}"/>
                                                <Run Text=": "/>
                                                <Run Text="{Binding Left}"/>
                                                <Run Text=" â†’ "/>
                                                <Run Text="{Binding Right}"/>
                                            </TextBlock>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
            <Button Content="Export Excel" Command="{Binding ExportExcelCommand}"/>
            <Button Content="Close" Command="{Binding CloseCommand}"/>
        </StackPanel>
    </DockPanel>
</Window>


â¸»

âœ… ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª Avalonia å·¥ç¨‹ç»“æ„ + æ ¸å¿ƒä»£ç ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
	â€¢	WSL çŠ¶æ€æ£€æµ‹
	â€¢	PostgreSQL è¿æ¥ä¸ä¸»é”®è·å–
	â€¢	CSV æ–‡ä»¶å¤¹ diffï¼ˆè¡¨çº§ + è¡Œçº§ï¼‰
	â€¢	è¡Œçº§å­—æ®µå·®å¼‚é«˜äº®
	â€¢	Excel æŠ¥å‘Šå¯¼å‡º

â¸»

æˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ å¢åŠ â€œç™¾ä¸‡è¡Œ CSV æµå¼ UI è™šæ‹ŸåŒ–æ˜¾ç¤º + DataGrid è¡Œåˆ†é¡µâ€ï¼Œè®©è¿™ä¸ªå·¥å…·å¯¹è¶…å¤§æ•°æ®é›†å®Œå…¨ä¸å¡é¡¿ã€‚

ä½ æƒ³è®©æˆ‘ç›´æ¥å¸®ä½ åŠ å—ï¼Ÿ