


å¥½ ğŸ‘
é‚£æˆ‘ä»¬ä¸¥æ ¼æŒ‰ä½ ç°åœ¨çš„å·¥ç¨‹èŠ‚å¥æ¥ï¼š
åªåš JSON æŒä¹…åŒ–ï¼Œä¸ç¢° DBã€ä¸ç¢° WSLã€ä¸æ”¹ UI ç»“æ„ã€ä¸æ¨ç¿»ä½ å·²æœ‰é€»è¾‘ã€‚

ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š

DbConfig é¡µé¢åœ¨â€œé‡å¯åº”ç”¨åâ€èƒ½å®Œæ•´æ¢å¤è¿æ¥åˆ—è¡¨ + é€‰ä¸­é¡¹

â¸»

ä¸€ã€æœ¬æ¬¡åªåšè¿™å‡ ä»¶äº‹ï¼ˆèŒƒå›´é”æ­»ï¼‰

âœ… è¦åšï¼š
	â€¢	å®šä¹‰ä¸€ä¸ª JSON å­˜å‚¨æ–‡ä»¶ç»“æ„
	â€¢	å¯åŠ¨æ—¶ Load
	â€¢	ç‚¹å‡» Save æ—¶ Save
	â€¢	æ”¯æŒå¤šæ¡è¿æ¥
	â€¢	æ¢å¤ SelectedConnection

âŒ ä¸åšï¼š
	â€¢	ä¸è‡ªåŠ¨ä¿å­˜
	â€¢	ä¸æ ¡éªŒè¿æ¥
	â€¢	ä¸å¼•å…¥å¤æ‚ Service æ¶æ„
	â€¢	ä¸æ”¹ UI XAML

â¸»

äºŒã€JSON æ–‡ä»¶è®¾è®¡ï¼ˆå…ˆå®šæ­»ï¼‰

ğŸ“ å­˜å‚¨ä½ç½®ï¼ˆå»ºè®®ï¼Œç¨³å®šï¼‰ï¼š

%AppData%/PostgreToolNew/dbconnections.json

ğŸ“„ JSON ç»“æ„ï¼ˆéå¸¸é‡è¦ï¼Œåé¢åˆ«æ”¹ï¼‰ï¼š

{
  "connections": [
    {
      "connectionId": "guid",
      "connectionName": "Local PostgreSQL",
      "host": "localhost",
      "port": 5432,
      "database": "testdb",
      "userId": "postgres",
      "password": "xxx",
      "wslDistributionName": "Ubuntu",
      "isTested": true,
      "lastTestTime": "2026-01-01T12:00:00"
    }
  ],
  "lastSelectedConnectionId": "guid"
}


â¸»

ä¸‰ã€å­˜å‚¨ DTOï¼ˆåªç»™ JSON ç”¨ï¼‰

ğŸ“„ DbConfigStorage.cs

namespace PostgreToolNew.ViewModels;

public class DbConfigStorage
{
    public List<DbConnectionConfig> Connections { get; set; } = new();
    public string? LastSelectedConnectionId { get; set; }
}


â¸»

å››ã€JSON å­˜å–å·¥å…·ç±»ï¼ˆæç®€ã€ç¨³å®šï¼‰

ğŸ“„ DbConfigStorageService.cs

using System.Text.Json;

namespace PostgreToolNew.ViewModels;

public static class DbConfigStorageService
{
    private static readonly string Folder =
        Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "PostgreToolNew");

    private static readonly string FilePath =
        Path.Combine(Folder, "dbconnections.json");

    public static DbConfigStorage Load()
    {
        try
        {
            if (!File.Exists(FilePath))
                return new DbConfigStorage();

            var json = File.ReadAllText(FilePath);
            return JsonSerializer.Deserialize<DbConfigStorage>(json)
                   ?? new DbConfigStorage();
        }
        catch
        {
            return new DbConfigStorage();
        }
    }

    public static void Save(DbConfigStorage storage)
    {
        Directory.CreateDirectory(Folder);

        var json = JsonSerializer.Serialize(
            storage,
            new JsonSerializerOptions
            {
                WriteIndented = true
            });

        File.WriteAllText(FilePath, json);
    }
}

ğŸ‘‰ ç‰¹ç‚¹ï¼š
	â€¢	ä¸æŠ›å¼‚å¸¸
	â€¢	ä¸ä¾èµ– Service å®¹å™¨
	â€¢	æ–¹ä¾¿ä½ ç°åœ¨è°ƒè¯•

â¸»

äº”ã€æ¥å…¥åˆ° DbConfigViewModelï¼ˆå…³é”®ï¼‰

1ï¸âƒ£ æ„é€ å‡½æ•°ä¸­ï¼šæ›¿æ¢ Stub æ•°æ®åŠ è½½

ä½ ç°åœ¨æ„é€ å‡½æ•°é‡Œæœ‰ï¼š

InitializeState();
LoadStubData();

ğŸ‘‰ æ”¹æˆï¼š

InitializeState();
LoadFromStorage();


â¸»

2ï¸âƒ£ å®ç° LoadFromStorageï¼ˆé‡ç‚¹ï¼‰

private void LoadFromStorage()
{
    var storage = DbConfigStorageService.Load();

    Connections.Clear();
    foreach (var conn in storage.Connections)
    {
        Connections.Add(conn);
    }

    if (!string.IsNullOrEmpty(storage.LastSelectedConnectionId))
    {
        SelectedConnection = Connections
            .FirstOrDefault(c => c.ConnectionId == storage.LastSelectedConnectionId);
    }
}

âš ï¸ æ³¨æ„ï¼š
	â€¢	å¿…é¡»æœ€åæ‰è®¾ç½® SelectedConnection
	â€¢	è¿™æ · OnSelectedConnectionChanged ä¼šè‡ªåŠ¨è·‘
	â€¢	UI çŠ¶æ€è‡ªç„¶æ¢å¤

â¸»

3ï¸âƒ£ SaveCommandï¼šçœŸæ­£å®ç°ä¿å­˜

private void OnSave()
{
    if (SelectedConnection == null)
        return;

    var storage = new DbConfigStorage
    {
        Connections = Connections.ToList(),
        LastSelectedConnectionId = SelectedConnection.ConnectionId
    };

    DbConfigStorageService.Save(storage);

    CanSave = false;
}


â¸»

å…­ã€ä½ ç°åœ¨å¯ä»¥éªŒè¯çš„è¡Œä¸ºï¼ˆéªŒæ”¶æ¸…å•ï¼‰

è¯·ä½  æŒ‰è¿™ä¸ªé¡ºåºæµ‹è¯•ï¼š
	1.	å¯åŠ¨ç¨‹åºï¼ˆæ—  jsonï¼‰
	â€¢	åˆ—è¡¨ä¸ºç©º âœ…
	2.	Add ä¸€ä¸ªè¿æ¥ï¼ˆå“ªæ€•å­—æ®µæ˜¯ç©ºï¼‰
	3.	æ‰‹åŠ¨é€‰ä¸­å®ƒ
	4.	ç‚¹å‡» Save
	5.	å…³é—­ç¨‹åº
	6.	å†å¯åŠ¨

ä½ åº”è¯¥çœ‹åˆ°ï¼š
	â€¢	è¿æ¥åˆ—è¡¨æ¢å¤ âœ…
	â€¢	ä¸Šæ¬¡é€‰ä¸­çš„è¿æ¥è‡ªåŠ¨é€‰ä¸­ âœ…
	â€¢	å³ä¾§è¾“å…¥æ¡†å¯ç”¨çŠ¶æ€æ­£ç¡® âœ…

â¸»

ä¸ƒã€å¸¸è§é—®é¢˜ï¼ˆä½ å¤§æ¦‚ç‡ä¼šé—®ï¼‰

â“ ä¸ºä»€ä¹ˆä¸è‡ªåŠ¨ä¿å­˜ï¼Ÿ

å› ä¸ºï¼š
	â€¢	ç¼–è¾‘ä¸­çŠ¶æ€ â‰  å¯ä¿å­˜çŠ¶æ€
	â€¢	Test ä¹‹å‰ä¸èƒ½ä¿å­˜
	â€¢	CSV é¡µé¢ä¼šä¾èµ– â€œTested == trueâ€

ğŸ‘‰ æ‰‹åŠ¨ Save æ˜¯æ­£ç¡®è®¾è®¡

â¸»

â“ ConnectionName æ”¹äº†ï¼ŒListBox ä¸åˆ·æ–°ï¼Ÿ

è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œå±äºä¸‹ä¸€é˜¶æ®µï¼ˆItemViewModelï¼‰

ç°åœ¨å…ˆä¸åŠ¨ã€‚

â¸»

å…«ã€ä¸‹ä¸€æ­¥ï¼ˆéå¸¸æ˜ç¡®ï¼‰

åœ¨ JSON æŒä¹…åŒ–å®Œæˆåï¼Œä¸‹ä¸€æ­¥åªèƒ½æ˜¯ï¼š

ğŸ‘‰ æ¥å…¥ WslServiceï¼ŒåŠ è½½ Distribution åˆ—è¡¨

å› ä¸ºï¼š
	â€¢	JSON å·²ç»èƒ½æ¢å¤ WslDistributionName
	â€¢	ç°åœ¨æ­£å¥½å¯ä»¥éªŒè¯ ComboBox é€‰ä¸­é—®é¢˜

å¦‚æœä½ åŒæ„ï¼Œç›´æ¥å›ä¸€å¥ï¼š

â€œä¸‹ä¸€æ­¥åš WSL åˆ—è¡¨åŠ è½½â€

æˆ‘ä¼šåœ¨ä¸ç ´åä½ ç°åœ¨ç»“æ„çš„å‰æä¸‹æ¥ç€å†™ã€‚




å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬åªåšâ€œå·¥ç¨‹å¤§æ¡† + DbConfig é¡µé¢éª¨æ¶â€ï¼Œ
ä¸å¼•å…¥ Serviceã€ä¸å¼•å…¥çœŸå®é€»è¾‘ã€ä¸è§£å†³ CSV / Compareï¼Œç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š

PostgreToolNew èƒ½ç¼–è¯‘ã€èƒ½å¯åŠ¨ã€Tab èƒ½åˆ‡ã€DbConfig é¡µé¢èƒ½ç»‘å®šã€çŠ¶æ€ä¸ä¹±

ä¸‹é¢ç»™ä½ çš„æ˜¯ â€œå¯ç›´æ¥æ–°å»ºå·¥ç¨‹åæ•´ä½“ç²˜è¿›å»çš„æœ€å°å¯è¿è¡Œéª¨æ¶â€ï¼Œä¸¥æ ¼åŸºäºä½ åˆšæ‰å®šä¸‹æ¥çš„ æ•°æ®ç»“æ„ + ViewModel åˆåŒã€‚

â¸»

ä¸€ã€å·¥ç¨‹ç»“æ„ï¼ˆæœ€ç»ˆå†»ç»“ç‰ˆ Â· ç¬¬ä¸€é˜¶æ®µï¼‰

PostgreToolNew
â”‚
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”‚
â”œâ”€ MainWindow.axaml
â”œâ”€ MainWindow.axaml.cs
â”‚
â”œâ”€ Controls
â”‚   â””â”€ DbConfigView.axaml
â”‚
â”œâ”€ ViewModels
â”‚   â”œâ”€ MainWindowViewModel.cs
â”‚   â”œâ”€ DbConfigViewModel.cs
â”‚   â””â”€ DbConnectionConfig.cs
â”‚
â””â”€ Program.cs


â¸»

äºŒã€Program.csï¼ˆæ ‡å‡† Avaloniaï¼‰

using Avalonia;
using Avalonia.ReactiveUI;
using System;

namespace PostgreToolNew;

class Program
{
    public static void Main(string[] args)
        => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .UseReactiveUI()
            .LogToTrace();
}


â¸»

ä¸‰ã€App.axaml / App.axaml.cs

App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="PostgreToolNew.App">
    <Application.Styles>
        <FluentTheme Mode="Light"/>
    </Application.Styles>
</Application>

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;

namespace PostgreToolNew;

public partial class App : Application
{
    public override void Initialize()
    {
        AvaloniaXamlLoader.Load(this);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow
            {
                DataContext = new ViewModels.MainWindowViewModel()
            };
        }

        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

å››ã€MainWindowï¼ˆåªè´Ÿè´£â€œå¤§æ¡† + Tabâ€ï¼‰

MainWindowViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;

namespace PostgreToolNew.ViewModels;

public class MainWindowViewModel : ObservableObject
{
    public DbConfigViewModel DbConfigVM { get; }

    public MainWindowViewModel()
    {
        DbConfigVM = new DbConfigViewModel();
    }
}


â¸»

MainWindow.axamlï¼ˆåªç®¡å¸ƒå±€ï¼Œä¸ç®¡ä¸šåŠ¡ï¼‰

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:PostgreToolNew.ViewModels"
        xmlns:views="clr-namespace:PostgreToolNew.Controls"
        x:Class="PostgreToolNew.MainWindow"
        Width="900"
        Height="600"
        Title="PostgreToolNew"
        x:DataType="vm:MainWindowViewModel">

    <TabControl>
        <!-- Tab 1 : DB Config -->
        <TabItem Header="DB Config">
            <views:DbConfigView DataContext="{Binding DbConfigVM}" />
        </TabItem>

        <!-- Tab 2 : Import / Export (placeholder) -->
        <TabItem Header="CSV Import / Export">
            <TextBlock Margin="20"
                       Text="CSV Import / Export - TODO" />
        </TabItem>

        <!-- Tab 3 : Compare (placeholder) -->
        <TabItem Header="CSV Compare">
            <TextBlock Margin="20"
                       Text="CSV Compare - TODO" />
        </TabItem>
    </TabControl>
</Window>


â¸»

äº”ã€DbConfig æ•°æ®ç»“æ„ï¼ˆä¸ä½ åˆšåˆšç¡®è®¤çš„ä¸€è‡´ï¼‰

DbConnectionConfig.cs

namespace PostgreToolNew.ViewModels;

public class DbConnectionConfig
{
    public string ConnectionId { get; set; } = Guid.NewGuid().ToString();
    public string ConnectionName { get; set; } = "";

    public string Host { get; set; } = "";
    public int Port { get; set; } = 5432;
    public string Database { get; set; } = "";
    public string UserId { get; set; } = "";
    public string Password { get; set; } = "";

    public string WslDistributionName { get; set; } = "";

    public bool IsTested { get; set; }
    public DateTime? LastTestTime { get; set; }
}


â¸»

å…­ã€DbConfigViewModelï¼ˆå†»ç»“åˆåŒç‰ˆï¼‰

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;

namespace PostgreToolNew.ViewModels;

public partial class DbConfigViewModel : ObservableObject
{
    public ObservableCollection<DbConnectionConfig> Connections { get; } = new();

    [ObservableProperty]
    private DbConnectionConfig? selectedConnection;

    public ObservableCollection<string> WslDistributions { get; } = new();

    [ObservableProperty] private bool isDetailEnabled;
    [ObservableProperty] private bool canAdd;
    [ObservableProperty] private bool canRemove;
    [ObservableProperty] private bool canTest;
    [ObservableProperty] private bool canSave;

    [ObservableProperty]
    private string testResultMessage = "";

    public IRelayCommand AddCommand { get; }
    public IRelayCommand RemoveCommand { get; }
    public IAsyncRelayCommand TestCommand { get; }
    public IRelayCommand SaveCommand { get; }

    public DbConfigViewModel()
    {
        AddCommand = new RelayCommand(OnAdd);
        RemoveCommand = new RelayCommand(OnRemove);
        TestCommand = new AsyncRelayCommand(OnTestAsync);
        SaveCommand = new RelayCommand(OnSave);

        InitializeState();
        LoadStubData();
    }

    private void InitializeState()
    {
        IsDetailEnabled = false;
        CanAdd = true;
        CanRemove = false;
        CanTest = false;
        CanSave = false;
        TestResultMessage = "";
    }

    partial void OnSelectedConnectionChanged(
        DbConnectionConfig? oldValue,
        DbConnectionConfig? newValue)
    {
        if (newValue == null)
        {
            InitializeState();
            return;
        }

        IsDetailEnabled = true;
        CanRemove = true;
        CanTest = true;
        CanSave = newValue.IsTested;

        TestResultMessage = newValue.IsTested
            ? $"Last tested at {newValue.LastTestTime}"
            : "Not tested";
    }

    private void LoadStubData()
    {
        Connections.Add(new DbConnectionConfig
        {
            ConnectionName = "Local PostgreSQL",
            Host = "localhost",
            Database = "testdb",
            UserId = "postgres",
            WslDistributionName = "Ubuntu",
            IsTested = true,
            LastTestTime = DateTime.Now
        });
    }

    private void OnAdd() { }
    private void OnRemove() { }
    private async Task OnTestAsync() => await Task.Delay(300);
    private void OnSave() { }
}


â¸»

ä¸ƒã€DbConfigViewï¼ˆåªåšç»‘å®šéªŒè¯ï¼Œä¸å†™é€»è¾‘ï¼‰

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PostgreToolNew.ViewModels"
             x:Class="PostgreToolNew.Controls.DbConfigView"
             x:DataType="vm:DbConfigViewModel">

    <Grid ColumnDefinitions="220,*" Margin="10">
        <!-- Left: connection list -->
        <StackPanel>
            <ListBox ItemsSource="{Binding Connections}"
                     SelectedItem="{Binding SelectedConnection}" />

            <Button Content="Add"
                    Margin="0,10,0,0"
                    Command="{Binding AddCommand}"
                    IsEnabled="{Binding CanAdd}" />

            <Button Content="Remove"
                    Margin="0,5,0,0"
                    Command="{Binding RemoveCommand}"
                    IsEnabled="{Binding CanRemove}" />
        </StackPanel>

        <!-- Right: detail -->
        <StackPanel Grid.Column="1"
                    Margin="10,0,0,0"
                    IsEnabled="{Binding IsDetailEnabled}">
            <TextBox Text="{Binding SelectedConnection.ConnectionName}" />
            <TextBox Text="{Binding SelectedConnection.Host}" />
            <TextBox Text="{Binding SelectedConnection.Database}" />
            <TextBox Text="{Binding SelectedConnection.UserId}" />
            <TextBox Text="{Binding SelectedConnection.Password}" />

            <ComboBox ItemsSource="{Binding WslDistributions}"
                      SelectedItem="{Binding SelectedConnection.WslDistributionName}" />

            <TextBlock Margin="0,10,0,0"
                       Text="{Binding TestResultMessage}" />

            <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                <Button Content="Test"
                        Command="{Binding TestCommand}"
                        IsEnabled="{Binding CanTest}" />
                <Button Content="Save"
                        Margin="10,0,0,0"
                        Command="{Binding SaveCommand}"
                        IsEnabled="{Binding CanSave}" />
            </StackPanel>
        </StackPanel>
    </Grid>
</UserControl>


â¸»

å…«ã€ä½ ç°åœ¨åº”è¯¥çœ‹åˆ°çš„ç»“æœï¼ˆè¿™æ˜¯éªŒæ”¶æ ‡å‡†ï¼‰

å¯åŠ¨åï¼š
	â€¢	âœ… çª—å£æ­£å¸¸å¯åŠ¨
	â€¢	âœ… ä¸‰ä¸ª Tab æ­£å¸¸åˆ‡æ¢
	â€¢	âœ… DbConfig åˆ—è¡¨èƒ½é€‰ä¸­
	â€¢	âœ… å³ä¾§ Enable / Disable æ­£ç¡®å˜åŒ–
	â€¢	âœ… æ²¡æœ‰ä»»ä½• Service / WSL / DB ä»£ç 

â¸»

ä¸‹ä¸€æ­¥ï¼ˆåªèƒ½é€‰ä¸€ä¸ªï¼‰
	1.	æŠŠ DbConfigView çš„çŠ¶æ€æœºæ•´ç†æˆâ€œè§„åˆ™è¡¨â€
	2.	å¼•å…¥ JSON æŒä¹…åŒ–ï¼ˆä»ç„¶ä¸è¿ DBï¼‰
	3.	å¼€å§‹å†»ç»“ CsvImportExportViewModel

ä½ é€‰ï¼Œæˆ‘ç»§ç»­ã€‚

æ˜ç™½äº†ï¼Œæˆ‘å¸®ä½ ç”Ÿæˆä¸€ä¸ª å®Œå…¨ä½¿ç”¨ Avalonia å†…ç½®æ§ä»¶çš„ Page2ï¼ˆCsvExportView + CsvExportViewModelï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ç»‘å®šåˆ° ä¸»çª—å£ Tab2ï¼Œä½¿ç”¨ç¬¬ä¸€é¡µ DbConfig é…ç½®çš„æ•°æ®åº“ã€‚

â¸»

1ï¸âƒ£ Controls/CsvExportView.xaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PostgreTool.ViewModels"
             x:DataType="vm:CsvExportViewModel">

    <ScrollViewer>
        <StackPanel Margin="10" Spacing="10">

            <!-- Import Section -->
            <StackPanel Spacing="5">
                <TextBlock Text="Import CSV" FontWeight="Bold" FontSize="14"/>
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Content="Select Folder to Import" Command="{Binding ImportFolderCommand}" />
                    <TextBlock Text="{Binding ImportStatus}" VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>

            <!-- Export Section -->
            <StackPanel Spacing="5">
                <TextBlock Text="Export CSV" FontWeight="Bold" FontSize="14"/>
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Content="Load Tables" Command="{Binding LoadTablesCommand}" />
                    <Button Content="Toggle Select All" Command="{Binding ToggleSelectAllCommand}" />
                    <Button Content="Export Selected" Command="{Binding ExportCommand}" />
                </StackPanel>

                <ListBox Items="{Binding TableList}" Margin="0,5,0,0">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:TableItem">
                            <StackPanel Orientation="Horizontal">
                                <CheckBox IsChecked="{Binding IsSelected}" Content="{Binding TableName}" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <TextBlock Text="{Binding ExportStatus}" Margin="0,5,0,0"/>
            </StackPanel>

        </StackPanel>
    </ScrollViewer>
</UserControl>

âœ… ç‰¹ç‚¹ï¼š
	â€¢	å…¨éƒ¨ä½¿ç”¨ Avalonia å†…ç½®æ§ä»¶ï¼šStackPanelã€TextBlockã€Buttonã€ListBoxã€CheckBox
	â€¢	ScrollViewer åŒ…è£¹ï¼Œé˜²æ­¢åˆ—è¡¨è¿‡å¤šæº¢å‡º
	â€¢	ä¸ä½¿ç”¨ WPF GroupBox
	â€¢	åˆ†ç»„é  TextBlock + StackPanel è§†è§‰åŒºåˆ†

â¸»

2ï¸âƒ£ ViewModels/CsvExportViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Npgsql;
using Avalonia.Controls;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic;

namespace PostgreTool.ViewModels
{
    public partial class CsvExportViewModel : ObservableObject
    {
        private readonly DbConnectionConfig _dbConfig;
        private readonly Window _mainWindow;

        public CsvExportViewModel(DbConnectionConfig dbConfig, Window mainWindow)
        {
            _dbConfig = dbConfig;
            _mainWindow = mainWindow;
            TableList = new ObservableCollection<TableItem>();
        }

        [ObservableProperty]
        private ObservableCollection<TableItem> tableList;

        [ObservableProperty]
        private string importStatus;

        [ObservableProperty]
        private string exportStatus;

        [RelayCommand]
        public async Task LoadTablesAsync()
        {
            try
            {
                var tables = await GetTableNamesAsync();
                TableList.Clear();
                foreach (var t in tables)
                    TableList.Add(new TableItem { TableName = t, IsSelected = false });
            }
            catch (System.Exception ex)
            {
                ExportStatus = $"Load tables failed: {ex.Message}";
            }
        }

        [RelayCommand]
        public void ToggleSelectAll()
        {
            bool allSelected = TableList.All(t => t.IsSelected);
            foreach (var t in TableList)
                t.IsSelected = !allSelected;
        }

        [RelayCommand]
        public async Task ExportAsync()
        {
            try
            {
                var folder = await SelectFolderAsync();
                if (string.IsNullOrEmpty(folder)) return;

                foreach (var t in TableList.Where(t => t.IsSelected))
                {
                    var filePath = Path.Combine(folder, $"{t.TableName}.csv");
                    await ExportTableToCsvAsync(t.TableName, filePath);
                }

                ExportStatus = "Export completed.";
            }
            catch (System.Exception ex)
            {
                ExportStatus = $"Export failed: {ex.Message}";
            }
        }

        [RelayCommand]
        public async Task ImportFolderAsync()
        {
            try
            {
                var folder = await SelectFolderAsync();
                if (string.IsNullOrEmpty(folder)) return;

                var csvFiles = Directory.GetFiles(folder, "*.csv");
                using var conn = GetConnection();
                await conn.OpenAsync();

                foreach (var file in csvFiles)
                {
                    var tableName = Path.GetFileNameWithoutExtension(file);

                    var cmdDrop = new NpgsqlCommand($"DROP TABLE IF EXISTS \"{tableName}\";", conn);
                    await cmdDrop.ExecuteNonQueryAsync();

                    var lines = await File.ReadAllLinesAsync(file);
                    if (lines.Length == 0) continue;

                    var headers = lines[0].Split(',');
                    var createSql = $"CREATE TABLE \"{tableName}\" ({string.Join(",", headers.Select(h => $"\"{h}\" TEXT"))});";
                    var cmdCreate = new NpgsqlCommand(createSql, conn);
                    await cmdCreate.ExecuteNonQueryAsync();

                    for (int i = 1; i < lines.Length; i++)
                    {
                        var values = lines[i].Split(',');
                        var insertSql = $"INSERT INTO \"{tableName}\" ({string.Join(",", headers.Select(h => $"\"{h}\""))}) VALUES ({string.Join(",", values.Select(v => $"'{v.Replace("'", "''")}'"))});";
                        var cmdInsert = new NpgsqlCommand(insertSql, conn);
                        await cmdInsert.ExecuteNonQueryAsync();
                    }
                }

                ImportStatus = "Import completed.";
            }
            catch (System.Exception ex)
            {
                ImportStatus = $"Import failed: {ex.Message}";
            }
        }

        private NpgsqlConnection GetConnection()
        {
            var cs = $"Host={_dbConfig.Host};Database={_dbConfig.Database};Username={_dbConfig.UserId};Password={_dbConfig.Password}";
            return new NpgsqlConnection(cs);
        }

        private async Task<List<string>> GetTableNamesAsync()
        {
            var tables = new List<string>();
            using var conn = GetConnection();
            await conn.OpenAsync();

            var cmd = new NpgsqlCommand("SELECT table_name FROM information_schema.tables WHERE table_schema='public';", conn);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
                tables.Add(reader.GetString(0));

            return tables;
        }

        private async Task ExportTableToCsvAsync(string tableName, string filePath)
        {
            using var conn = GetConnection();
            await conn.OpenAsync();

            var cmd = new NpgsqlCommand($"SELECT * FROM \"{tableName}\";", conn);
            using var reader = await cmd.ExecuteReaderAsync();

            using var writer = new StreamWriter(filePath);

            var columns = Enumerable.Range(0, reader.FieldCount).Select(i => reader.GetName(i)).ToArray();
            await writer.WriteLineAsync(string.Join(",", columns));

            while (await reader.ReadAsync())
            {
                var values = Enumerable.Range(0, reader.FieldCount)
                    .Select(i => reader.GetValue(i)?.ToString()?.Replace(",", "\\,") ?? "")
                    .ToArray();
                await writer.WriteLineAsync(string.Join(",", values));
            }
        }

        private async Task<string> SelectFolderAsync()
        {
            var dlg = new OpenFolderDialog { Title = "Select Folder" };
            return await dlg.ShowAsync(_mainWindow);
        }
    }
}


â¸»

3ï¸âƒ£ ViewModels/TableItem.cs

using CommunityToolkit.Mvvm.ComponentModel;

namespace PostgreTool.ViewModels
{
    public partial class TableItem : ObservableObject
    {
        [ObservableProperty]
        private string tableName;

        [ObservableProperty]
        private bool isSelected;
    }
}


â¸»

4ï¸âƒ£ å°† CsvExportView åŠ å…¥ MainWindow Tab2

å‡è®¾ä½ çš„ MainWindow å·²ç»æœ‰ TabControlï¼š

<TabControl>
    <TabItem Header="DB Config">
        <controls:DbConfigView />
    </TabItem>
    <TabItem Header="CSV Import/Export">
        <controls:CsvExportView DataContext="{Binding CsvExportVM}" />
    </TabItem>
    <TabItem Header="Placeholder 3">
        <TextBlock Text="Page 3" />
    </TabItem>
</TabControl>

ç„¶ååœ¨ MainWindowViewModel ä¸­ï¼š

public CsvExportViewModel CsvExportVM { get; }

public MainWindowViewModel()
{
    CsvExportVM = new CsvExportViewModel(SelectedDbConfig, MainWindowInstance);
}

è¿™é‡Œçš„ SelectedDbConfig å°±æ˜¯ä½ ç¬¬ä¸€é¡µ DbConfigView é€‰ä¸­çš„æ•°æ®åº“é…ç½®ï¼ŒMainWindowInstance ç”¨äº FolderDialogã€‚

â¸»

è¿™æ ·æ•´ä¸ª Page2 å®Œå…¨ä½¿ç”¨ Avalonia å†…ç½®æ§ä»¶ï¼Œæ— è‡ªå®šä¹‰ GroupBoxï¼ŒTab2 å¯ä»¥ç›´æ¥æ˜¾ç¤º CSV å¯¼å…¥/å¯¼å‡ºç•Œé¢ã€‚

â¸»

æˆ‘å¯ä»¥å¸®ä½ å†ç”»ä¸€ä¸ª æ•´ä¸ª TabControl å®Œæ•´ MVVM ç»‘å®šç¤ºæ„å›¾ï¼Œä¿è¯ Page1/2/3 éƒ½èƒ½ç›´æ¥è¿è¡Œï¼Œæ‰€æœ‰å‘½ä»¤å’ŒçŠ¶æ€éƒ½ç”Ÿæ•ˆã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ







æ˜ç™½äº†ï¼Œä½ å¸Œæœ› Page2 çš„ ViewModelã€Control å‘½åé£æ ¼å’Œä½ ç°æœ‰å·¥ç¨‹ä¿æŒä¸€è‡´ï¼š
	â€¢	ç¬¬ä¸€é¡µæ˜¯ Controls/DbConfigView.xaml + ViewModels/DbConfigViewModel.cs
	â€¢	æ‰€ä»¥ç¬¬äºŒé¡µä¹Ÿåº”è¯¥ç±»ä¼¼ï¼š

Controls/CsvExportView.xaml
ViewModels/CsvExportViewModel.cs

	â€¢	æ§ä»¶åå­—ç”¨ View åç¼€
	â€¢	ViewModel ç”¨ ViewModel åç¼€
	â€¢	å…¨è‹±æ–‡å‘½åï¼Œç¬¦åˆä½ åŸæ¥çš„å·¥ç¨‹é£æ ¼

â¸»

ä¸‹é¢æˆ‘ç»™ä½ ç”Ÿæˆ Page2 å®Œæ•´ MVVM ç¤ºä¾‹ï¼š

1ï¸âƒ£ Controls/CsvExportView.xaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PostgreTool.ViewModels"
             x:DataType="vm:CsvExportViewModel">

    <StackPanel Margin="10" Spacing="10">

        <!-- Import Section -->
        <GroupBox Header="Import CSV">
            <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Content="Select Folder to Import" Command="{Binding ImportFolderCommand}" />
                <TextBlock Text="{Binding ImportStatus}" />
            </StackPanel>
        </GroupBox>

        <!-- Export Section -->
        <GroupBox Header="Export CSV">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Content="Load Tables" Command="{Binding LoadTablesCommand}" />
                    <Button Content="Toggle Select All" Command="{Binding ToggleSelectAllCommand}" />
                    <Button Content="Export Selected" Command="{Binding ExportCommand}" />
                </StackPanel>

                <ListBox Items="{Binding TableList}" SelectionMode="Multiple">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:TableItem">
                            <StackPanel Orientation="Horizontal">
                                <CheckBox IsChecked="{Binding IsSelected}" Content="{Binding TableName}" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <TextBlock Text="{Binding ExportStatus}" />
            </StackPanel>
        </GroupBox>

    </StackPanel>
</UserControl>


â¸»

2ï¸âƒ£ ViewModels/CsvExportViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Npgsql;
using Avalonia.Controls;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

namespace PostgreTool.ViewModels
{
    public partial class CsvExportViewModel : ObservableObject
    {
        private readonly DbConnectionConfig _dbConfig;
        private readonly Window _mainWindow;

        public CsvExportViewModel(DbConnectionConfig selectedDbConfig, Window mainWindow)
        {
            _dbConfig = selectedDbConfig;
            _mainWindow = mainWindow;
            TableList = new ObservableCollection<TableItem>();
        }

        [ObservableProperty]
        private ObservableCollection<TableItem> tableList;

        [ObservableProperty]
        private string importStatus;

        [ObservableProperty]
        private string exportStatus;

        [RelayCommand]
        public async Task LoadTablesAsync()
        {
            try
            {
                var tables = await GetTableNamesAsync();
                TableList.Clear();
                foreach (var t in tables)
                    TableList.Add(new TableItem { TableName = t, IsSelected = false });
            }
            catch (System.Exception ex)
            {
                ExportStatus = $"Load tables failed: {ex.Message}";
            }
        }

        [RelayCommand]
        public void ToggleSelectAll()
        {
            bool allSelected = TableList.All(t => t.IsSelected);
            foreach (var t in TableList)
                t.IsSelected = !allSelected;
        }

        [RelayCommand]
        public async Task ExportAsync()
        {
            try
            {
                var folder = await SelectFolderAsync();
                if (string.IsNullOrEmpty(folder)) return;

                foreach (var t in TableList.Where(t => t.IsSelected))
                {
                    var filePath = Path.Combine(folder, $"{t.TableName}.csv");
                    await ExportTableToCsvAsync(t.TableName, filePath);
                }

                ExportStatus = "Export completed.";
            }
            catch (System.Exception ex)
            {
                ExportStatus = $"Export failed: {ex.Message}";
            }
        }

        [RelayCommand]
        public async Task ImportFolderAsync()
        {
            try
            {
                var folder = await SelectFolderAsync();
                if (string.IsNullOrEmpty(folder)) return;

                var csvFiles = Directory.GetFiles(folder, "*.csv");
                using var conn = GetConnection();
                await conn.OpenAsync();

                foreach (var file in csvFiles)
                {
                    var tableName = Path.GetFileNameWithoutExtension(file);

                    var cmdDrop = new NpgsqlCommand($"DROP TABLE IF EXISTS \"{tableName}\";", conn);
                    await cmdDrop.ExecuteNonQueryAsync();

                    var lines = await File.ReadAllLinesAsync(file);
                    if (lines.Length == 0) continue;

                    var headers = lines[0].Split(',');
                    var createSql = $"CREATE TABLE \"{tableName}\" ({string.Join(",", headers.Select(h => $"\"{h}\" TEXT"))});";
                    var cmdCreate = new NpgsqlCommand(createSql, conn);
                    await cmdCreate.ExecuteNonQueryAsync();

                    for (int i = 1; i < lines.Length; i++)
                    {
                        var values = lines[i].Split(',');
                        var insertSql = $"INSERT INTO \"{tableName}\" ({string.Join(",", headers.Select(h => $"\"{h}\""))}) VALUES ({string.Join(",", values.Select(v => $"'{v.Replace("'", "''")}'"))});";
                        var cmdInsert = new NpgsqlCommand(insertSql, conn);
                        await cmdInsert.ExecuteNonQueryAsync();
                    }
                }

                ImportStatus = "Import completed.";
            }
            catch (System.Exception ex)
            {
                ImportStatus = $"Import failed: {ex.Message}";
            }
        }

        private NpgsqlConnection GetConnection()
        {
            var cs = $"Host={_dbConfig.Host};Database={_dbConfig.Database};Username={_dbConfig.UserId};Password={_dbConfig.Password}";
            return new NpgsqlConnection(cs);
        }

        private async Task<List<string>> GetTableNamesAsync()
        {
            var tables = new List<string>();
            using var conn = GetConnection();
            await conn.OpenAsync();

            var cmd = new NpgsqlCommand("SELECT table_name FROM information_schema.tables WHERE table_schema='public';", conn);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
                tables.Add(reader.GetString(0));

            return tables;
        }

        private async Task ExportTableToCsvAsync(string tableName, string filePath)
        {
            using var conn = GetConnection();
            await conn.OpenAsync();

            var cmd = new NpgsqlCommand($"SELECT * FROM \"{tableName}\";", conn);
            using var reader = await cmd.ExecuteReaderAsync();

            using var writer = new StreamWriter(filePath);

            var columns = Enumerable.Range(0, reader.FieldCount).Select(i => reader.GetName(i)).ToArray();
            await writer.WriteLineAsync(string.Join(",", columns));

            while (await reader.ReadAsync())
            {
                var values = Enumerable.Range(0, reader.FieldCount)
                    .Select(i => reader.GetValue(i)?.ToString()?.Replace(",", "\\,") ?? "")
                    .ToArray();
                await writer.WriteLineAsync(string.Join(",", values));
            }
        }

        private async Task<string> SelectFolderAsync()
        {
            var dlg = new OpenFolderDialog
            {
                Title = "Select Folder"
            };

            var result = await dlg.ShowAsync(_mainWindow);
            return result;
        }
    }
}


â¸»

3ï¸âƒ£ TableItem.cs ï¼ˆæ”¾ ViewModels ä¸‹ï¼‰

using CommunityToolkit.Mvvm.ComponentModel;

namespace PostgreTool.ViewModels
{
    public partial class TableItem : ObservableObject
    {
        [ObservableProperty]
        private string tableName;

        [ObservableProperty]
        private bool isSelected;
    }
}


â¸»

âœ… è¿™æ ·ï¼š
	â€¢	å‘½åè§„åˆ™å’Œç¬¬ä¸€é¡µä¸€è‡´
	â€¢	å…¨è‹±æ–‡å‘½å
	â€¢	FolderDialog ä½¿ç”¨ Avalonia åŸç”Ÿæ§ä»¶
	â€¢	æ”¯æŒå¯¼å…¥ã€å¯¼å‡ºã€å…¨é€‰ã€è¡¨åˆ—è¡¨åˆ·æ–°

â¸»

æˆ‘å¯ä»¥å¸®ä½ ç”Ÿæˆ æ•´ä¸ªä¸»çª—å£ MainWindow.axaml çš„ Tab æ§ä»¶ç»‘å®š Page2ï¼Œä¿è¯ Tab2 ç›´æ¥æ˜¾ç¤º CsvExportView å¹¶ä¼ å…¥å½“å‰é€‰æ‹©çš„ DbConnectionConfigï¼Œè®© Page2 å¯ä»¥ç›´æ¥æ“ä½œç¬¬ä¸€é¡µé€‰æ‹©çš„æ•°æ®åº“ã€‚

ä½ å¸Œæœ›æˆ‘ç»§ç»­å¸®ä½ åšè¿™ä¸ªå—ï¼Ÿ

æ˜ç™½äº†ï¼Œä½ å¸Œæœ› Page2 çš„ ViewModelã€Control å‘½åé£æ ¼å’Œä½ ç°æœ‰å·¥ç¨‹ä¿æŒä¸€è‡´ï¼š
	â€¢	ç¬¬ä¸€é¡µæ˜¯ Controls/DbConfigView.xaml + ViewModels/DbConfigViewModel.cs
	â€¢	æ‰€ä»¥ç¬¬äºŒé¡µä¹Ÿåº”è¯¥ç±»ä¼¼ï¼š

Controls/CsvExportView.xaml
ViewModels/CsvExportViewModel.cs

	â€¢	æ§ä»¶åå­—ç”¨ View åç¼€
	â€¢	ViewModel ç”¨ ViewModel åç¼€
	â€¢	å…¨è‹±æ–‡å‘½åï¼Œç¬¦åˆä½ åŸæ¥çš„å·¥ç¨‹é£æ ¼

â¸»

ä¸‹é¢æˆ‘ç»™ä½ ç”Ÿæˆ Page2 å®Œæ•´ MVVM ç¤ºä¾‹ï¼š

1ï¸âƒ£ Controls/CsvExportView.xaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PostgreTool.ViewModels"
             x:DataType="vm:CsvExportViewModel">

    <StackPanel Margin="10" Spacing="10">

        <!-- Import Section -->
        <GroupBox Header="Import CSV">
            <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Content="Select Folder to Import" Command="{Binding ImportFolderCommand}" />
                <TextBlock Text="{Binding ImportStatus}" />
            </StackPanel>
        </GroupBox>

        <!-- Export Section -->
        <GroupBox Header="Export CSV">
            <StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Content="Load Tables" Command="{Binding LoadTablesCommand}" />
                    <Button Content="Toggle Select All" Command="{Binding ToggleSelectAllCommand}" />
                    <Button Content="Export Selected" Command="{Binding ExportCommand}" />
                </StackPanel>

                <ListBox Items="{Binding TableList}" SelectionMode="Multiple">
                    <ListBox.ItemTemplate>
                        <DataTemplate x:DataType="vm:TableItem">
                            <StackPanel Orientation="Horizontal">
                                <CheckBox IsChecked="{Binding IsSelected}" Content="{Binding TableName}" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <TextBlock Text="{Binding ExportStatus}" />
            </StackPanel>
        </GroupBox>

    </StackPanel>
</UserControl>


â¸»

2ï¸âƒ£ ViewModels/CsvExportViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using Npgsql;
using Avalonia.Controls;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;

namespace PostgreTool.ViewModels
{
    public partial class CsvExportViewModel : ObservableObject
    {
        private readonly DbConnectionConfig _dbConfig;
        private readonly Window _mainWindow;

        public CsvExportViewModel(DbConnectionConfig selectedDbConfig, Window mainWindow)
        {
            _dbConfig = selectedDbConfig;
            _mainWindow = mainWindow;
            TableList = new ObservableCollection<TableItem>();
        }

        [ObservableProperty]
        private ObservableCollection<TableItem> tableList;

        [ObservableProperty]
        private string importStatus;

        [ObservableProperty]
        private string exportStatus;

        [RelayCommand]
        public async Task LoadTablesAsync()
        {
            try
            {
                var tables = await GetTableNamesAsync();
                TableList.Clear();
                foreach (var t in tables)
                    TableList.Add(new TableItem { TableName = t, IsSelected = false });
            }
            catch (System.Exception ex)
            {
                ExportStatus = $"Load tables failed: {ex.Message}";
            }
        }

        [RelayCommand]
        public void ToggleSelectAll()
        {
            bool allSelected = TableList.All(t => t.IsSelected);
            foreach (var t in TableList)
                t.IsSelected = !allSelected;
        }

        [RelayCommand]
        public async Task ExportAsync()
        {
            try
            {
                var folder = await SelectFolderAsync();
                if (string.IsNullOrEmpty(folder)) return;

                foreach (var t in TableList.Where(t => t.IsSelected))
                {
                    var filePath = Path.Combine(folder, $"{t.TableName}.csv");
                    await ExportTableToCsvAsync(t.TableName, filePath);
                }

                ExportStatus = "Export completed.";
            }
            catch (System.Exception ex)
            {
                ExportStatus = $"Export failed: {ex.Message}";
            }
        }

        [RelayCommand]
        public async Task ImportFolderAsync()
        {
            try
            {
                var folder = await SelectFolderAsync();
                if (string.IsNullOrEmpty(folder)) return;

                var csvFiles = Directory.GetFiles(folder, "*.csv");
                using var conn = GetConnection();
                await conn.OpenAsync();

                foreach (var file in csvFiles)
                {
                    var tableName = Path.GetFileNameWithoutExtension(file);

                    var cmdDrop = new NpgsqlCommand($"DROP TABLE IF EXISTS \"{tableName}\";", conn);
                    await cmdDrop.ExecuteNonQueryAsync();

                    var lines = await File.ReadAllLinesAsync(file);
                    if (lines.Length == 0) continue;

                    var headers = lines[0].Split(',');
                    var createSql = $"CREATE TABLE \"{tableName}\" ({string.Join(",", headers.Select(h => $"\"{h}\" TEXT"))});";
                    var cmdCreate = new NpgsqlCommand(createSql, conn);
                    await cmdCreate.ExecuteNonQueryAsync();

                    for (int i = 1; i < lines.Length; i++)
                    {
                        var values = lines[i].Split(',');
                        var insertSql = $"INSERT INTO \"{tableName}\" ({string.Join(",", headers.Select(h => $"\"{h}\""))}) VALUES ({string.Join(",", values.Select(v => $"'{v.Replace("'", "''")}'"))});";
                        var cmdInsert = new NpgsqlCommand(insertSql, conn);
                        await cmdInsert.ExecuteNonQueryAsync();
                    }
                }

                ImportStatus = "Import completed.";
            }
            catch (System.Exception ex)
            {
                ImportStatus = $"Import failed: {ex.Message}";
            }
        }

        private NpgsqlConnection GetConnection()
        {
            var cs = $"Host={_dbConfig.Host};Database={_dbConfig.Database};Username={_dbConfig.UserId};Password={_dbConfig.Password}";
            return new NpgsqlConnection(cs);
        }

        private async Task<List<string>> GetTableNamesAsync()
        {
            var tables = new List<string>();
            using var conn = GetConnection();
            await conn.OpenAsync();

            var cmd = new NpgsqlCommand("SELECT table_name FROM information_schema.tables WHERE table_schema='public';", conn);
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
                tables.Add(reader.GetString(0));

            return tables;
        }

        private async Task ExportTableToCsvAsync(string tableName, string filePath)
        {
            using var conn = GetConnection();
            await conn.OpenAsync();

            var cmd = new NpgsqlCommand($"SELECT * FROM \"{tableName}\";", conn);
            using var reader = await cmd.ExecuteReaderAsync();

            using var writer = new StreamWriter(filePath);

            var columns = Enumerable.Range(0, reader.FieldCount).Select(i => reader.GetName(i)).ToArray();
            await writer.WriteLineAsync(string.Join(",", columns));

            while (await reader.ReadAsync())
            {
                var values = Enumerable.Range(0, reader.FieldCount)
                    .Select(i => reader.GetValue(i)?.ToString()?.Replace(",", "\\,") ?? "")
                    .ToArray();
                await writer.WriteLineAsync(string.Join(",", values));
            }
        }

        private async Task<string> SelectFolderAsync()
        {
            var dlg = new OpenFolderDialog
            {
                Title = "Select Folder"
            };

            var result = await dlg.ShowAsync(_mainWindow);
            return result;
        }
    }
}


â¸»

3ï¸âƒ£ TableItem.cs ï¼ˆæ”¾ ViewModels ä¸‹ï¼‰

using CommunityToolkit.Mvvm.ComponentModel;

namespace PostgreTool.ViewModels
{
    public partial class TableItem : ObservableObject
    {
        [ObservableProperty]
        private string tableName;

        [ObservableProperty]
        private bool isSelected;
    }
}


â¸»

âœ… è¿™æ ·ï¼š
	â€¢	å‘½åè§„åˆ™å’Œç¬¬ä¸€é¡µä¸€è‡´
	â€¢	å…¨è‹±æ–‡å‘½å
	â€¢	FolderDialog ä½¿ç”¨ Avalonia åŸç”Ÿæ§ä»¶
	â€¢	æ”¯æŒå¯¼å…¥ã€å¯¼å‡ºã€å…¨é€‰ã€è¡¨åˆ—è¡¨åˆ·æ–°

â¸»

æˆ‘å¯ä»¥å¸®ä½ ç”Ÿæˆ æ•´ä¸ªä¸»çª—å£ MainWindow.axaml çš„ Tab æ§ä»¶ç»‘å®š Page2ï¼Œä¿è¯ Tab2 ç›´æ¥æ˜¾ç¤º CsvExportView å¹¶ä¼ å…¥å½“å‰é€‰æ‹©çš„ DbConnectionConfigï¼Œè®© Page2 å¯ä»¥ç›´æ¥æ“ä½œç¬¬ä¸€é¡µé€‰æ‹©çš„æ•°æ®åº“ã€‚

ä½ å¸Œæœ›æˆ‘ç»§ç»­å¸®ä½ åšè¿™ä¸ªå—ï¼Ÿ




å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥ä½ å·²ç»ä» demo çº§åˆ«ï¼Œæ­£å¼è¿›å…¥â€œå·¥å…·çº§åº”ç”¨è®¾è®¡â€äº†ã€‚
ä¸‹é¢æˆ‘ç»™ä½ çš„æ˜¯ä¸€å¥— å®Œæ•´ã€å¯æ‰©å±•ã€å·¥ç¨‹çº§çš„å¤šè¿æ¥é…ç½®æ–¹æ¡ˆï¼Œè€Œä¸”ä¸¥æ ¼ MVVMã€WSL åœºæ™¯é€‚é…ã€å¯ä»¥ç›´æ¥åœ¨ä½ ç°æœ‰å·¥ç¨‹é‡Œè·‘èµ·æ¥ã€‚

æˆ‘ä¼šæŒ‰ ã€Œè®¾è®¡ â†’ ä»£ç  â†’ ä½ èƒ½ç›´æ¥å¤åˆ¶ç”¨ã€ çš„é¡ºåºæ¥ã€‚

â¸»

ä¸€ã€ç›®æ ‡æ˜ç¡®ï¼ˆä½ ç°åœ¨è¦çš„èƒ½åŠ›ï¼‰

âœ” æ”¯æŒ å¤šæ¡ PostgreSQL è¿æ¥é…ç½®
âœ” æ¯æ¡é…ç½®ï¼š
	â€¢	ConnectionNameï¼ˆè‡ªå®šä¹‰åç§°ï¼‰
	â€¢	WSL Name
	â€¢	Host / Port
	â€¢	User / Password
	â€¢	Database
âœ” èƒ½ï¼š
	â€¢	æ–°å¢ / é€‰æ‹© / åˆ é™¤é…ç½®
	â€¢	ä¿å­˜åˆ°æœ¬åœ°ï¼ˆæŒä¹…åŒ–ï¼‰
	â€¢	é’ˆå¯¹å½“å‰é€‰ä¸­é…ç½®åšã€Œæµ‹è¯•è¿æ¥ï¼ˆWSLï¼‰ã€

â¸»

äºŒã€æœ€ç»ˆå·¥ç¨‹ç»“æ„ï¼ˆå®Œæ•´ç‰ˆï¼‰

PostgreTool
â”‚
â”œâ”€ Models
â”‚  â””â”€ DbConnectionConfig.cs
â”‚
â”œâ”€ Services
â”‚  â”œâ”€ DbConfigStorage.cs
â”‚  â”œâ”€ WslService.cs
â”‚  â””â”€ WslPostgresTester.cs
â”‚
â”œâ”€ ViewModels
â”‚  â””â”€ DbConfigViewModel.cs
â”‚
â”œâ”€ Controls
â”‚  â”œâ”€ DbConfigView.axaml
â”‚  â””â”€ DbConfigView.axaml.cs
â”‚
â”œâ”€ Views
â”‚  â””â”€ MainWindow.axaml
â”‚
â””â”€ App / Program ...


â¸»

ä¸‰ã€æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼ˆå¤šè¿æ¥ï¼‰

Models/DbConnectionConfig.cs

namespace PostgreTool.Models;

public class DbConnectionConfig
{
    public string Name { get; set; } = "New Connection";
    public string WslName { get; set; } = "";
    public string Host { get; set; } = "localhost";
    public int Port { get; set; } = 5432;
    public string UserId { get; set; } = "";
    public string Password { get; set; } = "";
    public string Database { get; set; } = "";
}


â¸»

å››ã€æŒä¹…åŒ–ï¼ˆå¤šæ¡é…ç½®ï¼‰

Services/DbConfigStorage.cs

using System.Text.Json;
using PostgreTool.Models;

namespace PostgreTool.Services;

public static class DbConfigStorage
{
    private static readonly string PathName =
        Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData),
            "PostgreTool",
            "connections.json");

    public static List<DbConnectionConfig> Load()
    {
        if (!File.Exists(PathName))
            return new();

        var json = File.ReadAllText(PathName);
        return JsonSerializer.Deserialize<List<DbConnectionConfig>>(json)!;
    }

    public static void Save(IEnumerable<DbConnectionConfig> configs)
    {
        Directory.CreateDirectory(Path.GetDirectoryName(PathName)!);

        var json = JsonSerializer.Serialize(configs, new JsonSerializerOptions
        {
            WriteIndented = true
        });

        File.WriteAllText(PathName, json);
    }
}


â¸»

äº”ã€WSL ç›¸å…³æœåŠ¡

Services/WslService.csï¼ˆåˆ—å‡ºå‘è¡Œç‰ˆï¼‰

using System.Diagnostics;

namespace PostgreTool.Services;

public static class WslService
{
    public static async Task<List<string>> GetDistributionsAsync()
    {
        var psi = new ProcessStartInfo
        {
            FileName = "wsl",
            Arguments = "-l -q",
            RedirectStandardOutput = true,
            UseShellExecute = false
        };

        using var p = Process.Start(psi)!;
        var output = await p.StandardOutput.ReadToEndAsync();
        await p.WaitForExitAsync();

        return output
            .Split(Environment.NewLine, StringSplitOptions.RemoveEmptyEntries)
            .ToList();
    }
}


â¸»

Services/WslPostgresTester.cs

using System.Diagnostics;

namespace PostgreTool.Services;

public static class WslPostgresTester
{
    public static async Task<string> TestAsync(
        string wsl,
        string host,
        int port,
        string user,
        string db,
        string password)
    {
        var psi = new ProcessStartInfo
        {
            FileName = "wsl",
            Arguments =
                $"-d {wsl} bash -c " +
                $"\"PGPASSWORD='{password}' psql -h {host} -p {port} -U {user} -d {db} -c '\\\\conninfo'\"",
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            UseShellExecute = false
        };

        using var p = Process.Start(psi)!;

        var stdout = await p.StandardOutput.ReadToEndAsync();
        var stderr = await p.StandardError.ReadToEndAsync();
        await p.WaitForExitAsync();

        if (p.ExitCode != 0)
            throw new Exception(stderr);

        return stdout.Trim();
    }
}


â¸»

å…­ã€æ ¸å¿ƒ ViewModelï¼ˆé‡ç‚¹ï¼‰

ViewModels/DbConfigViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using PostgreTool.Models;
using PostgreTool.Services;
using System.Collections.ObjectModel;

namespace PostgreTool.ViewModels;

public partial class DbConfigViewModel : ObservableObject
{
    public ObservableCollection<DbConnectionConfig> Connections { get; }

    [ObservableProperty]
    private DbConnectionConfig? selectedConnection;

    [ObservableProperty]
    private ObservableCollection<string> wslDistributions = new();

    [ObservableProperty]
    private string statusMessage = "";

    public DbConfigViewModel()
    {
        Connections = new ObservableCollection<DbConnectionConfig>(
            DbConfigStorage.Load());

        SelectedConnection ??= Connections.FirstOrDefault();
        _ = LoadWslAsync();
    }

    private async Task LoadWslAsync()
    {
        var list = await WslService.GetDistributionsAsync();
        WslDistributions = new ObservableCollection<string>(list);
    }

    [RelayCommand]
    private void Add()
    {
        var conn = new DbConnectionConfig();
        Connections.Add(conn);
        SelectedConnection = conn;
    }

    [RelayCommand]
    private void Remove()
    {
        if (SelectedConnection == null) return;
        Connections.Remove(SelectedConnection);
        SelectedConnection = Connections.FirstOrDefault();
    }

    [RelayCommand]
    private void Save()
    {
        DbConfigStorage.Save(Connections);
        StatusMessage = "Connections saved";
    }

    [RelayCommand]
    private async Task TestAsync()
    {
        if (SelectedConnection == null) return;

        try
        {
            StatusMessage = "Testing...";
            var r = await WslPostgresTester.TestAsync(
                SelectedConnection.WslName,
                SelectedConnection.Host,
                SelectedConnection.Port,
                SelectedConnection.UserId,
                SelectedConnection.Database,
                SelectedConnection.Password);

            StatusMessage = "OK: " + r;
        }
        catch (Exception ex)
        {
            StatusMessage = "Failed: " + ex.Message;
        }
    }
}


â¸»

ä¸ƒã€DbConfigViewï¼ˆå®Œæ•´ UIï¼‰

Controls/DbConfigView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PostgreTool.ViewModels"
             x:Class="PostgreTool.Controls.DbConfigView">

  <UserControl.DataContext>
    <vm:DbConfigViewModel />
  </UserControl.DataContext>

  <Grid ColumnDefinitions="200,*" Margin="10">

    <!-- å·¦ä¾§ï¼šè¿æ¥åˆ—è¡¨ -->
    <StackPanel>
      <Button Content="Add" Command="{Binding AddCommand}" />
      <Button Content="Remove" Command="{Binding RemoveCommand}" />
      <ListBox Items="{Binding Connections}"
               SelectedItem="{Binding SelectedConnection}">
        <ListBox.ItemTemplate>
          <DataTemplate>
            <TextBlock Text="{Binding Name}" />
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </StackPanel>

    <!-- å³ä¾§ï¼šç¼–è¾‘ -->
    <StackPanel Grid.Column="1" Margin="10" Spacing="8"
                DataContext="{Binding SelectedConnection}">

      <TextBox Watermark="Connection Name" Text="{Binding Name}" />
      <ComboBox Items="{Binding DataContext.WslDistributions,
                                RelativeSource={RelativeSource AncestorType=UserControl}}"
                SelectedItem="{Binding WslName}" />

      <TextBox Watermark="Host" Text="{Binding Host}" />
      <TextBox Watermark="Port" Text="{Binding Port}" />
      <TextBox Watermark="User" Text="{Binding UserId}" />
      <TextBox Watermark="Password" PasswordChar="*" Text="{Binding Password}" />
      <TextBox Watermark="Database" Text="{Binding Database}" />

      <StackPanel Orientation="Horizontal" Spacing="10">
        <Button Content="Save"
                Command="{Binding DataContext.SaveCommand,
                                  RelativeSource={RelativeSource AncestorType=UserControl}}" />
        <Button Content="Test"
                Command="{Binding DataContext.TestCommand,
                                  RelativeSource={RelativeSource AncestorType=UserControl}}" />
      </StackPanel>

      <TextBlock Text="{Binding DataContext.StatusMessage,
                        RelativeSource={RelativeSource AncestorType=UserControl}}" />
    </StackPanel>

  </Grid>
</UserControl>


â¸»

å…«ã€ä½ ç°åœ¨è¿™ä¸ªè®¾è®¡å·²ç»æ˜¯ã€Œæˆç†Ÿå·¥å…·ã€äº†

ä½ å·²ç»å…·å¤‡ï¼š
	â€¢	å¤šè¿æ¥ç®¡ç†
	â€¢	WSL æ„ŸçŸ¥
	â€¢	æŒä¹…åŒ–
	â€¢	å¯æ‰©å±•ï¼ˆä¸‹ä¸€æ­¥ç›´æ¥åš SQL æ‰§è¡Œ / schema æµè§ˆï¼‰

â¸»

ä¸‹ä¸€æ­¥æˆ‘å¼ºçƒˆæ¨èï¼ˆæŒ‰ä»·å€¼ï¼‰

1ï¸âƒ£ åº•éƒ¨ Log åŒºï¼ˆæ˜¾ç¤ºå®Œæ•´ wsl / psql è¾“å‡ºï¼‰
2ï¸âƒ£ è¿æ¥æµ‹è¯•å¼‚æ­¥ + Loading çŠ¶æ€
3ï¸âƒ£ æŠŠ Password åŠ å¯†å­˜å‚¨ï¼ˆDPAPIï¼‰
4ï¸âƒ£ ä¸€ä¸ªè¿æ¥ = ä¸€ä¸ª Tab / é¡µé¢

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ä¸‹ä¸€æ­¥ç›´æ¥å¸®ä½ æŠŠ
ğŸ‘‰ ã€Œåº•éƒ¨ Log + å¼‚æ­¥çŠ¶æ€ + å¯†ç åŠ å¯†ã€ä¸€æ¬¡æ€§è¡¥é½

å¥½ï¼Œè¿™é‡Œæˆ‘ç»™ä½ ä¸€ä¸ª**ä¸¥æ ¼ MVVMã€ä½†ä»ç„¶â€œæœ€å°å¯è¿è¡Œâ€**çš„ Avalonia ç¤ºä¾‹å·¥ç¨‹ã€‚
ç‰¹ç‚¹æ˜¯ï¼š
	â€¢	âœ… çœŸæ­£ MVVM
	â€¢	View ä¸å†™ä»»ä½•ä¸šåŠ¡é€»è¾‘
	â€¢	æ‰€æœ‰çŠ¶æ€ & è¡Œä¸ºéƒ½åœ¨ ViewModel
	â€¢	âœ… ä½¿ç”¨ CommunityToolkit.Mvvmï¼ˆä½ å‰é¢ä¹Ÿä¸€ç›´åœ¨ç”¨ï¼‰
	â€¢	âœ… ç»“æ„æ¸…æ™°ï¼Œåç»­éå¸¸å®¹æ˜“æ‰©å±•æˆå¤šé¡µé¢ / çœŸæ­£ PostgreSQL å·¥å…·
	â€¢	âœ… å·¥ç¨‹åä»ç„¶ï¼šPostgreTool
	â€¢	âœ… ç›´æ¥ dotnet run å¯å¯åŠ¨

â¸»

ä¸€ã€å·¥ç¨‹ç»“æ„ï¼ˆMVVM æ ‡å‡†ï¼‰

PostgreTool
â”‚
â”œâ”€ PostgreTool.csproj
â”œâ”€ Program.cs
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”‚
â”œâ”€ Views
â”‚  â””â”€ MainWindow.axaml
â”‚
â”œâ”€ ViewModels
â”‚  â””â”€ MainWindowViewModel.cs
â”‚
â””â”€ Controls
   â”œâ”€ DbConfigView.axaml
   â””â”€ DbConfigView.axaml.cs

ğŸ‘‰ é‡ç‚¹
	â€¢	MainWindow åªè´Ÿè´£ Tab
	â€¢	DB é…ç½®é¡µæ˜¯ç‹¬ç«‹ UserControl
	â€¢	ViewModel å®Œå…¨æ—  UI ä¾èµ–

â¸»

äºŒã€PostgreTool.csproj

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia" Version="11.0.6" />
    <PackageReference Include="Avalonia.Desktop" Version="11.0.6" />
    <PackageReference Include="Avalonia.Themes.Fluent" Version="11.0.6" />
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />
  </ItemGroup>

</Project>


â¸»

ä¸‰ã€Program.csï¼ˆä¸å˜ï¼‰

using Avalonia;

namespace PostgreTool;

class Program
{
    public static void Main(string[] args)
        => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .WithInterFont()
            .LogToTrace();
}


â¸»

å››ã€App.axaml / App.axaml.cs

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="PostgreTool.App">
  <Application.Styles>
    <FluentTheme />
  </Application.Styles>
</Application>

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;

namespace PostgreTool;

public partial class App : Application
{
    public override void Initialize()
    {
        AvaloniaXamlLoader.Load(this);
    }

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new Views.MainWindow();
        }
        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

äº”ã€MainWindowï¼ˆåªç®¡ Tabï¼‰

Views/MainWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:views="clr-namespace:PostgreTool.Controls"
        x:Class="PostgreTool.Views.MainWindow"
        Width="720"
        Height="460"
        Title="PostgreTool">

  <TabControl>
    <TabItem Header="DB Config">
      <views:DbConfigView />
    </TabItem>

    <TabItem Header="Page 2">
      <TextBlock Text="Page 2 Placeholder"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Center"/>
    </TabItem>

    <TabItem Header="Page 3">
      <TextBlock Text="Page 3 Placeholder"
                 HorizontalAlignment="Center"
                 VerticalAlignment="Center"/>
    </TabItem>
  </TabControl>

</Window>

Views/MainWindow.axaml.cs

using Avalonia.Controls;

namespace PostgreTool.Views;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }
}


â¸»

å…­ã€DB é…ç½®é¡µï¼ˆUserControl + VMï¼‰

Controls/DbConfigView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:PostgreTool.ViewModels"
             x:Class="PostgreTool.Controls.DbConfigView">

  <UserControl.DataContext>
    <vm:MainWindowViewModel />
  </UserControl.DataContext>

  <StackPanel Margin="20" Spacing="10">

    <TextBox Watermark="User Id"
             Text="{Binding UserId, Mode=TwoWay}" />

    <TextBox Watermark="Password"
             PasswordChar="*"
             Text="{Binding Password, Mode=TwoWay}" />

    <TextBox Watermark="Server Name"
             Text="{Binding ServerName, Mode=TwoWay}" />

    <TextBox Watermark="Host"
             Text="{Binding Host, Mode=TwoWay}" />

    <TextBox Watermark="Database"
             Text="{Binding Database, Mode=TwoWay}" />

    <StackPanel Orientation="Horizontal" Spacing="10">
      <Button Content="Save"
              Command="{Binding SaveCommand}" />

      <Button Content="Test Connection"
              Command="{Binding TestConnectionCommand}" />
    </StackPanel>

    <TextBlock Text="{Binding StatusMessage}"
               Foreground="Green"/>
  </StackPanel>
</UserControl>


â¸»

ViewModels/MainWindowViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;

namespace PostgreTool.ViewModels;

public partial class MainWindowViewModel : ObservableObject
{
    [ObservableProperty]
    private string? userId;

    [ObservableProperty]
    private string? password;

    [ObservableProperty]
    private string? serverName;

    [ObservableProperty]
    private string? host;

    [ObservableProperty]
    private string? database;

    [ObservableProperty]
    private string statusMessage = string.Empty;

    [RelayCommand]
    private void Save()
    {
        StatusMessage = "Configuration saved (mock)";
    }

    [RelayCommand]
    private void TestConnection()
    {
        StatusMessage = "Connection test success (mock)";
    }
}


â¸»

ä¸ƒã€è¿è¡Œæ•ˆæœ
	â€¢	é¡¶éƒ¨ 3 ä¸ª Tab
	â€¢	ç¬¬ä¸€ä¸ª Tab æ˜¯å®Œæ•´ DB é…ç½®é¡µ
	â€¢	æ‰€æœ‰å­—æ®µåŒå‘ç»‘å®š
	â€¢	Command è§¦å‘ â†’ VM æ›´æ–° â†’ UI è‡ªåŠ¨åˆ·æ–°
	â€¢	å®Œå…¨ç¬¦åˆ MVVM

â¸»

å…«ã€ä¸ºä»€ä¹ˆè¿™æ ·æ˜¯â€œæ­£ç¡®çš„ Avalonia MVVMâ€

âœ” View æ— ä»»ä½•ä¸šåŠ¡ä»£ç 
âœ” ViewModel ä¸å¼•ç”¨ Avalonia
âœ” Command / Property è‡ªåŠ¨é€šçŸ¥
âœ” UserControl å¯å¤ç”¨
âœ” éä¸´æ—¶å†™æ³•ï¼Œèƒ½ç›´æ¥æ‰©å±•æˆçœŸå®å·¥å…·

â¸»

ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åšçš„ï¼ˆç›´æ¥é€‰ï¼‰

1ï¸âƒ£ æ¥å…¥ Npgsqlï¼ŒçœŸå® PostgreSQL è¿æ¥æµ‹è¯•
2ï¸âƒ£ æŠŠé…ç½®ä¿å­˜åˆ° appsettings.json / åŠ å¯†æ–‡ä»¶
3ï¸âƒ£ ç”¨ DataTemplate + ViewModel åŠ¨æ€ç”Ÿæˆ Tab
4ï¸âƒ£ åšæˆä½ ä¹‹å‰çš„ å·¦èœå• + å³å†…å®¹ + åº•éƒ¨ Log åŒº æ¶æ„

ä½ åªè¦è¯´ä¸€å¥ï¼š
ğŸ‘‰ã€Œä¸‹ä¸€æ­¥æ¥ PostgreSQL çœŸè¿æ¥ã€




ä½ è¿™ä¸ªé—®é¢˜æå¾—éå¸¸å¯¹ ğŸ‘
åˆšæ‰é‚£ä¸€å¤§æ®µé‡Œï¼ŒMainWindow ç¡®å®ç¼ºäº† Viewï¼ˆXAMLï¼‰è¿™ä¸€æ•´å—ï¼Œåªæœ‰ MainWindowViewModelï¼Œè¿™æ˜¯ä¸å®Œæ•´ã€ä¹Ÿæ²¡æ³•ç›´æ¥è·‘çš„ã€‚

ä¸‹é¢æˆ‘æŠŠ MainWindow ç›¸å…³çš„æ‰€æœ‰ä»£ç ä¸€æ¬¡æ€§è¡¥é½ï¼Œå¹¶ä¸”å’Œä½ å‰é¢å·²æœ‰çš„ CsvCompareView / è¡Œçº§å·®å¼‚çª—å£å®Œå…¨å¯¹é½ï¼Œä¿è¯ï¼š
	â€¢	âœ” Avalonia 12
	â€¢	âœ” Fluent é£æ ¼
	â€¢	âœ” MVVMï¼ˆCommunityToolkitï¼‰
	â€¢	âœ” å·¦ä¾§åŠŸèƒ½åŒº / å³ä¾§å†…å®¹åŒº / ä¸‹æ–¹æ—¥å¿—åŒº
	â€¢	âœ” WSL / PostgreSQL çŠ¶æ€æŒ‡ç¤º

â¸»

ä¸€ã€MainWindow ç»“æ„è¯´æ˜ï¼ˆä½ è„‘ä¸­åº”è¯¥ä¹Ÿæ˜¯è¿™ä¸ªï¼‰

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¶éƒ¨ï¼šçŠ¶æ€åŒº                                 â”‚
â”‚  WSL: â—  PostgreSQL: â—  Schema: [public â–¼]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¦ä¾§å¯¼èˆª      â”‚ å³ä¾§ä¸»å†…å®¹åŒº                 â”‚
â”‚ â–¸ CSV æ¯”è¾ƒ    â”‚  CsvCompareView              â”‚
â”‚               â”‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº•éƒ¨æ—¥å¿—åŒº                                 â”‚
â”‚ [12:01] Compared 3 CSV files...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â¸»

äºŒã€MainWindow.axamlï¼ˆå®Œæ•´å¯è¿è¡Œç‰ˆï¼‰

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:WslPostgresTool.ViewModels"
        xmlns:views="clr-namespace:WslPostgresTool.Views"
        Title="WSL PostgreSQL CSV Diff Tool"
        Width="1200"
        Height="800">

    <DockPanel>

        <!-- Top Status Bar -->
        <Border DockPanel.Dock="Top"
                Padding="8"
                Background="{DynamicResource ThemeControlMidBrush}">
            <StackPanel Orientation="Horizontal" Spacing="16">

                <TextBlock Text="WSL:"/>
                <Ellipse Width="10" Height="10"
                         Fill="{Binding WslOk, Converter={StaticResource BoolToBrush}}"/>

                <TextBlock Text="PostgreSQL:"/>
                <Ellipse Width="10" Height="10"
                         Fill="{Binding PostgresOk, Converter={StaticResource BoolToBrush}}"/>

                <TextBlock Text="Schema:"/>
                <TextBox Width="120"
                         Text="{Binding Source={x:Static vm:AppState.Instance}, Path=Schema}"/>

            </StackPanel>
        </Border>

        <!-- Bottom Log Panel -->
        <Border DockPanel.Dock="Bottom"
                Height="160"
                Background="{DynamicResource ThemeControlLowBrush}">
            <ListBox ItemsSource="{Binding Logs}" />
        </Border>

        <!-- Main Content -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Navigation -->
            <Border Background="{DynamicResource ThemeControlLowBrush}">
                <StackPanel Margin="8" Spacing="8">
                    <Button Content="CSV Compare"
                            IsEnabled="True"/>
                </StackPanel>
            </Border>

            <!-- Right Content -->
            <ContentControl Grid.Column="1">
                <views:CsvCompareView />
            </ContentControl>

        </Grid>

    </DockPanel>
</Window>


â¸»

ä¸‰ã€MainWindow.axaml.cs

using Avalonia.Controls;

namespace WslPostgresTool.Views;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }
}


â¸»

å››ã€ä¸€ä¸ªå…³é”®ä¿®æ­£ç‚¹ï¼ˆéå¸¸é‡è¦ï¼‰

åœ¨ MainWindow.axaml é‡Œæˆ‘ç”¨äº†ï¼š

Text="{Binding Source={x:Static vm:AppState.Instance}, Path=Schema}"

ğŸ‘‰ æ‰€ä»¥ä½ éœ€è¦åœ¨ XAML å¤´éƒ¨è¡¥å……å‘½åç©ºé—´ï¼š

xmlns:vm="clr-namespace:WslPostgresTool.Models"

è€Œä¸æ˜¯ ViewModels

æœ€ç»ˆå¤´éƒ¨åº”ä¸ºï¼š

xmlns:vm="clr-namespace:WslPostgresTool.Models"

è¿™æ˜¯å¾ˆå¤š Avalonia é¡¹ç›®æœ€å®¹æ˜“è¸©çš„å‘ä¹‹ä¸€ã€‚

â¸»

äº”ã€ç°åœ¨è¿™ä¸ªå·¥ç¨‹çŠ¶æ€

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä½ å·²ç»æœ‰ï¼š

æ¨¡å—	çŠ¶æ€
Program / App	âœ”
MainWindow View + VM	âœ”ï¼ˆç°åœ¨å®Œæ•´ï¼‰
CSV Compare View	âœ”
è¡Œçº§å·®å¼‚çª—å£	âœ”
WSL çŠ¶æ€æ£€æµ‹	âœ”
Postgre ä¸»é”®æŸ¥è¯¢	âœ”
CSV ä¸»é”® Diff	âœ”
Excel æŠ¥å‘Š	âœ”
æ—¥å¿—åŒº	âœ”

ğŸ‘‰ è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç›´æ¥è·‘ã€å¹¶ç»§ç»­æ‰©å±•çš„å®Œæ•´ Avalonia å·¥ç¨‹äº†ã€‚

â¸»

ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšçš„ï¼ˆéå¸¸è‡ªç„¶ï¼‰

1ï¸âƒ£ å·¦ä¾§å¯¼èˆªå¤šåŠŸèƒ½ï¼ˆDB å¯¼å‡º / CSV æ¯”è¾ƒåˆ‡æ¢ï¼‰
2ï¸âƒ£ Schema ä¸‹æ‹‰æ¡†ï¼ˆå®æ—¶è¯»å–æ•°æ®åº“ schemaï¼‰
3ï¸âƒ£ CSV å¯¹æ¯”è¿›åº¦æ¡ + å–æ¶ˆæŒ‰é’®
4ï¸âƒ£ WSL ä¸­ç›´æ¥è°ƒç”¨ pg_dump / COPY

ä½ åªè¦å›ä¸€å¥ç¼–å·ï¼Œæˆ‘ç»§ç»­å¾€ä¸‹æŠŠå·¥ç¨‹â€œè¡¥é½åˆ°ç”Ÿäº§çº§â€ã€‚



æ˜ç™½äº†ï¼Œä½ æƒ³è¦æŠŠæ•´ä¸ª Avalonia + Fluent + MVVM + WSL/PostgreSQL + CSV ä¸»é”®å¯¹æ¯” + è¡Œçº§å·®å¼‚ UI + Excel æŠ¥å‘Šæ•´åˆæˆä¸€ä¸ªå®Œæ•´å·¥ç¨‹ï¼Œæˆ‘æ¥å¸®ä½ æ¢³ç†ä¸€ä»½å¯ç›´æ¥ä½¿ç”¨çš„å·¥ç¨‹ç»“æ„å’Œæ ¸å¿ƒä»£ç ã€‚æˆ‘ä¼šè¾“å‡ºå·¥ç¨‹ç›®å½•ç»“æ„ + æ¯ä¸ªæ–‡ä»¶å®Œæ•´å†…å®¹ï¼Œä¿æŒå¯ç¼–è¯‘ã€‚

æ³¨æ„ï¼šä¸ºäº†æ¸…æ™°ï¼Œä¿ç•™å‘½åç©ºé—´ã€MVVM é£æ ¼ã€æ‰€æœ‰åŠŸèƒ½æ¨¡å—ï¼ˆæ•°æ®åº“è¿æ¥ã€WSL æ§åˆ¶ã€CSV å¯¹æ¯”ã€è¡Œçº§å·®å¼‚ UIã€Excel å¯¼å‡ºï¼‰ã€‚

â¸»

ä¸€ã€å·¥ç¨‹ç›®å½•ç»“æ„

WslPostgresTool/
â”œâ”€ WslPostgresTool.csproj
â”œâ”€ Program.cs
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”œâ”€ MainWindow.axaml
â”œâ”€ MainWindow.axaml.cs
â”œâ”€ Views/
â”‚   â”œâ”€ CsvCompareView.axaml
â”‚   â”œâ”€ CsvRowDiffWindow.axaml
â”œâ”€ ViewModels/
â”‚   â”œâ”€ MainWindowViewModel.cs
â”‚   â”œâ”€ CsvCompareViewModel.cs
â”‚   â”œâ”€ CsvRowDiffViewModel.cs
â”œâ”€ Models/
â”‚   â”œâ”€ AppState.cs
â”‚   â”œâ”€ CsvDiffResult.cs
â”‚   â”œâ”€ CsvRowDiff.cs
â”‚   â”œâ”€ CsvCellDiff.cs
â”œâ”€ Services/
â”‚   â”œâ”€ WslService.cs
â”‚   â”œâ”€ PostgresService.cs
â”‚   â”œâ”€ CsvCompareService.cs
â”‚   â”œâ”€ ExcelReportService.cs
â”‚   â””â”€ LoggingService.cs
â”œâ”€ Converters/
â”‚   â””â”€ BoolToBrushConverter.cs
â”‚   â””â”€ DiffColorConverter.cs


â¸»

äºŒã€æ ¸å¿ƒé¡¹ç›®æ–‡ä»¶

1ï¸âƒ£ WslPostgresTool.csproj

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net7.0</TargetFramework>
    <Nullable>enable</Nullable>
    <UseWPF>false</UseWPF>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Avalonia" Version="12.0.0" />
    <PackageReference Include="Avalonia.Desktop" Version="12.0.0" />
    <PackageReference Include="CommunityToolkit.Mvvm" Version="8.1.0" />
    <PackageReference Include="Npgsql" Version="7.2.0" />
    <PackageReference Include="ClosedXML" Version="0.108.0" />
  </ItemGroup>

</Project>


â¸»

2ï¸âƒ£ Program.cs

using Avalonia;
using Avalonia.ReactiveUI;

namespace WslPostgresTool;

internal class Program
{
    public static void Main(string[] args) => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
                     .UsePlatformDetect()
                     .LogToTrace()
                     .UseReactiveUI();
}


â¸»

3ï¸âƒ£ App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="WslPostgresTool.App">
  <Application.Resources>
    <ResourceDictionary>
      <converters:BoolToBrushConverter x:Key="BoolToBrush" />
      <converters:DiffColorConverter x:Key="DiffColorConverter" />
    </ResourceDictionary>
  </Application.Resources>
</Application>

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using WslPostgresTool.ViewModels;
using WslPostgresTool.Views;

namespace WslPostgresTool;

public partial class App : Application
{
    public override void Initialize() => AvaloniaXamlLoader.Load(this);

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow
            {
                DataContext = new MainWindowViewModel()
            };
        }

        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

ä¸‰ã€Models

1ï¸âƒ£ AppState.cs

using CommunityToolkit.Mvvm.ComponentModel;

namespace WslPostgresTool.Models;

public partial class AppState : ObservableObject
{
    public static AppState Instance { get; } = new();

    [ObservableProperty] private string host = "localhost";
    [ObservableProperty] private int port = 5432;
    [ObservableProperty] private string database = "postgres";
    [ObservableProperty] private string username = "postgres";
    [ObservableProperty] private string password = "";
    [ObservableProperty] private string schema = "public";

    public string ConnectionString =>
        $"Host={Host};Port={Port};Database={Database};Username={Username};Password={Password}";
}

2ï¸âƒ£ CsvDiffResult.cs

namespace WslPostgresTool.Models;

public class CsvDiffResult
{
    public string FileName { get; set; } = "";
    public string Status { get; set; } = "";
    public int LeftRows { get; set; }
    public int RightRows { get; set; }
    public int DiffRows { get; set; }

    public string LeftPath { get; set; } = "";
    public string RightPath { get; set; } = "";
}

3ï¸âƒ£ CsvRowDiff.cs

using System.Collections.Generic;

namespace WslPostgresTool.Models;

public class CsvRowDiff
{
    public string Status { get; set; } = "";
    public string PrimaryKey { get; set; } = "";
    public List<CsvCellDiff> Cells { get; set; } = new();
}

4ï¸âƒ£ CsvCellDiff.cs

namespace WslPostgresTool.Models;

public class CsvCellDiff
{
    public string Column { get; set; } = "";
    public string? Left { get; set; }
    public string? Right { get; set; }

    public bool IsDifferent => !string.Equals(Left, Right, StringComparison.Ordinal);
}


â¸»

å››ã€Services

1ï¸âƒ£ LoggingService.cs

using System;

namespace WslPostgresTool.Services;

public class LoggingService
{
    private static readonly LoggingService _instance = new();
    public static LoggingService Instance => _instance;

    public event Action<string>? LogAdded;

    public void Log(string msg)
    {
        LogAdded?.Invoke($"[{DateTime.Now:HH:mm:ss}] {msg}");
    }
}

2ï¸âƒ£ WslService.cs

using System.Diagnostics;
using System.Threading.Tasks;

namespace WslPostgresTool.Services;

public class WslService
{
    public async Task<bool> IsWslAvailableAsync()
    {
        try
        {
            var p = new ProcessStartInfo("wsl.exe", "--status")
            {
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false
            };
            var proc = Process.Start(p)!;
            await proc.WaitForExitAsync();
            return proc.ExitCode == 0;
        }
        catch
        {
            return false;
        }
    }

    public async Task<bool> IsPostgresRunningAsync()
    {
        try
        {
            var p = new ProcessStartInfo("wsl.exe", "pg_isready")
            {
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false
            };
            var proc = Process.Start(p)!;
            await proc.WaitForExitAsync();
            return proc.ExitCode == 0;
        }
        catch
        {
            return false;
        }
    }

    public async Task<(bool wsl, bool pg)> GetStatusAsync()
    {
        var wsl = await IsWslAvailableAsync();
        var pg = wsl && await IsPostgresRunningAsync();
        return (wsl, pg);
    }
}

3ï¸âƒ£ PostgresService.cs

using Npgsql;
using System.Collections.Generic;
using System.Threading.Tasks;

namespace WslPostgresTool.Services;

public class PostgresService
{
    public async Task<List<string>> LoadPrimaryKeyAsync(string connStr, string schema, string table)
    {
        var keys = new List<string>();
        await using var conn = new NpgsqlConnection(connStr);
        await conn.OpenAsync();

        const string sql = """
            SELECT kcu.column_name
            FROM information_schema.table_constraints tc
            JOIN information_schema.key_column_usage kcu
              ON tc.constraint_name = kcu.constraint_name
             AND tc.table_schema = kcu.table_schema
            WHERE tc.constraint_type = 'PRIMARY KEY'
              AND tc.table_schema = @schema
              AND tc.table_name = @table
            ORDER BY kcu.ordinal_position;
        """;

        await using var cmd = new NpgsqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("schema", schema);
        cmd.Parameters.AddWithValue("table", table);

        await using var reader = await cmd.ExecuteReaderAsync();
        while (await reader.ReadAsync())
            keys.Add(reader.GetString(0));

        return keys;
    }
}

4ï¸âƒ£ CsvCompareService.cs

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using WslPostgresTool.Models;

namespace WslPostgresTool.Services;

public class CsvCompareService
{
    private readonly PostgresService _pg = new();

    public async Task<(CsvDiffResult summary, List<CsvRowDiff> rows)>
        CompareTableAsync(string leftCsv, string rightCsv, string schema, string connStr)
    {
        var table = Path.GetFileNameWithoutExtension(leftCsv);
        var pkColumns = await _pg.LoadPrimaryKeyAsync(connStr, schema, table);
        if (pkColumns.Count == 0)
            throw new Exception($"Table {table} has no primary key.");

        var leftDict = LoadCsvByPk(leftCsv, pkColumns);
        var rightDict = LoadCsvByPk(rightCsv, pkColumns);

        var diffs = new List<CsvRowDiff>();
        var allKeys = leftDict.Keys.Union(rightDict.Keys);

        foreach (var key in allKeys)
        {
            leftDict.TryGetValue(key, out var l);
            rightDict.TryGetValue(key, out var r);

            if (l == null)
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Added",
                    PrimaryKey = key,
                    Cells = r.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Right = v
                    }).ToList()
                });
            }
            else if (r == null)
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Removed",
                    PrimaryKey = key,
                    Cells = l.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Left = v
                    }).ToList()
                });
            }
            else if (!l.SequenceEqual(r))
            {
                diffs.Add(new CsvRowDiff
                {
                    Status = "Modified",
                    PrimaryKey = key,
                    Cells = l.Select((v, i) => new CsvCellDiff
                    {
                        Column = i.ToString(),
                        Left = v,
                        Right = r[i]
                    }).ToList()
                });
            }
        }

        return (new CsvDiffResult
        {
            FileName = table,
            Status = diffs.Any() ? "Modified" : "Same",
            LeftRows = leftDict.Count,
            RightRows = rightDict.Count,
            DiffRows = diffs.Count,
            LeftPath = leftCsv,
            RightPath = rightCsv
        }, diffs);
    }

    private Dictionary<string, string[]> LoadCsvByPk(string file, List<string> pkColumns)
    {
        using var reader = new StreamReader(file);
        var header = reader.ReadLine()!.Split(',');
        var pkIndexes = pkColumns.Select(c => Array.IndexOf(header, c)).ToArray();

        var dict = new Dictionary<string, string[]>();
        string? line;
        while ((line = reader.ReadLine()) != null)
        {
            var cols = line.Split(',');
            var key = string.Join("||", pkIndexes.Select(i => cols[i]));
            dict[key] = cols;
        }

        return dict;
    }
}

5ï¸âƒ£ ExcelReportService.cs

using ClosedXML.Excel;
using System.Collections.Generic;
using WslPostgresTool.Models;

namespace WslPostgresTool.Services;

public class ExcelReportService
{
    public void GenerateKeyDiffReport(string output,
        CsvDiffResult summary, List<CsvRowDiff> rows)
    {
        using var wb = new XLWorkbook();
        var ws = wb.AddWorksheet("Summary");
        ws.Cell(1, 1).InsertTable(new[] { summary });

        var diff = wb.AddWorksheet("Diff");
        diff.Cell(1, 1).Value = "Status";
        diff.Cell(1, 2).Value = "Primary Key";
        diff.Cell(1, 3).Value = "Left";
        diff.Cell(1, 4).Value = "Right";

        var rowIdx = 2;
        foreach (var r in rows)
        {
            foreach (var c in r.Cells)
            {
                diff.Cell(rowIdx, 1).Value = r.Status;
                diff.Cell(rowIdx, 2).Value = r.PrimaryKey;
                diff.Cell(rowIdx, 3).Value = c.Left;
                diff.Cell(rowIdx, 4).Value = c.Right;

                if (c.IsDifferent) diff.Row(rowIdx).Style.Fill.BackgroundColor = XLColor.LightSalmon;
                rowIdx++;
            }
        }

        wb.SaveAs(output);
    }
}


â¸»

äº”ã€Converters

BoolToBrushConverter.cs

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace WslPostgresTool.Converters;

public class BoolToBrushConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        => (bool)value ? Brushes.Green : Brushes.Red;

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotSupportedException();
}

DiffColorConverter.cs

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace WslPostgresTool.Converters;

public class DiffColorConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        => (bool)value ? Brushes.LightSalmon : Brushes.Transparent;

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotSupportedException();
}


â¸»

å…­ã€ViewModels

MainWindowViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System;
using System.Collections.ObjectModel;
using System.Threading.Tasks;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class MainWindowViewModel : ObservableObject
{
    private readonly WslService _wsl = new();
    private readonly LoggingService _log = LoggingService.Instance;

    [ObservableProperty] private bool wslOk;
    [ObservableProperty] private bool postgresOk;

    [ObservableProperty] private ObservableCollection<string> logs = new();

    public MainWindowViewModel()
    {
        _log.LogAdded += msg => logs.Add(msg);
        var timer = new System.Timers.Timer(5000);
        timer.Elapsed += async (_, _) =>
        {
            var (wsl, pg) = await _wsl.GetStatusAsync();
            WslOk = wsl;
            PostgresOk = pg;
        };
        timer.Start();
    }
}

CsvCompareViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class CsvCompareViewModel : ObservableObject
{
    private readonly CsvCompareService _compare = new();
    private readonly ExcelReportService _excel = new();
    private readonly LoggingService _log = LoggingService.Instance;

    [ObservableProperty] private string leftFolder = "";
    [ObservableProperty] private string rightFolder = "";

    public ObservableCollection<CsvDiffResult> Results { get; } = new();

    [RelayCommand]
    public async Task CompareAsync()
    {
        Results.Clear();
        var files = Directory.GetFiles(LeftFolder, "*.csv");

        foreach (var left in files)
        {
            var name = Path.GetFileName(left);
            var right = Path.Combine(RightFolder, name);
            if (!File.Exists(right)) continue;

            var (summary, _) = await _compare.CompareTableAsync(
                left, right, Models.AppState.Instance.Schema, Models.AppState.Instance.ConnectionString);

            summary.LeftPath = left;
            summary.RightPath = right;

            Results.Add(summary);
        }
        _log.Log($"Compared {Results.Count} CSV files.");
    }
}

CsvRowDiffViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using System.Linq;
using WslPostgresTool.Models;
using WslPostgresTool.Services;

namespace WslPostgresTool.ViewModels;

public partial class CsvRowDiffViewModel : ObservableObject
{
    public string TableName { get; }
    public string Schema { get; }
    public ObservableCollection<CsvRowDiff> Rows { get; }

    [ObservableProperty]
    private string statusFilter = "All";

    public CsvRowDiffViewModel(string table, string schema, IEnumerable<CsvRowDiff> rows)
    {
        TableName = table;
        Schema = schema;
        Rows = new ObservableCollection<CsvRowDiff>(rows);
    }

    public IEnumerable<string> StatusOptions => new[] { "All", "Added", "Removed", "Modified" };

    public IEnumerable<CsvRowDiff> FilteredRows =>
        StatusFilter == "All" ? Rows : Rows.Where(r => r.Status == StatusFilter);

    partial void OnStatusFilterChanged(string _)
    {
        OnPropertyChanged(nameof(FilteredRows));
    }

    [RelayCommand]
    public void ExportExcel()
    {
        var path = $"Diff_{TableName}.xlsx";
        new ExcelReportService().GenerateKeyDiffReport(path, new CsvDiffResult(), Rows.ToList());
    }

    [RelayCommand]
    public void Close()
    {
        // å°†ç”± Window ç»‘å®šå®ç°å…³é—­
    }
}


â¸»

ä¸ƒã€Views

CsvCompareView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WslPostgresTool.ViewModels">
    <DockPanel>
        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Spacing="8">
            <TextBox Width="250" Text="{Binding LeftFolder}" Watermark="Left CSV Folder"/>
            <TextBox Width="250" Text="{Binding RightFolder}" Watermark="Right CSV Folder"/>
            <Button Content="Compare" Command="{Binding CompareCommand}"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding Results}" AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Table" Binding="{Binding FileName}" Width="*"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="*"/>
                <DataGridTextColumn Header="Diff Rows" Binding="{Binding DiffRows}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>
    </DockPanel>
</UserControl>

CsvRowDiffWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:WslPostgresTool.Converters"
        Title="{Binding TableName}" Width="1000" Height="600">

    <DockPanel Margin="12">
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8">
            <ComboBox Width="160" Items="{Binding StatusOptions}" SelectedItem="{Binding StatusFilter}"/>
        </StackPanel>

        <DataGrid ItemsSource="{Binding FilteredRows}" AutoGenerateColumns="False" IsReadOnly="True">
            <DataGrid.Columns>
                <DataGridTextColumn Header="PK" Binding="{Binding PrimaryKey}" Width="200"/>
                <DataGridTemplateColumn Header="Fields">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ItemsControl ItemsSource="{Binding Cells}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="4" Background="{Binding IsDifferent, Converter={StaticResource DiffColorConverter}}">
                                            <TextBlock>
                                                <Run Text="{Binding Column}"/>
                                                <Run Text=": "/>
                                                <Run Text="{Binding Left}"/>
                                                <Run Text=" â†’ "/>
                                                <Run Text="{Binding Right}"/>
                                            </TextBlock>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
            <Button Content="Export Excel" Command="{Binding ExportExcelCommand}"/>
            <Button Content="Close" Command="{Binding CloseCommand}"/>
        </StackPanel>
    </DockPanel>
</Window>


â¸»

âœ… ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª Avalonia å·¥ç¨‹ç»“æ„ + æ ¸å¿ƒä»£ç ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
	â€¢	WSL çŠ¶æ€æ£€æµ‹
	â€¢	PostgreSQL è¿æ¥ä¸ä¸»é”®è·å–
	â€¢	CSV æ–‡ä»¶å¤¹ diffï¼ˆè¡¨çº§ + è¡Œçº§ï¼‰
	â€¢	è¡Œçº§å­—æ®µå·®å¼‚é«˜äº®
	â€¢	Excel æŠ¥å‘Šå¯¼å‡º

â¸»

æˆ‘å¯ä»¥ä¸‹ä¸€æ­¥å¸®ä½ å¢åŠ â€œç™¾ä¸‡è¡Œ CSV æµå¼ UI è™šæ‹ŸåŒ–æ˜¾ç¤º + DataGrid è¡Œåˆ†é¡µâ€ï¼Œè®©è¿™ä¸ªå·¥å…·å¯¹è¶…å¤§æ•°æ®é›†å®Œå…¨ä¸å¡é¡¿ã€‚

ä½ æƒ³è®©æˆ‘ç›´æ¥å¸®ä½ åŠ å—ï¼Ÿ