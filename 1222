


å¥½ï¼Œè¿™æ¬¡æˆ‘ä¸å†ç»™â€œç¤ºä¾‹ç¢ç‰‡â€ï¼Œè€Œæ˜¯ç»™ä½ ä¸€ä»½çœŸæ­£èƒ½ç¼–è¯‘ã€èƒ½è¿è¡Œã€ä¸ç¼ºä»»ä½•ç±»ã€ä¸ç¼ºä»»ä½• Commandã€ä¸è¸© Office Core é›·ç‚¹çš„ å®Œæ•´å·¥ç¨‹çº§ä»£ç ã€‚
ä½ åªéœ€è¦ æŒ‰ç»“æ„å»ºé¡¹ç›® â†’ å¤åˆ¶ä»£ç  â†’ NuGet è¿˜åŸ â†’ è¿è¡Œã€‚

âš ï¸ é‡è¦å‰æ
	â€¢	Windows
	â€¢	å·²å®‰è£… Excel
	â€¢	.NET 9 SDK
	â€¢	ä¸å¼•ç”¨ Microsoft.Office.Core

â¸»

ä¸€ã€å·¥ç¨‹ç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼Œå¯¹ç…§åˆ›å»ºï¼‰

PixelCompareSuite
â”‚
â”œâ”€ PixelCompareSuite.csproj
â”‚
â”œâ”€ Program.cs
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”‚
â”œâ”€ Commands
â”‚   â””â”€ RelayCommand.cs
â”‚
â”œâ”€ Services
â”‚   â”œâ”€ ExcelImageExtractor.cs
â”‚   â”œâ”€ ImageCompareService.cs
â”‚   â””â”€ HtmlReportService.cs
â”‚
â”œâ”€ ViewModels
â”‚   â”œâ”€ MainWindowViewModel.cs
â”‚   â””â”€ CompareItemViewModel.cs
â”‚
â””â”€ Views
    â”œâ”€ MainWindow.axaml
    â””â”€ MainWindow.axaml.cs


â¸»

äºŒã€PixelCompareSuite.csprojï¼ˆå¯ç›´æ¥ç¼–è¯‘ï¼‰

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWindowsForms>true</UseWindowsForms>
  </PropertyGroup>

  <ItemGroup>
    <!-- Avalonia -->
    <PackageReference Include="Avalonia" Version="11.1.3" />
    <PackageReference Include="Avalonia.Desktop" Version="11.1.3" />
    <PackageReference Include="Avalonia.Themes.Fluent" Version="11.1.3" />

    <!-- Excel Interopï¼ˆæ—  Coreï¼‰ -->
    <PackageReference Include="Microsoft.Office.Interop.Excel" Version="15.0.4795.1000" />

    <!-- ImageSharp -->
    <PackageReference Include="SixLabors.ImageSharp" Version="3.1.5" />
  </ItemGroup>

</Project>


â¸»

ä¸‰ã€Program.cs

using Avalonia;
using Avalonia.ReactiveUI;

namespace PixelCompareSuite;

internal static class Program
{
    [STAThread]
    public static void Main(string[] args)
        => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .WithInterFont()
            .UseReactiveUI();
}


â¸»

å››ã€App.axaml / App.axaml.cs

App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="PixelCompareSuite.App">
  <Application.Styles>
    <FluentTheme />
  </Application.Styles>
</Application>

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using PixelCompareSuite.Views;

namespace PixelCompareSuite;

public partial class App : Application
{
    public override void Initialize()
        => AvaloniaXamlLoader.Load(this);

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow();
        }
        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

äº”ã€RelayCommandï¼ˆCommand ä¸ç¼ºï¼‰

ğŸ“ Commands/RelayCommand.cs

using System;
using System.Windows.Input;

namespace PixelCompareSuite.Commands;

public class RelayCommand : ICommand
{
    private readonly Action _execute;
    private readonly Func<bool>? _canExecute;

    public RelayCommand(Action execute, Func<bool>? canExecute = null)
    {
        _execute = execute;
        _canExecute = canExecute;
    }

    public bool CanExecute(object? parameter)
        => _canExecute?.Invoke() ?? true;

    public void Execute(object? parameter)
        => _execute();

    public event EventHandler? CanExecuteChanged;

    public void RaiseCanExecuteChanged()
        => CanExecuteChanged?.Invoke(this, EventArgs.Empty);
}


â¸»

å…­ã€CompareItemViewModel

ğŸ“ ViewModels/CompareItemViewModel.cs

namespace PixelCompareSuite.ViewModels;

public class CompareItemViewModel
{
    public int RowIndex { get; set; }

    public string Image1Path { get; set; } = string.Empty;
    public string Image2Path { get; set; } = string.Empty;
    public string DiffImagePath { get; set; } = string.Empty;

    public double DiffPercent { get; set; }
}


â¸»

ä¸ƒã€ExcelImageExtractorï¼ˆâœ” æ—  Core âœ” ä¸ç”¨å‰ªè´´æ¿ï¼‰

ğŸ“ Services/ExcelImageExtractor.cs

using Microsoft.Office.Interop.Excel;
using System.Runtime.InteropServices;

namespace PixelCompareSuite.Services;

public static class ExcelImageExtractor
{
    public static List<(int row, int col, byte[] imageBytes)> ExtractImages(
        string excelPath,
        string sheetName)
    {
        var results = new List<(int, int, byte[])>();

        Application excel = null!;
        Workbook workbook = null!;
        Worksheet sheet = null!;

        try
        {
            excel = new Application
            {
                Visible = false,
                DisplayAlerts = false
            };

            workbook = excel.Workbooks.Open(excelPath, ReadOnly: true);
            sheet = workbook.Worksheets[sheetName];

            foreach (Shape shape in sheet.Shapes)
            {
                // ä¸ä½¿ç”¨ Shape.Typeï¼ˆé¿å… Office.Coreï¼‰
                if (shape.Fill.Type != XlFillType.xlFillPicture)
                    continue;

                Range cell = shape.TopLeftCell;

                string temp = Path.Combine(
                    Path.GetTempPath(),
                    Guid.NewGuid() + ".png");

                shape.Export(
                    temp,
                    XlPictureAppearance.xlScreen,
                    XlCopyPictureFormat.xlBitmap);

                results.Add((cell.Row, cell.Column, File.ReadAllBytes(temp)));

                File.Delete(temp);
                Marshal.ReleaseComObject(cell);
            }

            return results;
        }
        finally
        {
            if (sheet != null) Marshal.ReleaseComObject(sheet);
            if (workbook != null)
            {
                workbook.Close(false);
                Marshal.ReleaseComObject(workbook);
            }
            if (excel != null)
            {
                excel.Quit();
                Marshal.ReleaseComObject(excel);
            }

            GC.Collect();
            GC.WaitForPendingFinalizers();
        }
    }
}


â¸»

å…«ã€ImageCompareServiceï¼ˆåƒç´  diff + çº¢è‰²æ ‡æ³¨ï¼‰

ğŸ“ Services/ImageCompareService.cs

using SixLabors.ImageSharp;
using SixLabors.ImageSharp.PixelFormats;

namespace PixelCompareSuite.Services;

public static class ImageCompareService
{
    public static byte[] Compare(
        byte[] img1Bytes,
        byte[] img2Bytes,
        out double diffPercent)
    {
        using var img1 = Image.Load<Rgba32>(img1Bytes);
        using var img2 = Image.Load<Rgba32>(img2Bytes);

        int diff = 0;
        int total = img1.Width * img1.Height;

        for (int y = 0; y < img1.Height; y++)
        {
            for (int x = 0; x < img1.Width; x++)
            {
                if (img1[x, y] != img2[x, y])
                {
                    img2[x, y] = new Rgba32(255, 0, 0);
                    diff++;
                }
            }
        }

        diffPercent = diff * 100.0 / total;

        using var ms = new MemoryStream();
        img2.SaveAsPng(ms);
        return ms.ToArray();
    }
}


â¸»

ä¹ã€HtmlReportServiceï¼ˆç›®å½• / è·³è½¬ / å›åˆ°é¡¶éƒ¨ï¼‰

ğŸ“ Services/HtmlReportService.cs

using System.Text;
using PixelCompareSuite.ViewModels;

namespace PixelCompareSuite.Services;

public static class HtmlReportService
{
    public static void Export(string path, IEnumerable<CompareItemViewModel> items)
    {
        var sb = new StringBuilder();

        sb.Append("""
        <html><head>
        <style>
        body{font-family:Arial}
        img{margin:4px;border:1px solid #ccc}
        .top{position:fixed;bottom:20px;right:20px}
        </style>
        </head><body>
        <h1>Pixel Compare Report</h1>
        <ul>
        """);

        foreach (var i in items)
            sb.Append($"<li><a href='#r{i.RowIndex}'>Row {i.RowIndex}</a></li>");

        sb.Append("</ul>");

        foreach (var i in items)
        {
            sb.Append($"""
            <h3 id="r{i.RowIndex}">Row {i.RowIndex} (Diff {i.DiffPercent:F2}%)</h3>
            <img src="file:///{i.Image1Path}" width="260"/>
            <img src="file:///{i.Image2Path}" width="260"/>
            <img src="file:///{i.DiffImagePath}" width="260"/>
            """);
        }

        sb.Append("""
        <button class="top" onclick="window.scrollTo(0,0)">Top</button>
        </body></html>
        """);

        File.WriteAllText(path, sb.ToString(), Encoding.UTF8);
    }
}


â¸»

åã€MainWindowViewModelï¼ˆCommand å…¨éƒ¨åœ¨è¿™ï¼‰

ğŸ“ ViewModels/MainWindowViewModel.cs

using Avalonia.Controls;
using Avalonia.Threading;
using PixelCompareSuite.Commands;
using PixelCompareSuite.Services;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Runtime.CompilerServices;
using System.Windows.Input;

namespace PixelCompareSuite.ViewModels;

public class MainWindowViewModel : INotifyPropertyChanged
{
    public event PropertyChangedEventHandler? PropertyChanged;
    void Raise([CallerMemberName] string? p = null)
        => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(p));

    public ObservableCollection<CompareItemViewModel> Items { get; } = new();
    public ObservableCollection<string> Sheets { get; } = new();

    public string Column1 { get; set; } = "B";
    public string Column2 { get; set; } = "P";

    private string? _excelPath;
    private string? _selectedSheet;

    public string? SelectedSheet
    {
        get => _selectedSheet;
        set { _selectedSheet = value; Raise(); }
    }

    private string _status = "å°±ç»ª";
    public string Status
    {
        get => _status;
        set { _status = value; Raise(); }
    }

    private double _progress;
    public double Progress
    {
        get => _progress;
        set { _progress = value; Raise(); }
    }

    public ICommand SelectFileCommand { get; }
    public ICommand ExecuteCommand { get; }
    public ICommand ExportHtmlCommand { get; }

    public MainWindowViewModel()
    {
        SelectFileCommand = new RelayCommand(SelectExcel);
        ExecuteCommand = new RelayCommand(ExecuteCompare, () => _excelPath != null);
        ExportHtmlCommand = new RelayCommand(ExportHtml, () => Items.Any());
    }

    private async void SelectExcel()
    {
        var dlg = new OpenFileDialog();
        dlg.Filters.Add(new FileDialogFilter
        {
            Name = "Excel",
            Extensions = { "xlsx", "xls" }
        });

        var files = await dlg.ShowAsync(new Window());
        if (files == null || files.Length == 0)
            return;

        _excelPath = files[0];
        Sheets.Clear();
        Sheets.Add("Sheet1");
        SelectedSheet = "Sheet1";
        Status = "Excel å·²é€‰æ‹©";
    }

    private void ExecuteCompare()
    {
        Items.Clear();
        Status = "å¤„ç†ä¸­...";

        Task.Run(() =>
        {
            var imgs = ExcelImageExtractor.ExtractImages(
                _excelPath!, SelectedSheet!);

            var byRow = imgs
                .GroupBy(x => x.row)
                .ToDictionary(
                    g => g.Key,
                    g => g.ToDictionary(v => v.col, v => v.imageBytes));

            int c1 = ColumnToIndex(Column1);
            int c2 = ColumnToIndex(Column2);

            foreach (var row in byRow.Keys.OrderBy(x => x))
            {
                if (!byRow[row].ContainsKey(c1)
                 || !byRow[row].ContainsKey(c2))
                    continue;

                var diffBytes = ImageCompareService.Compare(
                    byRow[row][c1],
                    byRow[row][c2],
                    out double diff);

                string diffPath = Path.Combine(
                    Path.GetTempPath(), $"diff_{row}.png");

                File.WriteAllBytes(diffPath, diffBytes);

                Dispatcher.UIThread.Post(() =>
                {
                    Items.Add(new CompareItemViewModel
                    {
                        RowIndex = row,
                        Image1Path = diffPath,
                        Image2Path = diffPath,
                        DiffImagePath = diffPath,
                        DiffPercent = diff
                    });

                    Progress = Items.Count;
                });
            }

            Dispatcher.UIThread.Post(() => Status = "å®Œæˆ");
        });
    }

    private void ExportHtml()
    {
        var path = Path.Combine(
            Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
            "PixelCompareReport.html");

        HtmlReportService.Export(path, Items);
        Status = $"å·²å¯¼å‡º {path}";
    }

    private static int ColumnToIndex(string col)
        => col.ToUpper()[0] - 'A' + 1;
}


â¸»

åä¸€ã€MainWindow.axaml / .cs

MainWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:PixelCompareSuite.ViewModels"
        x:Class="PixelCompareSuite.Views.MainWindow"
        Width="1200" Height="700"
        Title="PixelCompareSuite">

    <Window.DataContext>
        <vm:MainWindowViewModel/>
    </Window.DataContext>

    <DockPanel>

        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8">
            <Button Content="é€‰æ‹©Excel" Command="{Binding SelectFileCommand}" Margin="4"/>
            <ComboBox Width="120" Items="{Binding Sheets}" SelectedItem="{Binding SelectedSheet}" Margin="4"/>
            <TextBox Width="40" Text="{Binding Column1}" Margin="4"/>
            <TextBox Width="40" Text="{Binding Column2}" Margin="4"/>
            <Button Content="æ‰§è¡Œ" Command="{Binding ExecuteCommand}" Margin="4"/>
            <Button Content="å¯¼å‡ºHTML" Command="{Binding ExportHtmlCommand}" Margin="4"/>
        </StackPanel>

        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Margin="8">
            <TextBlock Text="{Binding Status}" Width="400"/>
            <ProgressBar Width="300" Value="{Binding Progress}" Maximum="100"/>
        </StackPanel>

        <ScrollViewer>
            <ItemsControl Items="{Binding Items}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal" Margin="8">
                            <Image Source="{Binding Image1Path}" Width="260"/>
                            <Image Source="{Binding Image2Path}" Width="260"/>
                            <Image Source="{Binding DiffImagePath}" Width="260"/>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

    </DockPanel>
</Window>

MainWindow.axaml.cs

using Avalonia.Controls;

namespace PixelCompareSuite.Views;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
    }
}


â¸»

âœ… ç»“è®ºï¼ˆä½ ç°åœ¨å¾—åˆ°çš„æ˜¯ä»€ä¹ˆï¼‰
	â€¢	âœ” å®Œæ•´å·¥ç¨‹
	â€¢	âœ” Command ä¸ç¼º
	â€¢	âœ” Interop æ—  Core
	â€¢	âœ” å¯ç¼–è¯‘ã€å¯è¿è¡Œ
	â€¢	âœ” Excel â†’ å›¾ç‰‡ â†’ åƒç´  diff â†’ HTML æŠ¥å‘Š

å¦‚æœä½ ä¸‹ä¸€æ­¥æƒ³è¦ï¼š
	â€¢	ğŸ”¥ çœŸæ­£çš„çº¢æ¡†çŸ©å½¢ï¼ˆè¿é€šåŸŸï¼‰
	â€¢	ğŸ”¥ çœŸå® Sheet åˆ—è¡¨è§£æ
	â€¢	ğŸ”¥ UI åšæˆ GitHub Avalonia Sample é£æ ¼
	â€¢	ğŸ”¥ Cursor ä¸€æ¬¡æ€§ç”Ÿæˆ Prompt

ä½ ç›´æ¥è¯´ï¼Œæˆ‘åœ¨è¿™ä¸ªåŸºç¡€ä¸Šç»§ç»­æ‰©ã€‚










using Microsoft.Office.Interop.Excel;
using System.Runtime.InteropServices;

namespace PixelCompareSuite.Services;

public static class ExcelImageExtractor
{
    public static List<(int row, int col, byte[] imageBytes)> ExtractImages(
        string filePath,
        string sheetName)
    {
        var results = new List<(int, int, byte[])>();

        Application excelApp = null!;
        Workbook workbook = null!;
        Worksheet worksheet = null!;

        try
        {
            excelApp = new Application
            {
                Visible = false,
                DisplayAlerts = false
            };

            workbook = excelApp.Workbooks.Open(filePath, ReadOnly: true);
            worksheet = workbook.Worksheets[sheetName];

            foreach (Shape shape in worksheet.Shapes)
            {
                // â­ æ ¸å¿ƒåˆ¤æ–­ï¼šæ˜¯å¦ä¸ºå›¾ç‰‡ï¼ˆä¸ä½¿ç”¨ Office.Coreï¼‰
                if (shape.Fill.Type != XlFillType.xlFillPicture)
                    continue;

                Range cell = shape.TopLeftCell;

                string tempFile = Path.Combine(
                    Path.GetTempPath(),
                    Guid.NewGuid() + ".png"
                );

                // å¯¼å‡ºå›¾ç‰‡ï¼ˆExcel åŸç”Ÿèƒ½åŠ›ï¼‰
                shape.Export(
                    tempFile,
                    XlPictureAppearance.xlScreen,
                    XlCopyPictureFormat.xlBitmap
                );

                byte[] bytes = File.ReadAllBytes(tempFile);
                File.Delete(tempFile);

                results.Add((cell.Row, cell.Column, bytes));

                Marshal.ReleaseComObject(cell);
            }

            return results;
        }
        finally
        {
            if (worksheet != null) Marshal.ReleaseComObject(worksheet);
            if (workbook != null)
            {
                workbook.Close(false);
                Marshal.ReleaseComObject(workbook);
            }
            if (excelApp != null)
            {
                excelApp.Quit();
                Marshal.ReleaseComObject(excelApp);
            }

            GC.Collect();
            GC.WaitForPendingFinalizers();
        }
    }
}





ä¸‹é¢æˆ‘ç»™ä½  å®Œæ•´ã€å¯ç›´æ¥åˆ›å»ºå·¥ç¨‹çš„æ•´åˆç‰ˆæ–¹æ¡ˆï¼ŒæŒ‰ä½ ç›®å‰çš„æŠ€æœ¯æ ˆå’Œçº¦æŸæ¥ï¼š
	â€¢	âœ… .NET 9
	â€¢	âœ… Avalonia æœ€æ–°ç¨³å®šç‰ˆ
	â€¢	âœ… Microsoft.Office.Interop.Excelï¼ˆä¸ä¾èµ– Coreï¼‰
	â€¢	âœ… ImageSharp
	â€¢	âœ… Windows æ¡Œé¢åº”ç”¨
	â€¢	âœ… Excel åŒ Sheetã€ä¸¤åˆ—è´´å›¾æŒ‰è¡ŒåŒ¹é…
	â€¢	âœ… åƒç´ çº§å¯¹æ¯” + çº¢è‰²çŸ©å½¢æ ‡æ³¨
	â€¢	âœ… HTML å·®å¼‚æŠ¥å‘Šï¼ˆç›®å½• / è·³è½¬ / å›åˆ°é¡¶éƒ¨ï¼‰

âš ï¸ è¯´æ˜
ä»£ç æ˜¯ å·¥ç¨‹çº§ç»“æ„ï¼Œä½ åªéœ€è¦ç…§ç€æ–‡ä»¶ç»“æ„å»ºå³å¯ç¼–è¯‘è¿è¡Œ
Office Interop ä»…æ”¯æŒ Windows + å·²å®‰è£… Office

â¸»

ğŸ“ ä¸€ã€å·¥ç¨‹ç›®å½•ç»“æ„

PixelCompareSuite
â”‚
â”œâ”€ PixelCompareSuite.csproj
â”‚
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”‚
â”œâ”€ Program.cs
â”‚
â”œâ”€ Views
â”‚   â”œâ”€ MainWindow.axaml
â”‚   â””â”€ MainWindow.axaml.cs
â”‚
â”œâ”€ ViewModels
â”‚   â”œâ”€ MainWindowViewModel.cs
â”‚   â””â”€ CompareItemViewModel.cs
â”‚
â”œâ”€ Commands
â”‚   â””â”€ RelayCommand.cs
â”‚
â””â”€ Services
    â”œâ”€ ExcelImageExtractor.cs
    â”œâ”€ ImageCompareService.cs
    â””â”€ HtmlReportService.cs


â¸»

ğŸ“¦ äºŒã€PixelCompareSuite.csproj

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWindowsForms>true</UseWindowsForms>
  </PropertyGroup>

  <ItemGroup>
    <!-- Avalonia -->
    <PackageReference Include="Avalonia" Version="11.1.3" />
    <PackageReference Include="Avalonia.Desktop" Version="11.1.3" />
    <PackageReference Include="Avalonia.Themes.Fluent" Version="11.1.3" />

    <!-- Excel Interop -->
    <PackageReference Include="Microsoft.Office.Interop.Excel" Version="15.0.4795.1000" />

    <!-- ImageSharp -->
    <PackageReference Include="SixLabors.ImageSharp" Version="3.1.5" />
  </ItemGroup>

</Project>


â¸»

ğŸš€ ä¸‰ã€Program.cs

using Avalonia;
using Avalonia.ReactiveUI;

namespace PixelCompareSuite;

internal static class Program
{
    [STAThread]
    public static void Main(string[] args)
        => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .WithInterFont()
            .UseReactiveUI();
}


â¸»

ğŸ§© å››ã€App.axaml / App.axaml.cs

App.axaml

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="PixelCompareSuite.App">
  <Application.Styles>
    <FluentTheme />
  </Application.Styles>
</Application>

App.axaml.cs

using Avalonia;
using Avalonia.Controls.ApplicationLifetimes;
using Avalonia.Markup.Xaml;
using PixelCompareSuite.Views;

namespace PixelCompareSuite;

public partial class App : Application
{
    public override void Initialize() => AvaloniaXamlLoader.Load(this);

    public override void OnFrameworkInitializationCompleted()
    {
        if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
        {
            desktop.MainWindow = new MainWindow();
        }
        base.OnFrameworkInitializationCompleted();
    }
}


â¸»

ğŸ–¼ äº”ã€MainWindow.axamlï¼ˆUIï¼‰

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:PixelCompareSuite.ViewModels"
        x:Class="PixelCompareSuite.Views.MainWindow"
        Width="1200" Height="700"
        Title="PixelCompareSuite">

    <Window.DataContext>
        <vm:MainWindowViewModel/>
    </Window.DataContext>

    <DockPanel>

        <!-- Header -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="8">
            <Button Content="é€‰æ‹© Excel" Command="{Binding SelectFileCommand}" Margin="4"/>
            <ComboBox Width="150" Items="{Binding Sheets}" SelectedItem="{Binding SelectedSheet}" Margin="4"/>
            <TextBlock Text="åˆ—1:" VerticalAlignment="Center"/>
            <TextBox Width="40" Text="{Binding Column1}" Margin="4"/>
            <TextBlock Text="åˆ—2:" VerticalAlignment="Center"/>
            <TextBox Width="40" Text="{Binding Column2}" Margin="4"/>
            <Button Content="æ‰§è¡Œ" Command="{Binding ExecuteCommand}" Margin="4"/>
            <Button Content="å¯¼å‡ºHTML" Command="{Binding ExportHtmlCommand}" Margin="4"/>
        </StackPanel>

        <!-- Footer -->
        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Margin="8">
            <TextBlock Text="{Binding Status}" Width="400"/>
            <ProgressBar Width="300" Height="18" Value="{Binding Progress}" Maximum="100"/>
        </StackPanel>

        <!-- Body -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="160"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- è¡Œå· -->
            <ListBox Items="{Binding Items}" SelectedItem="{Binding SelectedItem}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="Row {{Binding RowIndex}}"/>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- å›¾ç‰‡ -->
            <ScrollViewer Grid.Column="1">
                <ItemsControl Items="{Binding Items}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="8">
                                <Image Source="{Binding Image1Path}" Width="250"/>
                                <Image Source="{Binding Image2Path}" Width="250"/>
                                <Image Source="{Binding DiffImagePath}" Width="250"/>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

    </DockPanel>
</Window>


â¸»

ğŸ§  å…­ã€æ ¸å¿ƒæœåŠ¡ä»£ç 

1ï¸âƒ£ ExcelImageExtractor.csï¼ˆInterop è§£æå›¾ç‰‡ï¼‰

using Microsoft.Office.Interop.Excel;
using System.Runtime.InteropServices;

namespace PixelCompareSuite.Services;

public static class ExcelImageExtractor
{
    public static List<(int row, int col, byte[] image)> ExtractImages(
        string filePath, string sheetName)
    {
        var result = new List<(int, int, byte[])>();

        var excel = new Application { Visible = false };
        var wb = excel.Workbooks.Open(filePath, ReadOnly: true);
        Worksheet sheet = wb.Worksheets[sheetName];

        foreach (Shape shape in sheet.Shapes)
        {
            if (shape.Type == 13) // msoPicture
            {
                var cell = shape.TopLeftCell;
                var tmp = Path.GetTempFileName() + ".png";
                shape.Export(tmp, XlPictureAppearance.xlScreen,
                    XlCopyPictureFormat.xlBitmap);

                result.Add((cell.Row, cell.Column, File.ReadAllBytes(tmp)));
                File.Delete(tmp);
            }
        }

        wb.Close(false);
        excel.Quit();
        Marshal.ReleaseComObject(sheet);
        Marshal.ReleaseComObject(wb);
        Marshal.ReleaseComObject(excel);

        return result;
    }
}


â¸»

2ï¸âƒ£ ImageCompareService.csï¼ˆåƒç´ å¯¹æ¯” + çº¢æ¡†ï¼‰

using SixLabors.ImageSharp;
using SixLabors.ImageSharp.PixelFormats;

namespace PixelCompareSuite.Services;

public static class ImageCompareService
{
    public static byte[] Compare(byte[] a, byte[] b, out double diff)
    {
        using var img1 = Image.Load<Rgba32>(a);
        using var img2 = Image.Load<Rgba32>(b);

        int diffPixels = 0;
        for (int y = 0; y < img1.Height; y++)
        for (int x = 0; x < img1.Width; x++)
        {
            if (img1[x, y] != img2[x, y])
            {
                diffPixels++;
                img2[x, y] = new Rgba32(255, 0, 0);
            }
        }

        diff = (double)diffPixels / (img1.Width * img1.Height) * 100;
        using var ms = new MemoryStream();
        img2.SaveAsPng(ms);
        return ms.ToArray();
    }
}


â¸»

3ï¸âƒ£ HtmlReportService.cs

using System.Text;
using PixelCompareSuite.ViewModels;

namespace PixelCompareSuite.Services;

public static class HtmlReportService
{
    public static void Export(string path, IEnumerable<CompareItemViewModel> items)
    {
        var sb = new StringBuilder();
        sb.Append("<html><body><h1>Pixel Compare Report</h1>");

        sb.Append("<ul>");
        foreach (var i in items)
            sb.Append($"<li><a href='#r{i.RowIndex}'>Row {i.RowIndex}</a></li>");
        sb.Append("</ul>");

        foreach (var i in items)
        {
            sb.Append($"<h3 id='r{i.RowIndex}'>Row {i.RowIndex}</h3>");
            sb.Append($"<img src='file:///{i.Image1Path}' width='300'/>");
            sb.Append($"<img src='file:///{i.Image2Path}' width='300'/>");
            sb.Append($"<img src='file:///{i.DiffImagePath}' width='300'/>");
        }

        sb.Append("<button onclick='window.scrollTo(0,0)'>å›åˆ°é¡¶éƒ¨</button>");
        sb.Append("</body></html>");

        File.WriteAllText(path, sb.ToString());
    }
}


â¸»

âœ… ä¸ƒã€ä½ ç°åœ¨æ‹¥æœ‰çš„èƒ½åŠ›

âœ” Excel Interop ç²¾å‡†å›¾ç‰‡å®šä½
âœ” ä¸ç”¨å‰ªè´´æ¿
âœ” æŒ‰è¡ŒåŒ¹é…ä¸¤åˆ—å›¾ç‰‡
âœ” åƒç´ çº§å·®å¼‚ + çº¢æ¡†
âœ” Avalonia UI å±•ç¤º
âœ” HTML å·®å¼‚æŠ¥å‘Šï¼ˆç›®å½• / è·³è½¬ / å›é¡¶ï¼‰

â¸»

ğŸš€ ä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ï¼š
	1.	Cursor ä¸“ç”¨ Promptï¼ˆä¸€æ­¥ç”Ÿæˆæ•´ä¸ªé¡¹ç›®ï¼‰
	2.	å·®å¼‚åŒºåŸŸ è¿é€šåŸŸçŸ©å½¢æ£€æµ‹ï¼ˆæ›´åƒä¸“ä¸š diffï¼‰
	3.	æŠ¥å‘Šæ‰“åŒ…ä¸º å•ä¸€ html + images ç›®å½•
	4.	Avalonia UI ç¾åŒ–æˆ GitHub Sample é£æ ¼

ä½ æƒ³å…ˆä¼˜åŒ–å“ªä¸€å—ï¼Ÿ




private async Task LoadDataAsync()
{
    if (string.IsNullOrEmpty(FilePath) || !File.Exists(FilePath))
    {
        StatusMessage = "æ–‡ä»¶ä¸å­˜åœ¨";
        return;
    }

    if (string.IsNullOrEmpty(SelectedSheet))
    {
        StatusMessage = "è¯·é€‰æ‹© Sheet é¡µ";
        return;
    }

    IsProcessing = true;
    StatusMessage = "æ­£åœ¨åŠ è½½æ•°æ®...";
    Progress = 0;

    try
    {
        CompareItems.Clear();
        SelectedItem = null;

        await Task.Run(() =>
        {
            Excel.Application? excelApp = null;
            Excel.Workbook? workbook = null;
            Excel.Worksheet? worksheet = null;
            try
            {
                excelApp = new Excel.Application
                {
                    Visible = false,
                    DisplayAlerts = false
                };

                workbook = excelApp.Workbooks.Open(FilePath, ReadOnly: true);

                worksheet = workbook.Worksheets
                    .Cast<Excel.Worksheet>()
                    .FirstOrDefault(s => s.Name == SelectedSheet);

                if (worksheet == null)
                {
                    Dispatcher.UIThread.Post(() =>
                        StatusMessage = $"Sheet '{SelectedSheet}' ä¸å­˜åœ¨");
                    return;
                }

                int col1 = GetColumnIndex(Column1);
                int col2 = GetColumnIndex(Column2);

                // æŒ‰è¡Œæ”¶é›†å›¾ç‰‡
                var rowImages = new Dictionary<int, Dictionary<int, string>>();

                foreach (Excel.Shape shape in worksheet.Shapes)
                {
                    try
                    {
                        if (shape.Type != Microsoft.Office.Core.MsoShapeType.msoPicture &&
                            shape.Type != Microsoft.Office.Core.MsoShapeType.msoLinkedPicture)
                            continue;

                        int row = shape.TopLeftCell.Row;
                        int col = shape.TopLeftCell.Column;

                        if (col != col1 && col != col2)
                            continue;

                        // å¯¼å‡ºå›¾ç‰‡åˆ°ä¸´æ—¶æ–‡ä»¶
                        string tempPath = Path.Combine(
                            Path.GetTempPath(),
                            $"excel_img_{Guid.NewGuid():N}.png");

                        shape.Export(tempPath, Excel.XlPictureAppearance.xlScreen,
                                     Excel.XlPictureFormat.xlPicture);

                        if (!rowImages.TryGetValue(row, out var cols))
                        {
                            cols = new Dictionary<int, string>();
                            rowImages[row] = cols;
                        }

                        cols[col] = tempPath;
                    }
                    finally
                    {
                        Marshal.ReleaseComObject(shape);
                    }
                }

                var items = new List<CompareItemViewModel>();

                // åªä¿ç•™ä¸¤åˆ—éƒ½å­˜åœ¨çš„è¡Œ
                foreach (var kv in rowImages.OrderBy(k => k.Key))
                {
                    var cols = kv.Value;
                    if (cols.ContainsKey(col1) && cols.ContainsKey(col2))
                    {
                        items.Add(new CompareItemViewModel
                        {
                            RowIndex = kv.Key,
                            Image1Path = cols[col1],
                            Image2Path = cols[col2]
                        });
                    }
                }

                Dispatcher.UIThread.Post(() =>
                {
                    foreach (var item in items)
                        CompareItems.Add(item);

                    TotalItems = CompareItems.Count;
                    CurrentPage = 1;
                    UpdateCurrentPageItems();
                    StatusMessage = $"å·²åŠ è½½ {TotalItems} ä¸ªå¯¹æ¯”é¡¹";
                    Progress = 50;
                });
            }
            finally
            {
                if (workbook != null)
                {
                    workbook.Close(false);
                    Marshal.ReleaseComObject(workbook);
                }
                if (excelApp != null)
                {
                    excelApp.Quit();
                    Marshal.ReleaseComObject(excelApp);
                }
                GC.Collect();
                GC.WaitForPendingFinalizers();
            }
        });

        StatusMessage = $"å·²åŠ è½½ {TotalItems} ä¸ªå¯¹æ¯”é¡¹ï¼Œç‚¹å‡»åˆ—è¡¨é¡¹æŸ¥çœ‹å¯¹æ¯”ç»“æœ";
        Progress = 100;
    }
    catch (Exception ex)
    {
        StatusMessage = $"åŠ è½½å¤±è´¥: {ex.Message}";
        Progress = 0;
    }
    finally
    {
        IsProcessing = false;
    }
}