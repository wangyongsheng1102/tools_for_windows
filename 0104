


å¥½ï¼Œè¿™ä¸€æ­¥æˆ‘æ¥å…œåº•ã€‚
ä¸‹é¢ç»™ä½ çš„æ˜¯ä¸€ä¸ª ã€Œèƒ½ç›´æ¥è·‘èµ·æ¥ã€çš„å®Œæ•´ Avalonia + CommunityToolkit.Mvvm å·¥ç¨‹éª¨æ¶ï¼Œä¸¥æ ¼è´´åˆä½ ç°åœ¨çš„ç›®å½•ç»“æ„å’Œå‘½åä¹ æƒ¯ï¼Œåªåšå¿…è¦æ•´åˆï¼Œä¸å¼•å…¥å¤šä½™æ¦‚å¿µã€‚

âš ï¸ è¯´æ˜
	â€¢	è¿™æ˜¯ä¸€ä¸ª å¯è¿è¡Œæœ€å°å®Œæ•´å·¥ç¨‹ï¼ˆMVPï¼‰
	â€¢	å·²åŒ…å«ï¼š
âœ… æ€»è§ˆ Dashboard
âœ… ItemAï¼ˆWSL Dashboardï¼Œå¯å¯åœï¼‰
âœ… ItemB / ItemC å ä½
âœ… å‘¼å¸ç¯å¤ç”¨æ§ä»¶
âœ… LogList
âœ… è‡ªåŠ¨åˆ·æ–°
	â€¢	ä½ å¯ä»¥ ç›´æ¥å¯¹ç…§ / æ‹·è´ / diff

â¸»

ä¸€ã€é¡¹ç›®ç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼‰

ExcelFormatter12
â”œâ”€ Assets/
â”‚
â”œâ”€ Models/
â”‚  â”œâ”€ WslStatus.cs
â”‚  â””â”€ DashboardItem.cs
â”‚
â”œâ”€ Services/
â”‚  â””â”€ WslService.cs
â”‚
â”œâ”€ ViewModels/
â”‚  â”œâ”€ ViewModelBase.cs
â”‚  â”œâ”€ BaseItemViewModel.cs
â”‚  â”œâ”€ MainWindowViewModel.cs
â”‚  â”œâ”€ ItemAViewModel.cs
â”‚  â”œâ”€ ItemBViewModel.cs
â”‚  â”œâ”€ ItemCViewModel.cs
â”‚  â””â”€ WslSubsystemViewModel.cs
â”‚
â”œâ”€ Views/
â”‚  â”œâ”€ Controls/
â”‚  â”‚  â”œâ”€ StatusIndicator.axaml
â”‚  â”‚  â””â”€ StatusIndicator.axaml.cs
â”‚  â”‚
â”‚  â”œâ”€ ItemAView.axaml
â”‚  â”œâ”€ ItemBView.axaml
â”‚  â””â”€ ItemCView.axaml
â”‚
â”œâ”€ App.axaml
â”œâ”€ App.axaml.cs
â”œâ”€ MainWindow.axaml
â”œâ”€ MainWindow.axaml.cs
â””â”€ Program.cs


â¸»

äºŒã€Models

Models/WslStatus.cs

namespace ExcelFormatter12.Models;

public enum WslStatus
{
    Stopped,
    Starting,
    Running,
    Error
}

Models/DashboardItem.cs

namespace ExcelFormatter12.Models;

public class DashboardItem
{
    public string Category { get; set; } = "";
    public string Name { get; set; } = "";
    public WslStatus Status { get; set; }
}


â¸»

ä¸‰ã€Services

Services/WslService.cs

using ExcelFormatter12.Models;
using System.Diagnostics;
using System.Text;

namespace ExcelFormatter12.Services;

public static class WslService
{
    private static async Task<string> ExecAsync(string args)
    {
        var psi = new ProcessStartInfo
        {
            FileName = "cmd.exe",
            Arguments = $"/c wsl {args}",
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            UseShellExecute = false,
            CreateNoWindow = true,
            StandardOutputEncoding = Encoding.GetEncoding(932),
            StandardErrorEncoding = Encoding.GetEncoding(932)
        };

        using var p = Process.Start(psi)!;
        var output = await p.StandardOutput.ReadToEndAsync();
        await p.WaitForExitAsync();
        return output;
    }

    public static Task StartAsync(string name)
        => ExecAsync($"-d {name} --exec true");

    public static Task StopAsync(string name)
        => ExecAsync($"--terminate {name}");

    public static async Task<WslStatus> GetStatusAsync(string name)
    {
        var output = await ExecAsync("-l -v");
        if (!output.Contains(name))
            return WslStatus.Error;

        return output.Contains("Running")
            ? WslStatus.Running
            : WslStatus.Stopped;
    }
}


â¸»

å››ã€ViewModelsï¼ˆCommunityToolkit.Mvvmï¼‰

ViewModels/ViewModelBase.cs

using CommunityToolkit.Mvvm.ComponentModel;

namespace ExcelFormatter12.ViewModels;

public abstract class ViewModelBase : ObservableObject
{
}

ViewModels/BaseItemViewModel.cs

using System.Collections.ObjectModel;

namespace ExcelFormatter12.ViewModels;

public abstract partial class BaseItemViewModel : ViewModelBase
{
    public ObservableCollection<string> LogList { get; } = new();

    protected void AddLog(string msg)
        => LogList.Add($"[{DateTime.Now:HH:mm:ss}] {msg}");
}

ViewModels/WslSubsystemViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using ExcelFormatter12.Models;
using ExcelFormatter12.Services;

namespace ExcelFormatter12.ViewModels;

public partial class WslSubsystemViewModel : ObservableObject
{
    public string Name { get; }

    [ObservableProperty]
    private WslStatus status = WslStatus.Stopped;

    private readonly Action<string> _log;

    public WslSubsystemViewModel(string name, Action<string> log)
    {
        Name = name;
        _log = log;
    }

    [RelayCommand]
    private async Task Start()
    {
        Status = WslStatus.Starting;
        _log($"å¯åŠ¨ WSL: {Name}");
        await WslService.StartAsync(Name);
        await Refresh();
    }

    [RelayCommand]
    private async Task Stop()
    {
        _log($"åœæ­¢ WSL: {Name}");
        await WslService.StopAsync(Name);
        await Refresh();
    }

    public async Task Refresh()
    {
        Status = await WslService.GetStatusAsync(Name);
        _log($"{Name} çŠ¶æ€ => {Status}");
    }
}

ViewModels/ItemAViewModel.cs

using System.Collections.ObjectModel;
using System.Timers;

namespace ExcelFormatter12.ViewModels;

public partial class ItemAViewModel : BaseItemViewModel
{
    public ObservableCollection<WslSubsystemViewModel> Subsystems { get; }

    private readonly Timer _timer;

    public ItemAViewModel()
    {
        Subsystems = new()
        {
            new("Ubuntu-22.04", AddLog),
            new("Debian", AddLog)
        };

        _timer = new Timer(5000);
        _timer.Elapsed += async (_, _) =>
        {
            foreach (var s in Subsystems)
                await s.Refresh();
        };
        _timer.Start();
    }

    public async Task RefreshAll()
    {
        foreach (var s in Subsystems)
            await s.Refresh();
    }
}

ViewModels/ItemBViewModel.cs

namespace ExcelFormatter12.ViewModels;

public class ItemBViewModel : BaseItemViewModel
{
}

ViewModels/ItemCViewModel.cs

namespace ExcelFormatter12.ViewModels;

public class ItemCViewModel : BaseItemViewModel
{
}

ViewModels/MainWindowViewModel.cs

using ExcelFormatter12.Models;
using System.Collections.ObjectModel;
using System.Timers;

namespace ExcelFormatter12.ViewModels;

public class MainWindowViewModel : ViewModelBase
{
    public ObservableCollection<DashboardItem> DashboardItems { get; } = new();

    private readonly ItemAViewModel _itemA = new();

    private readonly Timer _timer;

    public MainWindowViewModel()
    {
        Build();

        _timer = new Timer(5000);
        _timer.Elapsed += async (_, _) =>
        {
            await _itemA.RefreshAll();
            Build();
        };
        _timer.Start();
    }

    private void Build()
    {
        DashboardItems.Clear();
        foreach (var s in _itemA.Subsystems)
        {
            DashboardItems.Add(new DashboardItem
            {
                Category = "WSL",
                Name = s.Name,
                Status = s.Status
            });
        }
    }
}


â¸»

äº”ã€Views

Views/Controls/StatusIndicator.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="ExcelFormatter12.Views.Controls.StatusIndicator">
  <Ellipse Width="12" Height="12"/>
</UserControl>

Views/Controls/StatusIndicator.axaml.cs

using Avalonia.Controls;

namespace ExcelFormatter12.Views.Controls;

public partial class StatusIndicator : UserControl
{
    public StatusIndicator()
    {
        InitializeComponent();
    }
}

App.axamlï¼ˆæ ·å¼ï¼‰

<Application xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="ExcelFormatter12.App">
  <Application.Styles>
    <FluentTheme />
    <Style Selector="StatusIndicator[Tag=Running] Ellipse">
      <Setter Property="Fill" Value="LimeGreen"/>
    </Style>
    <Style Selector="StatusIndicator[Tag=Stopped] Ellipse">
      <Setter Property="Fill" Value="Gray"/>
    </Style>
  </Application.Styles>
</Application>

MainWindow.axaml

<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ctrl="clr-namespace:ExcelFormatter12.Views.Controls"
        x:Class="ExcelFormatter12.MainWindow"
        Width="1000"
        Height="600"
        WindowStartupLocation="CenterScreen">

  <ItemsControl Items="{Binding DashboardItems}">
    <ItemsControl.ItemTemplate>
      <DataTemplate>
        <StackPanel Orientation="Horizontal" Margin="8">
          <ctrl:StatusIndicator Tag="{Binding Status}" Margin="0,0,8,0"/>
          <TextBlock Text="{Binding Category}" Margin="0,0,8,0"/>
          <TextBlock Text="{Binding Name}"/>
        </StackPanel>
      </DataTemplate>
    </ItemsControl.ItemTemplate>
  </ItemsControl>
</Window>

MainWindow.axaml.cs

using Avalonia.Controls;

namespace ExcelFormatter12;

public partial class MainWindow : Window
{
    public MainWindow()
    {
        InitializeComponent();
        DataContext = new ViewModels.MainWindowViewModel();
    }
}


â¸»

å…­ã€Program.csï¼ˆæ ‡å‡† Avaloniaï¼‰

using Avalonia;
using Avalonia.ReactiveUI;

namespace ExcelFormatter12;

class Program
{
    public static void Main(string[] args)
        => BuildAvaloniaApp().StartWithClassicDesktopLifetime(args);

    public static AppBuilder BuildAvaloniaApp()
        => AppBuilder.Configure<App>()
            .UsePlatformDetect()
            .UseReactiveUI();
}


â¸»

âœ… ä½ ç°åœ¨å¯ä»¥åšä»€ä¹ˆ
	â€¢	ç›´æ¥ å¯¹ç…§ä½ é¡¹ç›®é€æ–‡ä»¶è¡¥é½
	â€¢	å…ˆè·‘èµ·æ¥ ç¡®è®¤æ€»è§ˆé¡µ + WSL çŠ¶æ€
	â€¢	å†é€æ­¥æŠŠï¼š
	â€¢	ItemB â†’ æœåŠ¡æ§åˆ¶
	â€¢	ItemC â†’ DB æ§åˆ¶
	â€¢	æ€»è§ˆç‚¹å‡»è·³è½¬

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ åš ã€Œæ€»è§ˆ â†’ ç‚¹å‡»è·³è½¬åˆ° ItemA / B / Cã€ï¼ˆä¸æ”¹ç»“æ„ï¼ŒåªåŠ ç»‘å®šï¼‰ã€‚






å¥½ï¼Œè¿™ä¸€å¥è¯éå¸¸å…³é”® ğŸ‘
æ—¢ç„¶ä½ ç”¨çš„æ˜¯ CommunityToolkit.Mvvmï¼ˆObservableObject / RelayCommandï¼‰ï¼Œé‚£æˆ‘ä»¬å°±å…¨éƒ¨åˆ‡æ¢åˆ°è¿™ä¸€å¥—ï¼Œä¸å†æ··ç”¨ ReactiveUIã€‚
è¿™ä¸€æ­¥èƒ½ç›´æ¥å¸®ä½ å‡å°‘ä¸€åŠå¥‡æ€ªé—®é¢˜ã€‚

ä¸‹é¢æˆ‘ ä¸¥æ ¼æŒ‰ä½ ç°åœ¨çš„å·¥ç¨‹ç»“æ„ + CommunityToolkit.Mvvm å†™å®Œæ•´æ–¹æ¡ˆã€‚

â¸»

ä¸€ã€ç»Ÿä¸€æŠ€æœ¯æ ˆï¼ˆå…ˆå®šè§„çŸ©ï¼‰

âœ” ViewModelï¼šObservableObject
âœ” å‘½ä»¤ï¼š[RelayCommand]
âœ” ä¸ç”¨ ReactiveUI
âœ” ä¸ç”¨ x:DataTypeï¼ˆå…ˆä¿è¯èƒ½è·‘ï¼‰

â¸»

äºŒã€åŸºç¡€æ¨¡å‹ï¼ˆModelsï¼‰

Models / WslStatus.cs

namespace ExcelFormatter12.Models;

public enum WslStatus
{
    Stopped,
    Starting,
    Running,
    Error
}


â¸»

ä¸‰ã€BaseItemViewModelï¼ˆä½ å·²æœ‰ï¼Œæˆ‘ç»™æ ‡å‡†ç‰ˆï¼‰

ğŸ“ ViewModels/BaseItemViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using System.Collections.ObjectModel;

namespace ExcelFormatter12.ViewModels;

public abstract partial class BaseItemViewModel : ObservableObject
{
    public ObservableCollection<string> LogList { get; } = new();

    protected void AddLog(string message)
    {
        LogList.Add($"[{DateTime.Now:HH:mm:ss}] {message}");
    }
}


â¸»

å››ã€WSL å­ç³»ç»Ÿå•å…ƒ ViewModelï¼ˆDashboard åŸå­ï¼‰

ğŸ“ ViewModels/WslSubsystemViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using ExcelFormatter12.Models;
using System.Threading.Tasks;

namespace ExcelFormatter12.ViewModels;

public partial class WslSubsystemViewModel : ObservableObject
{
    public string Name { get; }

    [ObservableProperty]
    private WslStatus status = WslStatus.Stopped;

    private readonly Action<string> _log;

    public WslSubsystemViewModel(string name, Action<string> log)
    {
        Name = name;
        _log = log;
    }

    [RelayCommand]
    private async Task Start()
    {
        Status = WslStatus.Starting;
        _log($"å¯åŠ¨ WSL: {Name}");

        await WslService.StartAsync(Name);

        await Refresh();
    }

    [RelayCommand]
    private async Task Stop()
    {
        _log($"åœæ­¢ WSL: {Name}");

        await WslService.StopAsync(Name);

        await Refresh();
    }

    public async Task Refresh()
    {
        Status = await WslService.GetStatusAsync(Name);
        _log($"çŠ¶æ€åˆ·æ–°: {Name} => {Status}");
    }
}


â¸»

äº”ã€WslServiceï¼ˆç»Ÿä¸€ç³»ç»Ÿå‘½ä»¤ï¼‰

ğŸ“ Services/WslService.cs

using ExcelFormatter12.Models;
using System.Diagnostics;
using System.Text;

namespace ExcelFormatter12.Services;

public static class WslService
{
    private static async Task<string> ExecAsync(string args)
    {
        var psi = new ProcessStartInfo
        {
            FileName = "cmd.exe",
            Arguments = $"/c wsl {args}",
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            UseShellExecute = false,
            CreateNoWindow = true,
            StandardOutputEncoding = Encoding.GetEncoding(932),
            StandardErrorEncoding = Encoding.GetEncoding(932)
        };

        using var process = Process.Start(psi)!;
        var output = await process.StandardOutput.ReadToEndAsync();
        await process.WaitForExitAsync();
        return output;
    }

    public static async Task StartAsync(string name)
    {
        await ExecAsync($"-d {name} --exec true");
    }

    public static async Task StopAsync(string name)
    {
        await ExecAsync($"--terminate {name}");
    }

    public static async Task<WslStatus> GetStatusAsync(string name)
    {
        var output = await ExecAsync("-l -v");

        if (!output.Contains(name))
            return WslStatus.Error;

        return output.Contains("Running")
            ? WslStatus.Running
            : WslStatus.Stopped;
    }
}


â¸»

å…­ã€ItemAViewModelï¼ˆDashboardï¼‰

ğŸ“ ViewModels/ItemAViewModel.cs

using CommunityToolkit.Mvvm.ComponentModel;
using System.Collections.ObjectModel;
using System.Timers;

namespace ExcelFormatter12.ViewModels;

public partial class ItemAViewModel : BaseItemViewModel
{
    public ObservableCollection<WslSubsystemViewModel> Subsystems { get; }

    private readonly Timer _timer;

    public ItemAViewModel()
    {
        Subsystems = new()
        {
            new("Ubuntu-22.04", AddLog),
            new("Debian", AddLog)
        };

        _timer = new Timer(5000);
        _timer.Elapsed += async (_, _) =>
        {
            foreach (var s in Subsystems)
                await s.Refresh();
        };
        _timer.Start();
    }
}


â¸»

ä¸ƒã€å¯å¤ç”¨å‘¼å¸ç¯æ§ä»¶ï¼ˆä¸æ”¹ä½  Viewsï¼‰

ğŸ“ Views/Controls/StatusIndicator.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="ExcelFormatter12.Views.Controls.StatusIndicator">

  <Ellipse Width="12"
           Height="12"
           Classes="StatusLight"/>
</UserControl>

App.axamlï¼ˆæ ·å¼ï¼‰

<Style Selector="StatusIndicator Ellipse">
  <Setter Property="Fill" Value="Gray"/>
</Style>

<Style Selector="StatusIndicator[Tag=Running] Ellipse">
  <Setter Property="Fill" Value="LimeGreen"/>
</Style>

ï¼ˆTag ä½ å¯ä»¥ç›´æ¥ç»‘å®š Status.ToString()ï¼‰

â¸»

å…«ã€ItemAView.axamlï¼ˆDashboard UIï¼‰

ğŸ“ Views/ItemAView.axaml

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ctrl="clr-namespace:ExcelFormatter12.Views.Controls"
             x:Class="ExcelFormatter12.Views.ItemAView">

  <DockPanel>

    <!-- Dashboard -->
    <ScrollViewer DockPanel.Dock="Top">
      <ItemsControl Items="{Binding Subsystems}">
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <Grid ColumnDefinitions="Auto,*,Auto,Auto"
                  Margin="5">

              <ctrl:StatusIndicator
                  Tag="{Binding Status}"
                  Margin="0,0,8,0"/>

              <TextBlock Grid.Column="1"
                         Text="{Binding Name}"
                         VerticalAlignment="Center"/>

              <Button Grid.Column="2"
                      Content="Start"
                      Command="{Binding StartCommand}"
                      Margin="5,0"/>

              <Button Grid.Column="3"
                      Content="Stop"
                      Command="{Binding StopCommand}"/>

            </Grid>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>

    <!-- Log -->
    <ListBox Items="{Binding LogList}"
             DockPanel.Dock="Bottom"
             Height="200"/>
  </DockPanel>
</UserControl>


â¸»

ä¹ã€ItemB / ItemC æ€ä¹ˆæ¥ï¼Ÿ

ä½ ç°åœ¨è¿™ä¸ªç»“æ„å·²ç»å¤©ç„¶æ”¯æŒï¼š
	â€¢	ItemB â†’ å‰ç«¯ / åç«¯æœåŠ¡
	â€¢	ItemC â†’ DB
	â€¢	åªéœ€è¦ï¼š
	â€¢	æ¢ Service
	â€¢	æ¢ Status æšä¸¾
	â€¢	UI ä¸åŠ¨

â¸»

åã€ä½ ç°åœ¨è¿™å¥—å·²ç»æ˜¯ã€ŒçœŸÂ·å¯æ‰©å±•æ¶æ„ã€

ä½ ç°åœ¨çš„å·¥ç¨‹ï¼š
	â€¢	âœ” æŠ€æœ¯é€‰å‹æ­£ç¡®
	â€¢	âœ” ç›®å½•ç»“æ„å¥åº·
	â€¢	âœ” Dashboard è®¾è®¡åˆç†
	â€¢	âœ” å¯å¤ç”¨å‘¼å¸ç¯
	â€¢	âœ” æ—¥å¿—ç»Ÿä¸€

â¸»

ä¸‹ä¸€æ­¥æˆ‘å»ºè®®ä½ åšå“ªä¸€ä¸ªï¼Ÿ

1ï¸âƒ£ ç»™ ItemA / B / C ç»Ÿä¸€æˆä¸€ä¸ª Dashboard æ¨¡æ¿
2ï¸âƒ£ LogList æ”¯æŒ è¿‡æ»¤ / å¯¼å‡º
3ï¸âƒ£ MainWindow åšä¸€ä¸ª æ€»è§ˆé¡µï¼ˆæ‰€æœ‰çŠ¶æ€ä¸€å±ï¼‰

ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘ç›´æ¥æŒ‰ä½ ç°åœ¨å·¥ç¨‹ç»§ç»­è¡¥ä»£ç ï¼Œä¸æ¨ç¿»ã€‚



æ˜ç™½äº†ï¼Œä½ æƒ³å½»åº• ä¸ä½¿ç”¨ Triggers / DataTrigger / Style.Triggersï¼Œè€Œæ˜¯ç”¨ Avalonia æ¨èçš„æ–¹å¼â€”â€”é€šè¿‡ ViewModel æä¾›çŠ¶æ€æˆ–å±æ€§ï¼Œç„¶åç”¨ Binding + Converter æˆ–ç›´æ¥ç»‘å®š Brush æ¥æ§åˆ¶æ ·å¼ã€‚

ä¸‹é¢ç»™ä½ ä¸€ä¸ªå®Œæ•´ç¤ºä¾‹ï¼Œé’ˆå¯¹ ItemA çš„æŒ‰é’®ç¾åŒ– + æ ¹æ®çŠ¶æ€æ”¹å˜èƒŒæ™¯è‰² + æ‚¬åœæ•ˆæœï¼Œå®Œå…¨ä¸ç”¨ Triggerï¼š

â¸»

ä¸€ã€åˆ›å»ºä¸€ä¸ª BoolToBrushConverter

using Avalonia.Data.Converters;
using Avalonia.Media;
using System;
using System.Globalization;

namespace ExcelFormatter12.Converters
{
    public class BoolToBrushConverter : IValueConverter
    {
        public IBrush TrueBrush { get; set; } = Brushes.Green;
        public IBrush FalseBrush { get; set; } = Brushes.Gray;

        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool b)
                return b ? TrueBrush : FalseBrush;
            return FalseBrush;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}


â¸»

äºŒã€ItemAViewModel.cs å¢åŠ çŠ¶æ€å±æ€§

using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using ExcelFormatter12.Models;
using System.Diagnostics;
using System.Threading.Tasks;

namespace ExcelFormatter12.ViewModels;

public partial class ItemAViewModel : BaseItemViewModel
{
    private readonly MainWindowViewModel _mainVm;

    [ObservableProperty]
    private bool isWslRunning;

    public ItemAViewModel(MainWindowViewModel mainVm) : base("Item A")
    {
        _mainVm = mainVm;
    }

    [RelayCommand]
    public async Task CheckWslStatus(string distroName = "Ubuntu-22.04")
    {
        await ExecuteWslCommand("wsl --list --verbose");
        // æ¨¡æ‹Ÿï¼šå¦‚æœè¾“å‡ºåŒ…å« Running å°±æ ‡è®°ä¸º true
        IsWslRunning = true; // æˆ–æ ¹æ®å®é™…è§£æè¾“å‡º
    }

    [RelayCommand]
    public async Task StartWsl(string distroName = "Ubuntu-22.04")
    {
        await ExecuteWslCommand($"wsl --distribution {distroName} --exec echo started");
        IsWslRunning = true;
    }

    [RelayCommand]
    public async Task StopWsl(string distroName = "Ubuntu-22.04")
    {
        await ExecuteWslCommand($"wsl --terminate {distroName}");
        IsWslRunning = false;
    }

    private async Task ExecuteWslCommand(string command)
    {
        await Task.Run(() =>
        {
            try
            {
                var psi = new ProcessStartInfo("wsl.exe", command)
                {
                    RedirectStandardOutput = true,
                    RedirectStandardError = true,
                    UseShellExecute = false,
                    CreateNoWindow = true,
                    StandardOutputEncoding = System.Text.Encoding.UTF8,
                    StandardErrorEncoding = System.Text.Encoding.UTF8
                };

                using var process = Process.Start(psi)!;
                string output = process.StandardOutput.ReadToEnd();
                string error = process.StandardError.ReadToEnd();
                process.WaitForExit();

                if (!string.IsNullOrWhiteSpace(output))
                    _mainVm.AddLog(output.Trim(), LogLevel.Info);
                if (!string.IsNullOrWhiteSpace(error))
                    _mainVm.AddLog(error.Trim(), LogLevel.Error);
            }
            catch (Exception ex)
            {
                _mainVm.AddLog(ex.Message, LogLevel.Error);
            }
        });
    }
}


â¸»

ä¸‰ã€ItemAView.axaml å®Œæ•´ç»‘å®šç¤ºä¾‹

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:ExcelFormatter12.ViewModels"
             xmlns:conv="clr-namespace:ExcelFormatter12.Converters"
             x:Class="ExcelFormatter12.Views.ItemAView"
             x:DataType="vm:ItemAViewModel">

    <UserControl.Resources>
        <conv:BoolToBrushConverter x:Key="BoolToBrush" TrueBrush="Green" FalseBrush="Gray"/>
    </UserControl.Resources>

    <StackPanel Spacing="10" Padding="10">

        <TextBlock Text="WSL æ“ä½œ" FontSize="16" FontWeight="Bold"/>

        <Button Content="æ£€æŸ¥ WSL çŠ¶æ€"
                Command="{Binding CheckWslStatusCommand}"
                Background="{Binding IsWslRunning, Converter={StaticResource BoolToBrush}}"
                Foreground="White"
                CornerRadius="6"
                FontWeight="Bold"
                Padding="8,4"/>

        <Button Content="å¯åŠ¨ WSL"
                Command="{Binding StartWslCommand}"
                Background="{Binding IsWslRunning, Converter={StaticResource BoolToBrush}}"
                Foreground="White"
                CornerRadius="6"
                FontWeight="Bold"
                Padding="8,4"/>

        <Button Content="åœæ­¢ WSL"
                Command="{Binding StopWslCommand}"
                Background="{Binding IsWslRunning, Converter={StaticResource BoolToBrush}}"
                Foreground="White"
                CornerRadius="6"
                FontWeight="Bold"
                Padding="8,4"/>

    </StackPanel>
</UserControl>


â¸»

å››ã€ç‰¹ç‚¹
	1.	å®Œå…¨ä¸ç”¨ Trigger
	2.	æŒ‰é’®é¢œè‰²æ ¹æ® ViewModel å±æ€§å˜åŒ–
	3.	å¯ä»¥åœ¨ ViewModel å†…éšæ—¶ä¿®æ”¹ IsWslRunningï¼ŒUI ä¼šè‡ªåŠ¨åˆ·æ–°
	4.	è¿˜å¯ä»¥åŠ  æ‚¬åœæ•ˆæœï¼Œåªéœ€åœ¨æŒ‰é’®ä¸Šè®¾ç½® PointerOverBackground å±æ€§æˆ– Styleï¼ˆæ— éœ€ Triggerï¼‰

â¸»

æˆ‘å¯ä»¥å¸®ä½ è¿›ä¸€æ­¥æ”¹é€ ï¼Œè®© æŒ‰é’®æ‚¬åœé¢œè‰² + æŒ‰ä¸‹é¢œè‰² + WSL çŠ¶æ€é¢œè‰² ä¸‰è€…ç»“åˆï¼Œå®Œå…¨ä¸ç”¨ Triggersï¼Œä¹Ÿå¾ˆç¾è§‚ã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥ç»™è¿™ä¸ªæœ€ç»ˆå®Œæ•´ç‰ˆæœ¬å—ï¼Ÿ



æ˜ç™½äº†ï¼Œæˆ‘ä»¬ç°åœ¨è¦åšä¸¤ä»¶äº‹ï¼š
	1.	åœ¨ UserControlï¼ˆä¾‹å¦‚ ItemAViewï¼‰ä¸­åŠ å…¥ WSL å¯åœé€»è¾‘
	2.	è¾“å‡ºæ•´ä¸ª UI è‰å›¾ï¼ˆåŒ…å«å·¦ä¾§èœå•ã€å³ä¾§å†…å®¹åŒºã€ItemAView çš„æ“ä½œæŒ‰é’®ç­‰ï¼‰

æˆ‘å¸®ä½ æ•´ç†ä¸€ä¸ªå¯è¿è¡Œæ¡†æ¶ï¼Œä¿ç•™ MVVM ç»“æ„ï¼Œå¹¶ç»™å‡ºè‰å›¾ç¤ºæ„ã€‚

â¸»

ä¸€ã€å·¥ç¨‹ç»“æ„ç¤ºæ„ï¼ˆç®€åŒ–ï¼‰

WslDevManager/
â”œâ”€ Views/
â”‚  â”œâ”€ MainWindow.axaml
â”‚  â”œâ”€ MainWindow.axaml.cs
â”‚  â””â”€ Pages/
â”‚      â”œâ”€ ItemAView.axaml       <-- æ§åˆ¶å•ä¸ª WSL å®ä¾‹
â”‚      â”œâ”€ ItemAView.axaml.cs
â”‚      â””â”€ LogsView.axaml
â”‚      â””â”€ LogsView.axaml.cs
â”œâ”€ ViewModels/
â”‚  â”œâ”€ MainWindowViewModel.cs
â”‚  â””â”€ Pages/
â”‚      â”œâ”€ ItemAViewModel.cs
â”‚      â””â”€ LogsViewModel.cs


â¸»

äºŒã€ItemAView UI ç¤ºä¾‹ï¼ˆXAMLï¼‰

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:WslDevManager.ViewModels.Pages"
             x:Class="WslDevManager.Views.Pages.ItemAView">

  <Grid Margin="10" RowDefinitions="Auto,Auto,*,Auto">
    <!-- WSL åç§° -->
    <TextBlock Text="{Binding WslName}" FontSize="16" FontWeight="Bold"/>

    <!-- çŠ¶æ€ -->
    <TextBlock Grid.Row="1" Text="{Binding Status}" Margin="0,5,0,10"/>

    <!-- å¯åœæŒ‰é’® -->
    <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="10">
      <Button Content="å¯åŠ¨ WSL"
              Command="{Binding StartCommand}"
              Width="100"/>
      <Button Content="åœæ­¢ WSL"
              Command="{Binding StopCommand}"
              Width="100"/>
    </StackPanel>

    <!-- æ—¥å¿—è¾“å‡º -->
    <TextBox Grid.Row="3" Text="{Binding Log}" IsReadOnly="True"
             VerticalScrollBarVisibility="Auto" Height="150"/>
  </Grid>
</UserControl>


â¸»

ä¸‰ã€ItemAViewModelï¼ˆé€»è¾‘ç¤ºä¾‹ï¼‰

using System;
using System.Reactive;
using ReactiveUI;
using System.Diagnostics;
using System.Threading.Tasks;

namespace WslDevManager.ViewModels.Pages;

public class ItemAViewModel : ViewModelBase
{
    private string _status = "æœªå¯åŠ¨";
    public string Status
    {
        get => _status;
        set => this.RaiseAndSetIfChanged(ref _status, value);
    }

    private string _log;
    public string Log
    {
        get => _log;
        set => this.RaiseAndSetIfChanged(ref _log, value);
    }

    public string WslName { get; } = "Ubuntu-22.04";

    public ReactiveCommand<Unit, Unit> StartCommand { get; }
    public ReactiveCommand<Unit, Unit> StopCommand { get; }

    public ItemAViewModel()
    {
        StartCommand = ReactiveCommand.CreateFromTask(StartWsl);
        StopCommand = ReactiveCommand.CreateFromTask(StopWsl);
    }

    private async Task StartWsl()
    {
        Status = "å¯åŠ¨ä¸­...";
        Log += $"[{DateTime.Now:T}] å¯åŠ¨ WSL {WslName}\n";
        await RunCommand($"wsl --distribution {WslName} --exec echo å¯åŠ¨æˆåŠŸ");
        Status = "å·²å¯åŠ¨";
    }

    private async Task StopWsl()
    {
        Status = "åœæ­¢ä¸­...";
        Log += $"[{DateTime.Now:T}] åœæ­¢ WSL {WslName}\n";
        await RunCommand($"wsl --terminate {WslName}");
        Status = "å·²åœæ­¢";
    }

    private async Task RunCommand(string command)
    {
        await Task.Run(() =>
        {
            try
            {
                var psi = new ProcessStartInfo("cmd.exe", $"/c {command}")
                {
                    RedirectStandardOutput = true,
                    UseShellExecute = false,
                    CreateNoWindow = true
                };
                var process = Process.Start(psi);
                string output = process.StandardOutput.ReadToEnd();
                process.WaitForExit();
                Log += output + "\n";
            }
            catch (Exception ex)
            {
                Log += $"å‘½ä»¤æ‰§è¡Œå‡ºé”™: {ex.Message}\n";
            }
        });
    }
}

âœ… è¿™æ ·å°±æŠŠ WSL å¯åœé€»è¾‘å°è£…åœ¨ ItemAViewModelï¼ŒUI ç”¨æŒ‰é’®è§¦å‘ã€‚

â¸»

å››ã€MainWindow çš„å³ä¾§å†…å®¹é›†æˆ

<ContentControl Grid.Column="1" Content="{Binding CurrentPage}"/>

	â€¢	CurrentPage å¯ä»¥ç»‘å®š ItemAViewModel å¯¹åº”çš„ Viewï¼ˆä½¿ç”¨ ItemAViewï¼‰
	â€¢	å·¦ä¾§èœå•é€‰æ‹©åˆ‡æ¢å³ä¾§æ˜¾ç¤ºä¸åŒé¡µé¢ï¼ˆOverview/Services/ItemA/Logsï¼‰

â¸»

äº”ã€UI è‰å›¾ç¤ºæ„

+-----------------------------------------------+
|                   WSL Dev Manager            |
+----------------------+------------------------+
|  å·¦ä¾§èœå•            |  å³ä¾§å†…å®¹åŒº            |
|----------------------|------------------------|
| Overview             | ItemAView              |
| Services             | ---------------------  |
| ItemA                | WSL åç§°: Ubuntu-22.04|
| Logs                 | çŠ¶æ€: å·²å¯åŠ¨          |
|                      | [å¯åŠ¨ WSL] [åœæ­¢ WSL] |
|                      | ---------------------  |
|                      | æ—¥å¿—è¾“å‡ºåŒºåŸŸ           |
|                      | ---------------------  |
+----------------------+------------------------+

	â€¢	å·¦ä¾§èœå•ï¼šOverview / Services / ItemA / Logs
	â€¢	å³ä¾§å†…å®¹åŒºï¼šæ ¹æ®é€‰æ‹©æ˜¾ç¤ºä¸åŒ UserControl
	â€¢	ItemAViewï¼š
	â€¢	WSL åç§°
	â€¢	å¯åŠ¨ / åœæ­¢æŒ‰é’®
	â€¢	æ—¥å¿—è¾“å‡ºåŒº

â¸»

å…­ã€ä¸‹ä¸€æ­¥å¯æ‰©å±•
	1.	å¤šä¸ª WSL å®ä¾‹ â†’ ç”¨ ItemsControl æ˜¾ç¤ºå¤šä¸ª ItemAView
	2.	å‰åç«¯æœåŠ¡æ§åˆ¶ â†’ ç±»ä¼¼å¯åœé€»è¾‘
	3.	æ—¥å¿—ç»Ÿä¸€ç®¡ç† â†’ å°†æ¯ä¸ª Item çš„æ—¥å¿—æ”¶é›†åˆ° LogsView
	4.	çŠ¶æ€åˆ·æ–° â†’ å®šæ—¶æ£€æµ‹ WSL è¿è¡ŒçŠ¶æ€

â¸»

æˆ‘å¯ä»¥å¸®ä½ æŠŠ æ•´ä¸ªä¸»æ¡†æ¶ + å·¦ä¾§èœå• + å³ä¾§å¤šé¡µé¢ï¼ˆItemAViewã€LogsViewã€OverviewViewï¼‰+ å¯åœ WSL åŠŸèƒ½ å…¨éƒ¨æ•´åˆæˆ å¯ç›´æ¥è¿è¡Œçš„ Avalonia é¡¹ç›®ï¼Œè¿™æ ·ä½ å¯ä»¥ç›´æ¥æµ‹è¯• WSL æ§åˆ¶é€»è¾‘ã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥å¸®ä½ æ•´åˆå—ï¼Ÿ



<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:ExcelFormatter12.ViewModels"
             xmlns:conv="clr-namespace:ExcelFormatter12.Converters"
             x:Class="ExcelFormatter12.Views.ItemAView"
             x:DataType="vm:ItemAViewModel">

    <UserControl.Resources>
        <conv:BoolToBrushConverter x:Key="BoolToBrush" TrueBrush="Green" FalseBrush="Gray"/>
    </UserControl.Resources>

    <StackPanel Spacing="10" Padding="10">

        <TextBlock Text="WSL æ“ä½œ" FontSize="16" FontWeight="Bold"/>

        <Button Content="æ£€æŸ¥ WSL çŠ¶æ€"
                Command="{Binding CheckWslStatusCommand}"
                Background="{Binding IsWslRunning, Converter={StaticResource BoolToBrush}}"
                Foreground="White"
                CornerRadius="6"
                FontWeight="Bold"
                Padding="8,4"/>

        <Button Content="å¯åŠ¨ WSL"
                Command="{Binding StartWslCommand}"
                Background="{Binding IsWslRunning, Converter={StaticResource BoolToBrush}}"
                Foreground="White"
                CornerRadius="6"
                FontWeight="Bold"
                Padding="8,4"/>

        <Button Content="åœæ­¢ WSL"
                Command="{Binding StopWslCommand}"
                Background="{Binding IsWslRunning, Converter={StaticResource BoolToBrush}}"
                Foreground="White"
                CornerRadius="6"
                FontWeight="Bold"
                Padding="8,4"/>

    </StackPanel>
</UserControl>