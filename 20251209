


using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using System.Windows.Forms;
using Excel = Microsoft.Office.Interop.Excel;
using System.Runtime.InteropServices;

namespace ExcelLinkCleaner
{
    public partial class MainForm : Form
    {
        private bool _isRunning = false;
        private int total = 0, success = 0, failed = 0;
        private string reportDir;
        private string reportFile;

        public MainForm()
        {
            InitializeComponent();
            CheckForIllegalCrossThreadCalls = false;
            InitUI();
        }

        private void InitUI()
        {
            BackColor = System.Drawing.Color.FromArgb(245, 245, 245);
            btnStart.BackColor = System.Drawing.Color.FromArgb(51, 153, 255);
            btnStop.BackColor = System.Drawing.Color.FromArgb(255, 102, 102);
            btnBrowse.BackColor = System.Drawing.Color.FromArgb(180, 180, 180);
            btnOpenReport.BackColor = System.Drawing.Color.FromArgb(180, 180, 200);

            foreach (var btn in new[] { btnStart, btnStop, btnBrowse, btnOpenReport })
            {
                btn.FlatStyle = FlatStyle.Flat;
                btn.FlatAppearance.BorderSize = 0;
                btn.Font = new System.Drawing.Font("Segoe UI", 10);
            }
        }

        private void btnBrowse_Click(object sender, EventArgs e)
        {
            using (var fbd = new FolderBrowserDialog())
            {
                if (fbd.ShowDialog() == DialogResult.OK)
                {
                    txtFolder.Text = fbd.SelectedPath;
                }
            }
        }

        private void btnStart_Click(object sender, EventArgs e)
        {
            if (!Directory.Exists(txtFolder.Text))
            {
                Log("‚ùå ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÊñá‰ª∂Â§πË∑ØÂæÑ");
                return;
            }

            ResetStat();

            _isRunning = true;
            btnStart.Enabled = false;
            btnStop.Enabled = true;

            reportDir = Path.Combine(Application.StartupPath, "Reports");
            Directory.CreateDirectory(reportDir);
            reportFile = Path.Combine(reportDir,
                DateTime.Now.ToString("yyyyMMdd_HHmmss") + "_report.csv");
            File.WriteAllText(reportFile, "File,Result,Message,Time\n");

            Task.Run(() => ProcessFolder(txtFolder.Text));
        }

        private void ResetStat()
        {
            total = success = failed = 0;
            UpdateStat();
        }

        private void UpdateStat()
        {
            lblTotal.Text = $"ÊÄªËÆ°: {total}";
            lblSuccess.Text = $"ÊàêÂäü: {success}";
            lblFailed.Text = $"Â§±Ë¥•: {failed}";
        }

        private void btnStop_Click(object sender, EventArgs e)
        {
            _isRunning = false;
            Log("‚ö† Â∑≤ÂèëÈÄÅÂÅúÊ≠¢Êåá‰ª§");
        }

        private void btnOpenReport_Click(object sender, EventArgs e)
        {
            if (Directory.Exists(reportDir))
                System.Diagnostics.Process.Start(reportDir);
        }

        private void ProcessFolder(string folder)
        {
            var files = Directory.GetFiles(folder, "aaa*.xlsm", SearchOption.AllDirectories);
            Log($"üìÇ ÂÖ±ÂèëÁé∞ {files.Length} ‰∏™ .xlsm Êñá‰ª∂");

            foreach (var file in files)
            {
                if (!_isRunning) break;
                ProcessSingleFile(file);
            }

            Log("üü¢ ‰ªªÂä°ÁªìÊùü");

            this.Invoke(new Action(() =>
            {
                btnStart.Enabled = true;
                btnStop.Enabled = false;
            }));
        }

        private void ProcessSingleFile(string filePath)
        {
            total++;
            UpdateStat();

            Excel.Application app = null;
            Excel.Workbook wb = null;

            try
            {
                Log($"üîç {filePath}");

                app = new Excel.Application
                {
                    DisplayAlerts = false,
                    Visible = false,
                    AskToUpdateLinks = false,
                    AlertBeforeOverwriting = false
                };

                wb = app.Workbooks.Open(filePath, UpdateLinks: 0);

                var linksObj = wb.LinkSources(Excel.XlLink.xlExcelLinks);
                var links = ConvertLinkSourcesToList(linksObj);

                if (links.Count > 0)
                {
                    foreach (var l in links)
                        wb.BreakLink(l, Excel.XlLinkType.xlLinkTypeExcelLinks);

                    success++;
                    AppendReport(filePath, "Success", $"Removed {links.Count} link(s)");
                    Log($"‚úî ÊàêÂäüÔºåÂà†Èô§ {links.Count} ‰∏™Â§ñÈÉ®ÈìæÊé•");
                }
                else
                {
                    success++;
                    AppendReport(filePath, "Success", "No external links");
                    Log("‚Ñπ Êó†Â§ñÈÉ®ÈìæÊé•");
                }

                wb.Save();
            }
            catch (Exception ex)
            {
                failed++;
                AppendReport(filePath, "Failed", ex.Message);
                Log($"‚ùå Â§±Ë¥•: {ex.Message}");
            }
            finally
            {
                UpdateStat();

                if (wb != null) wb.Close(false);
                if (app != null) app.Quit();

                ReleaseCom(wb);
                ReleaseCom(app);
                GC.Collect();
                GC.WaitForPendingFinalizers();
            }
        }

        private List<string> ConvertLinkSourcesToList(object linksObj)
        {
            var result = new List<string>();
            if (linksObj == null) return result;

            if (linksObj is Array arr)
            {
                foreach (var item in arr)
                    if (item != null)
                        result.Add(item.ToString());
            }
            return result;
        }

        private void AppendReport(string file, string result, string msg)
        {
            File.AppendAllText(reportFile,
                $"{file},{result},\"{msg}\",{DateTime.Now:HH:mm:ss}\n");
        }

        private void ReleaseCom(object obj)
        {
            if (obj != null)
            {
                try { Marshal.ReleaseComObject(obj); }
                catch { }
            }
        }

        private void Log(string msg)
        {
            txtLog.Invoke(new Action(() =>
            {
                txtLog.AppendText(msg + Environment.NewLine);
            }));
        }
    }
}








namespace ExcelLinkCleaner
{
    partial class MainForm
    {
        private System.ComponentModel.IContainer components = null;

        private System.Windows.Forms.TextBox txtFolder;
        private System.Windows.Forms.Button btnBrowse;
        private System.Windows.Forms.Button btnStart;
        private System.Windows.Forms.Button btnStop;
        private System.Windows.Forms.Button btnOpenReport;
        private System.Windows.Forms.TextBox txtLog;
        private System.Windows.Forms.Label lblTotal;
        private System.Windows.Forms.Label lblSuccess;
        private System.Windows.Forms.Label lblFailed;

        protected override void Dispose(bool disposing)
        {
            if (disposing && (components != null))
            {
                components.Dispose();
            }
            base.Dispose(disposing);
        }

        private void InitializeComponent()
        {
            this.txtFolder = new System.Windows.Forms.TextBox();
            this.btnBrowse = new System.Windows.Forms.Button();
            this.btnStart = new System.Windows.Forms.Button();
            this.btnStop = new System.Windows.Forms.Button();
            this.btnOpenReport = new System.Windows.Forms.Button();
            this.txtLog = new System.Windows.Forms.TextBox();
            this.lblTotal = new System.Windows.Forms.Label();
            this.lblSuccess = new System.Windows.Forms.Label();
            this.lblFailed = new System.Windows.Forms.Label();

            this.SuspendLayout();

            // txtFolder
            this.txtFolder.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.txtFolder.Location = new System.Drawing.Point(15, 15);
            this.txtFolder.Size = new System.Drawing.Size(450, 25);

            // btnBrowse
            this.btnBrowse.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.btnBrowse.Location = new System.Drawing.Point(475, 15);
            this.btnBrowse.Size = new System.Drawing.Size(90, 28);
            this.btnBrowse.Text = "ÊµèËßà";
            this.btnBrowse.Click += new System.EventHandler(this.btnBrowse_Click);

            // lblTotal
            this.lblTotal.AutoSize = true;
            this.lblTotal.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.lblTotal.Location = new System.Drawing.Point(15, 55);
            this.lblTotal.Text = "ÊÄªËÆ°: 0";

            // lblSuccess
            this.lblSuccess.AutoSize = true;
            this.lblSuccess.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.lblSuccess.ForeColor = System.Drawing.Color.Green;
            this.lblSuccess.Location = new System.Drawing.Point(120, 55);
            this.lblSuccess.Text = "ÊàêÂäü: 0";

            // lblFailed
            this.lblFailed.AutoSize = true;
            this.lblFailed.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.lblFailed.ForeColor = System.Drawing.Color.Red;
            this.lblFailed.Location = new System.Drawing.Point(225, 55);
            this.lblFailed.Text = "Â§±Ë¥•: 0";

            // btnStart
            this.btnStart.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.btnStart.Location = new System.Drawing.Point(15, 85);
            this.btnStart.Size = new System.Drawing.Size(110, 35);
            this.btnStart.Text = "ÂºÄÂßãÂ§ÑÁêÜ";
            this.btnStart.Click += new System.EventHandler(this.btnStart_Click);

            // btnStop
            this.btnStop.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.btnStop.Location = new System.Drawing.Point(135, 85);
            this.btnStop.Size = new System.Drawing.Size(110, 35);
            this.btnStop.Text = "ÂÅúÊ≠¢";
            this.btnStop.Enabled = false;
            this.btnStop.Click += new System.EventHandler(this.btnStop_Click);

            // btnOpenReport
            this.btnOpenReport.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.btnOpenReport.Location = new System.Drawing.Point(255, 85);
            this.btnOpenReport.Size = new System.Drawing.Size(150, 35);
            this.btnOpenReport.Text = "ÊâìÂºÄÊä•ÂëäÁõÆÂΩï";
            this.btnOpenReport.Click += new System.EventHandler(this.btnOpenReport_Click);

            // txtLog
            this.txtLog.Font = new System.Drawing.Font("Consolas", 10F);
            this.txtLog.Location = new System.Drawing.Point(15, 130);
            this.txtLog.Size = new System.Drawing.Size(550, 300);
            this.txtLog.Multiline = true;
            this.txtLog.ScrollBars = System.Windows.Forms.ScrollBars.Vertical;

            // MainForm
            this.AutoScaleDimensions = new System.Drawing.SizeF(7F, 15F);
            this.ClientSize = new System.Drawing.Size(585, 450);
            this.Controls.Add(this.txtFolder);
            this.Controls.Add(this.btnBrowse);
            this.Controls.Add(this.lblTotal);
            this.Controls.Add(this.lblSuccess);
            this.Controls.Add(this.lblFailed);
            this.Controls.Add(this.btnStart);
            this.Controls.Add(this.btnStop);
            this.Controls.Add(this.btnOpenReport);
            this.Controls.Add(this.txtLog);

            this.Font = new System.Drawing.Font("Segoe UI", 10F);
            this.FormBorderStyle = System.Windows.Forms.FormBorderStyle.FixedDialog;
            this.Text = "Excel Â§ñÈÉ®ÈìæÊé•Ê∏ÖÁêÜÂ∑•ÂÖ∑";
            this.MaximizeBox = false;

            this.ResumeLayout(false);
            this.PerformLayout();
        }
    }
}



using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using System.Windows.Forms;
using Excel = Microsoft.Office.Interop.Excel;
using System.Runtime.InteropServices;

namespace ExcelLinkCleaner
{
    public partial class MainForm : Form
    {
        public MainForm()
        {
            InitializeComponent();
            CheckForIllegalCrossThreadCalls = false;
        }

        private bool _isRunning = false;

        private void btnBrowse_Click(object sender, EventArgs e)
        {
            using (var fbd = new FolderBrowserDialog())
            {
                if (fbd.ShowDialog() == DialogResult.OK)
                {
                    txtFolder.Text = fbd.SelectedPath;
                }
            }
        }

        private void btnStart_Click(object sender, EventArgs e)
        {
            if (!Directory.Exists(txtFolder.Text))
            {
                Log("‚ùå ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÊñá‰ª∂Â§πË∑ØÂæÑÔºÅ");
                return;
            }

            _isRunning = true;
            btnStart.Enabled = false;
            btnStop.Enabled = true;

            Task.Run(() => ProcessFolder(txtFolder.Text));
        }

        private void btnStop_Click(object sender, EventArgs e)
        {
            _isRunning = false;
            Log("‚ö†Ô∏è Â∑≤ÂèëÈÄÅÂÅúÊ≠¢Êåá‰ª§ÔºåÊ≠£Âú®Á≠âÂæÖÂΩìÂâçÊñá‰ª∂ÂÆåÊàê‚Ä¶");
        }

        private void ProcessFolder(string folder)
        {
            try
            {
                string[] files = Directory.GetFiles(folder, "aaa*.xlsm", SearchOption.AllDirectories);
                Log($"üìÇ Ê£ÄÊµãÂà∞ {files.Length} ‰∏™ .xlsm Êñá‰ª∂ÂæÖÂ§ÑÁêÜ");

                foreach (var file in files)
                {
                    if (!_isRunning) break;
                    ProcessSingleFile(file);
                }
            }
            finally
            {
                Log("üü¢ ‰ªªÂä°ÁªìÊùü");
                this.Invoke(new Action(() =>
                {
                    btnStart.Enabled = true;
                    btnStop.Enabled = false;
                }));
            }
        }

        private void ProcessSingleFile(string filePath)
        {
            Log($"üîç Â§ÑÁêÜÊñá‰ª∂Ôºö{filePath}");

            Excel.Application app = null;
            Excel.Workbook wb = null;

            try
            {
                app = new Excel.Application
                {
                    DisplayAlerts = false,
                    Visible = false,
                    AskToUpdateLinks = false,
                    AlertBeforeOverwriting = false
                };

                wb = app.Workbooks.Open(filePath, UpdateLinks: 0);

                object linksObj = null;
                try
                {
                    linksObj = wb.LinkSources(Excel.XlLink.xlExcelLinks);
                }
                catch
                {
                    linksObj = null;
                }

                var links = ConvertLinkSourcesToList(linksObj);

                if (links.Count > 0)
                {
                    Log($"üîó Ê£ÄÊµãÂà∞ {links.Count} ‰∏™Â§ñÈÉ®ÈìæÊé•ÔºåÊ≠£Âú®Âà†Èô§‚Ä¶");

                    foreach (var l in links)
                    {
                        try
                        {
                            wb.BreakLink(l, Excel.XlLinkType.xlLinkTypeExcelLinks);
                            Log($"‚úî Âà†Èô§ÊàêÂäüÔºö{l}");
                        }
                        catch (Exception ex)
                        {
                            Log($"‚ùå Âà†Èô§Â§±Ë¥• {l}Ôºö{ex.Message}");
                        }
                    }
                }
                else
                {
                    Log("‚ÑπÔ∏è Êó†Â§ñÈÉ®ÈìæÊé•");
                }

                wb.Save();
                Log($"üíæ Â∑≤‰øùÂ≠òÔºö{filePath}");
            }
            catch (Exception ex)
            {
                Log($"‚ùå Â§ÑÁêÜÂ§±Ë¥•Ôºö{ex.Message}");
            }
            finally
            {
                if (wb != null) wb.Close(false);
                if (app != null) app.Quit();

                ReleaseCom(wb);
                ReleaseCom(app);
                GC.Collect();
                GC.WaitForPendingFinalizers();
            }
        }

        private List<string> ConvertLinkSourcesToList(object linksObj)
        {
            var result = new List<string>();
            if (linksObj == null) return result;

            if (linksObj is Array arr)
            {
                foreach (var item in arr)
                {
                    if (item != null)
                        result.Add(item.ToString());
                }
            }
            else
            {
                result.Add(linksObj.ToString());
            }
            return result;
        }

        private void ReleaseCom(object obj)
        {
            if (obj != null)
            {
                try { Marshal.ReleaseComObject(obj); }
                catch { }
            }
        }

        private void Log(string msg)
        {
            if (txtLog.InvokeRequired)
            {
                txtLog.Invoke(new Action(() => txtLog.AppendText(msg + Environment.NewLine)));
            }
            else
            {
                txtLog.AppendText(msg + Environment.NewLine);
            }
        }
    }
}



using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;
using Excel = Microsoft.Office.Interop.Excel;
using System.Runtime.InteropServices;
using System.Collections.Generic;

namespace BatchBreakLinks
{
    public class MainForm : Form
    {
        private Button btnSelectFolder;
        private TextBox txtFolder;
        private Button btnStart;
        private ProgressBar progressBar;
        private TextBox txtLog;
        private CheckBox chkBackup;
        private Label lblStatus;

        public MainForm()
        {
            InitializeComponents();
        }

        private void InitializeComponents()
        {
            this.Text = "Batch Break External Links (.xlsm starting with 'aaa')";
            this.Width = 800;
            this.Height = 600;
            this.StartPosition = FormStartPosition.CenterScreen;

            var lbl = new Label { Left = 12, Top = 14, Text = "Folder:", AutoSize = true };
            txtFolder = new TextBox { Left = 70, Top = 10, Width = 560 };
            btnSelectFolder = new Button { Left = 640, Top = 8, Width = 120, Text = "Select Folder" };
            btnSelectFolder.Click += BtnSelectFolder_Click;

            chkBackup = new CheckBox { Left = 70, Top = 40, Text = "Backup original files (.bak)", Checked = true, AutoSize = true };

            btnStart = new Button { Left = 70, Top = 70, Width = 120, Text = "Start" };
            btnStart.Click += BtnStart_Click;

            progressBar = new ProgressBar { Left = 200, Top = 70, Width = 560, Height = 24 };

            lblStatus = new Label { Left = 70, Top = 100, Width = 690, Text = "Status: Idle", AutoSize = false };

            txtLog = new TextBox { Left = 12, Top = 130, Width = 760, Height = 420, Multiline = true, ScrollBars = ScrollBars.Vertical, ReadOnly = true };

            this.Controls.Add(lbl);
            this.Controls.Add(txtFolder);
            this.Controls.Add(btnSelectFolder);
            this.Controls.Add(chkBackup);
            this.Controls.Add(btnStart);
            this.Controls.Add(progressBar);
            this.Controls.Add(lblStatus);
            this.Controls.Add(txtLog);
        }

        private void BtnSelectFolder_Click(object sender, EventArgs e)
        {
            using (var fbd = new FolderBrowserDialog())
            {
                if (fbd.ShowDialog() == DialogResult.OK)
                {
                    txtFolder.Text = fbd.SelectedPath;
                }
            }
        }

        private async void BtnStart_Click(object sender, EventArgs e)
        {
            string folder = txtFolder.Text.Trim();
            if (string.IsNullOrEmpty(folder) || !Directory.Exists(folder))
            {
                MessageBox.Show("Please select a valid folder first.", "Folder not found", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            btnStart.Enabled = false;
            btnSelectFolder.Enabled = false;
            txtLog.Clear();
            Log($"Start scanning folder: {folder}");
            try
            {
                await Task.Run(() => ProcessFolder(folder, chkBackup.Checked));
                Log("All done.");
            }
            catch (Exception ex)
            {
                Log($"Fatal error: {ex}");
            }
            finally
            {
                btnStart.Enabled = true;
                btnSelectFolder.Enabled = true;
                lblStatus.Text = "Status: Idle";
                progressBar.Value = 0;
            }
        }

        private void Log(string line)
        {
            this.Invoke((Action)(() =>
            {
                txtLog.AppendText($"{DateTime.Now:yyyy-MM-dd HH:mm:ss} - {line}{Environment.NewLine}");
                txtLog.SelectionStart = txtLog.Text.Length;
                txtLog.ScrollToCaret();
            }));
        }

        private void SetProgress(int current, int total)
        {
            this.Invoke((Action)(() =>
            {
                if (total <= 0)
                {
                    progressBar.Value = 0;
                    lblStatus.Text = $"Status: {current}";
                }
                else
                {
                    progressBar.Maximum = Math.Max(total, 1);
                    progressBar.Value = Math.Min(current, total);
                    lblStatus.Text = $"Status: Processing {current}/{total}";
                }
            }));
        }

        private void ProcessFolder(string rootFolder, bool backupOriginal)
        {
            // Find all files starting with "aaa" and ending with .xlsm (case-insensitive)
            var files = Directory.EnumerateFiles(rootFolder, "aaa*.xlsm", SearchOption.AllDirectories).ToList();
            Log($"Found {files.Count} matching files.");

            int total = files.Count;
            int current = 0;

            // Create Excel application once, use it for all files to reduce overhead
            Excel.Application excelApp = null;

            try
            {
                excelApp = new Excel.Application
                {
                    DisplayAlerts = false,
                    Visible = false,
                    AlertBeforeOverwriting = false
                };

                foreach (var file in files)
                {
                    current++;
                    SetProgress(current, total);
                    Log($"Processing: {file}");

                    try
                    {
                        if (backupOriginal)
                        {
                            string bak = file + ".bak";
                            if (!File.Exists(bak))
                            {
                                File.Copy(file, bak);
                                Log($"Backup created: {bak}");
                            }
                            else
                            {
                                Log($"Backup already exists: {bak}");
                            }
                        }

                        ProcessSingleFileWithExcelInterop(excelApp, file);
                        Log($"Processed OK: {file}");
                    }
                    catch (Exception exFile)
                    {
                        Log($"Error processing {file}: {exFile.Message}");
                    }
                }
            }
            finally
            {
                // Quit Excel and release COM
                if (excelApp != null)
                {
                    try
                    {
                        excelApp.DisplayAlerts = false;
                        excelApp.Quit();
                    }
                    catch { }
                    finally
                    {
                        Marshal.FinalReleaseComObject(excelApp);
                    }
                }

                // Force GC to release COM objects
                GC.Collect();
                GC.WaitForPendingFinalizers();
                GC.Collect();
                GC.WaitForPendingFinalizers();
            }
        }

        private void ProcessSingleFileWithExcelInterop(Excel.Application excelApp, string path)
        {
            Excel.Workbook wb = null;
            object linksObj = null;

            // Parameters for Workbooks.Open:
            // Filename, UpdateLinks, ReadOnly, Format, Password, WriteResPassword, IgnoreReadOnlyRecommended, Origin, Delimiter, Editable, Notify, Converter, AddToMru, Local, CorruptLoad
            // We'll set UpdateLinks = 0 (don't update)
            object missing = Type.Missing;
            try
            {
                wb = excelApp.Workbooks.Open(path, 0, false, Type.Missing, Type.Missing, Type.Missing,
                                            Type.Missing, Type.Missing, Type.Missing, false, false, Type.Missing, true, Type.Missing, Type.Missing);

                // First try LinkSources to get external workbook links
                try
                {
                    linksObj = wb.LinkSources(Excel.XlLink.xlExcelLinks);
                }
                catch (Exception)
                {
                    linksObj = null;
                }

                if (linksObj != null)
                {
                    // linksObj is an object[] or single string
                    var links = ConvertLinkSourcesToList(linksObj);
                    Log($"Found {links.Count} external links.");
                    foreach (var link in links)
                    {
                        try
                        {
                            wb.BreakLink(link, Excel.XlLinkType.xlLinkTypeExcelLinks);
                            Log($" BreakLink succeeded for: {link}");
                        }
                        catch (Exception ex)
                        {
                            Log($" BreakLink failed for: {link}, err: {ex.Message}");
                        }
                    }
                }
                else
                {
                    Log("No LinkSources detected.");
                }

                // Additionally try to remove external references in defined names (Name refers to external workbook)
                RemoveExternalDefinedNames(wb);

                // Save and close
                wb.Save();
            }
            finally
            {
                if (wb != null)
                {
                    try
                    {
                        wb.Close(false);
                    }
                    catch { }
                    finally
                    {
                        Marshal.FinalReleaseComObject(wb);
                        wb = null;
                    }
                }
            }
        }

        private List<string> ConvertLinkSourcesToList(object linksObj)
        {
            var result = new List<string>();
            if (linksObj is object[] arr)
            {
                foreach (var o in arr)
                {
                    if (o != null) result.Add(o.ToString());
                }
            }
            else if (linksObj != null)
            {
                result.Add(linksObj.ToString());
            }
            return result;
        }

        private void RemoveExternalDefinedNames(Excel.Workbook wb)
        {
            try
            {
                var names = wb.Names;
                var toDelete = new List<Excel.Name>();
                foreach (Excel.Name n in names)
                {
                    try
                    {
                        string refersTo = n.RefersTo ?? string.Empty;
                        if (refersTo.Contains("[") || refersTo.Contains("]")) // crude check for external workbook ref
                        {
                            Log($"Removing name '{n.Name}' which refers to external: {refersTo}");
                            // delete the name
                            n.Delete();
                        }
                    }
                    catch (Exception ex)
                    {
                        Log($"Error checking/deleting name: {ex.Message}");
                    }
                    finally
                    {
                        // release n explicitly
                        try { Marshal.FinalReleaseComObject(n); } catch { }
                    }
                }
                // release names collection
                try { Marshal.FinalReleaseComObject(names); } catch { }
            }
            catch (Exception ex)
            {
                Log($"Error while removing defined names: {ex.Message}");
            }
        }
    }
}





using System;
using System.Windows.Forms;

namespace BatchBreakLinks
{
    static class Program
    {
        [STAThread] // Excel COM Ë¶ÅÊ±Ç STA
        static void Main()
        {
            Application.SetHighDpiMode(HighDpiMode.SystemAware);
            Application.EnableVisualStyles();
            Application.SetCompatibleTextRenderingDefault(false);
            Application.Run(new MainForm());
        }
    }
}





<Project Sdk="Microsoft.NET.Sdk.WindowsDesktop">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net6.0-windows</TargetFramework>
    <UseWindowsForms>true</UseWindowsForms>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Office.Interop.Excel" Version="15.0.4797.1000" />
  </ItemGroup>
</Project>